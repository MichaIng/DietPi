#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	#/////////////////////////////////////////////////////////////////////////////////////
	#Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 102 )); then
		#-------------------------------------------------------------------------------
		#DNS fixes for STATIC. We MUST supply DNS servers if using STATIC, else /etc/resolv.conf will be empty.
		# - Update curret network details
		/DietPi/dietpi/func/obtain_network_details
		# - Add missing disabled dns-nameservers to wlan.
		sed -i "/wpa-psk /a #dns-nameservers 8.8.8.8 8.8.4.4" /etc/network/interfaces
		# - If static IP is currently in use, enable google dns-nameservers.
		active_network_adapter=$(sed -n 3p /DietPi/dietpi/.network)
		if (( $( cat /etc/network/interfaces | grep -ci -m1 "iface $active_network_adapter inet static") == 1 )); then
			sed -i 's/^#dns-nameservers/dns-nameservers/g' /etc/network/interfaces
		fi
		# - Delete 'Uncomment for Google DNS servers reference'
		sed -i '/Uncomment for Google/d' /etc/network/interfaces
		# - Add DNS entry to dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'Static_DNS=') == 0 )); then
			sed -i "/Static_Gateway=/a Static_DNS=8.8.8.8" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Missing Resolvconf
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install resolvconf -y
		#-------------------------------------------------------------------------------
		#New Bash Alias's
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-autostart=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-autostart='/DietPi/dietpi/dietpi-autostart'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-affinity=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-affinity='/DietPi/dietpi/dietpi-affinity'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-letsencrypt=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-letsencrypt='/DietPi/dietpi/dietpi-letsencrypt'" /etc/bash.bashrc
		fi
		# - DietPi-Cloudshell input cli changes
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cloudshell=') == 1 )); then
			sed -i '/alias dietpi-cloudshell=/d' /etc/bash.bashrc &> /dev/null
			sed -i "/#DietPi Additions/a alias dietpi-cloudshell='/DietPi/dietpi/dietpi-cloudshell'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#NTPD drift file ownership must match user that NTPD runs as, or it wont write to drift file (even though its ran as root.......)
		chown root:root /var/lib/ntp/ntp.drift
		#-------------------------------------------------------------------------------
		#Information change for crontab (DietPi-Cron instead of dietpi-config)
		sed -i '/#Please use dietpi-config/c\#Please use DietPi-Cron to change cron start times' /etc/crontab &> /dev/null
		#-------------------------------------------------------------------------------
		#Proftpd patch | to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change
		if [ -f /etc/proftpd/proftpd.conf ]; then
			if (( $(cat /etc/proftpd/proftpd.conf | grep -ci -m1 'WtmpLog') == 0 )); then
				sed -i "/SystemLog /a #to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change\nWtmpLog off" /etc/proftpd/proftpd.conf
			fi
		fi
		#-------------------------------------------------------------------------------


	elif (( $VERSION_CURRENT == 103 )); then
		#-------------------------------------------------------------------------------
		# New automation/misc options > dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^AUTO_AutoLogin=') == 0 )); then
			sed -i "/# >> Automation Options/a #Automatically logs the root user in to start 1st run setup.\nAUTO_AutoLogin=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Hostname=') == 0 )); then
			sed -i "/# >> Automation Options/a Hostname=DietPi" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Swapfile_Size=') == 0 )); then
			sed -i "/# >> Automation Options/a Swapfile_Size=100" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#FP name change for autoboot (now DietPi-Autostart)
		mv /DietPi/dietpi/.auto_boot_index /DietPi/dietpi/.dietpi-autostart_index
		#-------------------------------------------------------------------------------
		#DietPi-Cloudshell - 'c / 'f option / Target output
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '4s/.*/1/' /DietPi/dietpi/.dietpi-cloudshell
			sed -i '5s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell
		fi
		#-------------------------------------------------------------------------------
		#dphys-swapfile - add location to conf
		if (( $(cat /etc/dphys-swapfile | grep -ci -m1 '^CONF_SWAPFILE=') == 0 )); then
			echo -e "CONF_SWAPFILE=/var/swap" >> /etc/dphys-swapfile
		fi
		#-------------------------------------------------------------------------------
		#PiHole Update
		if [ -f /usr/local/bin/gravity.sh ]; then
			#remove old lists (we need to regenerate)
			rm /etc/pihole/list.*
			rm /etc/pihole/pihole.*
			rm /etc/pihole/gravity.list

			cp /DietPi/dietpi/conf/pihole_gravity /usr/local/bin/gravity.sh
			chmod +x /usr/local/bin/gravity.sh
			/usr/local/bin/gravity.sh
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 104 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WIFIHOTSPOT=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WIFIHOTSPOT=0" /DietPi/dietpi.txt
		fi

		#-------------------------------------------------------------------------------
		#dietpi-cleaner alias missing from bashrc
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cleaner=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-cleaner='/DietPi/dietpi/dietpi-cleaner'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#Updated hw_model script - Generate unique system ID
		rm /DietPi/dietpi/.hw_model &> /dev/null
		/DietPi/dietpi/dietpi-obtain_hw_model
		#-------------------------------------------------------------------------------
		#Wifi Hotspot settings
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_ssid=') == 0 )); then
			sed -i "/ntpd_update_mode=/a\ \n#Wifi Hotspot\nwifi_hotspot_ssid=DietPi-HotSpot\n# - minimum of 8 characters\nwifi_hotspot_key=dietpihotspot\nwifi_hotspot_channel=3" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 105 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_SHAIRPORTSYNC=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_SHAIRPORTSYNC=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#dbus-x11 now installed by default with xserver installations. Required for ibus, fcitx etc. inputs.
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG 2') == 1 )); then
				/DietPi/dietpi/dietpi-apt-get_update 1
				apt-get install dbus-x11 -y
			fi
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 106 )); then
		#-------------------------------------------------------------------------------
		# DietPi-Process Tool
		# -  bash alias add dietpi-process_control
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-process_tool=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-process_tool='/DietPi/dietpi/dietpi-process_tool'" /etc/bash.bashrc
		fi
		# - bash alias, remove nice/affinity
		sed -i '/dietpi-nice/d' /etc/bash.bashrc
		sed -i '/dietpi-affinity/d' /etc/bash.bashrc
		#remove .dietpi-nice .dietpi-affinity settings
		rm /DietPi/dietpi/.dietpi-nice
		rm /DietPi/dietpi/.dietpi-affinity
		#-------------------------------------------------------------------------------
		#Prompt user regarding nice/affinity changes
		if [ -f /DietPi/dietpi/.installed ]; then
			whiptail --title "Info: DietPi-Process_Tool" --msgbox "DietPi-Affinity and DietPi-Nice has now been replaced by DietPi-Process_Tool.\n\nIf you have used these programs in the past, you will need to reapply your nice and affinity settings by running the following command, after you reboot the system.\n\ndietpi-process_tool" 14 70
		fi
		#-------------------------------------------------------------------------------
		#Enable IPv6 for all DietPi images by default
		rm /etc/modprobe.d/blacklist-ipv6.conf &> /dev/null
		sed -i "/net.ipv6.conf.all.disable_ipv6 /c\net.ipv6.conf.all.disable_ipv6 = 0" /etc/sysctl.conf
		sed -i "/net.ipv6.conf.default.disable_ipv6 /c\net.ipv6.conf.default.disable_ipv6 = 0" /etc/sysctl.conf
		sed -i "/net.ipv6.conf.lo.disable_ipv6 /c\net.ipv6.conf.lo.disable_ipv6 = 0" /etc/sysctl.conf
		#Update /etc/hosts with ipv6
		if (( $(cat /etc/hosts | grep -ci -m1 'ip6-localhost') == 0 )); then
			cat << _EOF_ >> /etc/hosts
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_BRUTEFIR=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_BRUTEFIR=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 107 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_PYDIO=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_PYDIO=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_SQUEEZELITE=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_SQUEEZELITE=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#DESKTOP_LXDE dietpi-nice > dietpi-process_tool
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE 2') == 1 )); then
				rm /usr/share/applications/dietpi-nice.desktop
				ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
			fi
		fi
		#-------------------------------------------------------------------------------
	elif (( $VERSION_CURRENT == 108 )); then
		#-------------------------------------------------------------------------------
		#Pydrio: Impossible write into the AJXP_DATA_PATH folder https://github.com/Fourdee/DietPi/issues/186
		chown -R www-data:www-data /pydio_data &> /dev/null
		chown -R www-data:www-data /mnt/usb_1/pydio_data &> /dev/null
		#-------------------------------------------------------------------------------
		#PiHole webstats patch https://github.com/Fourdee/DietPi/issues/187#issue-131328814
		if [ -f /usr/local/bin/gravity.sh ]; then
			wget https://raw.githubusercontent.com/pi-hole/pi-hole/master/advanced/Scripts/chronometer.sh -O /usr/local/bin/chronometer.sh
			chmod +x /usr/local/bin/chronometer.sh

			/DietPi/dietpi/dietpi-apt-get_update 1
			apt-get install -y bc
		fi
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - Lighttpd
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLMP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLMP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLSP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLSP=0" /DietPi/dietpi.txt
		fi

		# - MariaDB
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LAAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LAAP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LEAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LEAP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLAP=0" /DietPi/dietpi.txt
		fi

		#-------------------------------------------------------------------------------
		#Disable powersaving for 8188eu wifi chipsets
		echo -e "options 8188eu rtw_power_mgnt=0" > /etc/modprobe.d/8188eu.conf
		#-------------------------------------------------------------------------------
		#debconf-get-selections mising from odroid's
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install -y debconf-utils
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 109 )); then
		#-------------------------------------------------------------------------------
		#Put XU4 kernel updates on hold to prevent automated installations causing broken kernel/modules.
		#https://github.com/Fourdee/DietPi/issues/185#issuecomment-183343474
		if (( $HW_MODEL == 11 )); then
			apt-mark hold linux-headers-armhf-odroid-xu3 linux-image-armhf-odroid-xu3
		fi
		#-------------------------------------------------------------------------------
		#LXDE desktop, remove dietpi-nice.desktop links, add dietpi-process_tool
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE 2') == 1 )); then
				rm /usr/share/applications/dietpi-nice.desktop
				ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
			fi
		fi
		#-------------------------------------------------------------------------------
		#DietPi.txt | new option to override user/personal data target directory in DietPi-Software: https://github.com/Fourdee/DietPi/issues/198
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_userdata_basedirectory=') == 0 )); then
			sed -i "/wifi_hotspot_channel=/a #------------------------------------------------------------------------------------------------------\n# D I E T - P I\n# DietPi-Software settings.\n#------------------------------------------------------------------------------------------------------\n#Override target directory for user/personal data.\n#This is applied to software configurations when installing software (eg: owncloud, bittorrent downloads etc).\n#  Auto = Automatic (default). If USB dedicated drive was setup /mnt/usb_1, else, /root\n#  /mnt/Where/I/Want/My/Data = Example\n#  /mnt/user_data = Example\ndietpi_userdata_basedirectory=Auto\n" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Updated network details script , rerun
		/DietPi/dietpi/func/obtain_network_details
		#-------------------------------------------------------------------------------
		#BC is now installed by default on all DietPi systems. bc is needed for bash floating point calculations that many scripts rely on.
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install -y bc
		#-------------------------------------------------------------------------------
		#Cloudshell new option | NETWORK_USAGE_CURRENT_OUTPUT_TYPE
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '6s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 110 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		# - Oracle Java 8 jdk
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_ORACLEJAVA=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_FFMPEG=/a AUTO_DietpiSoftware_Install_ORACLEJAVA=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#RPI Jessie:
		# - remove /etc/apt/sources.list.d/collabora.list. This was left over from Wheezy dist-upgrade and is not required.
		# - Update /etc/apt/sources.list.d/raspi.list to match Raspbian Jessie raspi.list.
		if (( $HW_MODEL < 10 )) && (( $DISTRO == 3 )); then
			rm /etc/apt/sources.list.d/collabora.list
			cat << _EOF_ > /etc/apt/sources.list.d/raspi.list
deb http://archive.raspberrypi.org/debian/ jessie main ui
# Uncomment line below then 'apt-get update' to enable 'apt-get source'
#deb-src http://archive.raspberrypi.org/debian/ jessie main ui
_EOF_
			/DietPi/dietpi/dietpi-apt-get_update 2
		fi
		#-------------------------------------------------------------------------------
		#RPI - snd-bcm2835 is now disabled by default.
		if (( $HW_MODEL < 10 )) && (( $(dpkg -l | grep -ci -m1 'alsa') == 0 )); then
			/DietPi/dietpi/func/dietpi-set_hardware soundcard none
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 111 )); then
		#-------------------------------------------------------------------------------
		#RPi 3 - WiFi hotspot. Internal Wifi fix.
		# - Disable driver definition
		# - Use non-modified hostapd binary from Jessie repo.
		if (( $HW_MODEL == 3 )) && (( $(dpkg -l | grep -ci -m1 'hostapd') == 1 )); then
			apt-get remove hostapd -y
			apt-get install hostapd -y
			sed -i '/driver=/c\#driver=rtl871xdrv/' /etc/hostapd/hostapd.conf
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 112 )); then
		#-------------------------------------------------------------------------------
		#/DietPi/dietpi/dietpi-apt-get_update 1 is now called in dietpi-update, before this patch file is launched.
		# - Run it now for previous DietPi versions. As dietpi-update is loaded into memory, it wont be updated until a reboot.
		/DietPi/dietpi/dietpi-apt-get_update 1
		#-------------------------------------------------------------------------------
		#New location for dietpi-software installed "non-service" based control scripts
		mkdir -p /etc/dietpi/dietpi-software/services

		# - move to new location, if installed
		mv /etc/deluge_init /etc/dietpi/dietpi-software/services/deluge.service &> /dev/null
		mv /etc/raspimjpeg_init /etc/dietpi/dietpi-software/services/raspimjpeg.service &> /dev/null
		mv /etc/squeezeboxserver_init /etc/dietpi/dietpi-software/services/squeezeboxserver.service &> /dev/null
		mv /etc/BruteFIR/brutefir.service /etc/dietpi/dietpi-software/services/brutefir.service &> /dev/null
		chmod -R +x /etc/dietpi/dietpi-software/services
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_REDIS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_REDIS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_EMONHUB=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_EMONHUB=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_EMONCMS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_EMONCMS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_NODEJS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_BUILDESSENTIAL=/a AUTO_DietpiSoftware_Install_NODEJS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_RPIMONITOR=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_RPIMONITOR=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_BAIKAL=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_BAIKAL=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#PiHole webstats update
		if [ -f /var/www/pihole/index.php ]; then
			cd ~/
			rm -R /var/www/pihole/*
			wget https://github.com/Fourdee/AdminLTE/archive/master.zip -O package.zip
			unzip package.zip
			rm package.zip
			mv AdminLTE*/* /var/www/pihole/
			rm -R AdminLTE*
		fi
		#-------------------------------------------------------------------------------
		#RPi Jessie DietPi v111 image missing ipv6 in hosts. Add if it doesnt exist
		if (( $(cat /etc/hosts | grep -ci -m1 'ip6-localhost') == 0 )); then
			cat << _EOF_ >> /etc/hosts
::1				localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#Odroid C2 - Kodi sound fix
		if (( $HW_MODEL == 12 )); then
			if (( $(dpkg -l | grep -ci -m1 'kodi-odroid') == 1 )); then

				# - upgrade kodi
				apt-get update
				apt-get upgrade -y

				# - Remove pulse audio workaround fix we used.
				apt-get purge pulseaudio -y
				apt-get autoremove --purge -y

				# - Asound.conf by Oversun.
				cat << _EOF_ > /etc/asound.conf
pcm.!default {
	type plug
	slave {
		pcm "hw:0,0"
		format S32_LE
	}
}
_EOF_
			fi
		fi
		#-------------------------------------------------------------------------------
		#fbset now installed by default
		apt-get install -y fbset
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 113 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software Additions
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_TORHOTSPOT=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WIFIHOTSPOT=/a AUTO_DietpiSoftware_Install_TORHOTSPOT=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		# New dietpi-software options > dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^dietpi_emonhub_apikey=') == 0 )); then
			sed -i "/dietpi_userdata_basedirectory=/a #Enter your EmonCMS.org write API key here. It will be applied automatically during EmonPi/Hub installation.\n# - eg: dietpi_emonhub_apikey=b4dfmk2o203mmxx93a\ndietpi_emonhub_apikey=" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#C1 - Ondemand does not work, replace with interactive: https://github.com/Fourdee/DietPi/issues/248
		if (( $HW_MODEL == 10 )) && (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^cpu_governor=ondemand') == 1 )); then
			sed -i "/cpu_governor=/c\cpu_governor=interactive" /DietPi/dietpi.txt
			/DietPi/dietpi/dietpi-cpu_set
		fi
		#-------------------------------------------------------------------------------
		#RPi | Enable max usb current by default
		sed -i '/max_usb_current=/c\max_usb_current=1' /DietPi/config.txt
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 114 )); then
		#-------------------------------------------------------------------------------
		#OPi PC -  Comminuty Fix vcore/freq: https://github.com/Fourdee/DietPi/issues/263
		if (( $HW_MODEL == 30 )); then

			# - Warn user of OPi-PC only support after this is run.
			whiptail --title "OPi-PC vcore/stability fix" --yesno "This will apply the community vcore/stability fix on your system. The fix resolves known issues with the H3 clockspeeds and vcore voltages. Whilst this patch has been tested on OPi-PC systems, there is no guarantee the fix will work, and, could render your system unbootable.\n\nNB: If you NOT using an OPi-PC, say no.\n\nDo you wish to apply the community H3 patch?" --backtitle "DietPi-Update" --defaultno 16 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then
				wget http://dietpi.com/downloads/misc/community/h3_fix_vcore_clock.sh -O patch
				chmod +x patch
				./patch
				rm patch
			fi

		fi
		#-------------------------------------------------------------------------------
		#Webserver preference system
		# - update .installed file with new options.
		if [ -f /DietPi/dietpi/.installed ]; then

			index=-2 #lighttpd

			if (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'apache2') )); then
				index=0
			elif (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'nginx') )); then
				index=-1
			fi

			cat << _EOF_ >> /DietPi/dietpi/.installed
#DietPi Preference System: Webserver base
INDEX_WEBSERVER_CURRENT $index
INDEX_WEBSERVER_TARGET $index
_EOF_

		fi

		# - Add automation support for Webserver preference to dietpi.txt.
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_WebserverIndex=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_LoggingIndex=/a #Webserver Preference Selection:\n# NB: This will get ignored, if you have manually selected any WEBSERVER_Stacks.\n#    0=Apache2\n#    -1=Nginx\n#    -2=Lighttpd\nAUTO_DietpiSoftware_WebserverIndex=-2" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		# Possible missing dietpi.txt global vars for < v109 images. Add them if required.
		# - To prevent this from occuring again:
		#	For AUTO_ entries, use sed to insert at specific line
		#	For global VARs, just echo the value to the end of dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_ssid=') == 0 )); then
			echo -e "wifi_hotspot_ssid=DietPi-HotSpot" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_key=') == 0 )); then
			echo -e "wifi_hotspot_key=dietpihotspot" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_channel=') == 0 )); then
			echo -e "wifi_hotspot_channel=3" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_userdata_basedirectory=') == 0 )); then
			echo -e "dietpi_userdata_basedirectory=Auto" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_emonhub_apikey=') == 0 )); then
			echo -e "dietpi_emonhub_apikey=" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 115 )); then
		#-------------------------------------------------------------------------------
		# Add netdata to existing dietpi.txt automation file
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_NETDATA=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_LINUXDASH=/a AUTO_DietpiSoftware_Install_NETDATA=0" /DietPi/dietpi.txt
		fi

		# + DietPi.txt Proxy settings
		# NB: Always add extra line to cat feed: https://github.com/Fourdee/DietPi/issues/301#issue-151214787
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^proxy_address=') == 0 )); then
			cat << _EOF_ >> /DietPi/dietpi.txt

#Proxy settings | System-wide proxy settings. Use dietpi-config > networking options to apply.
proxy_enabled=0
proxy_address=MyProxyServer.com
proxy_port=8080
proxy_username=
proxy_password=
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#Odroid C1 WiFi fix (missing packages): https://github.com/Fourdee/DietPi/issues/273#issuecomment-210410651
		if (( $HW_MODEL == 10 )); then
			apt-get install -y wireless-regdb iw crda wpasupplicant
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 116 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_MUMBLESERVER=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_EMONHUB=/a AUTO_DietpiSoftware_Install_MUMBLESERVER=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#update .installed file to new format
		if [[ -f /DietPi/dietpi/.installed ]]; then
			sed -i -re 's/(^[^#]\S*) (.*)/\1=\2/' /DietPi/dietpi/.installed
		fi

		#update cron jobs to use new .installed format
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		cp /DietPi/dietpi/conf/cron.hourly_dietpi /etc/cron.hourly/dietpi
		chmod +x /etc/cron.hourly/dietpi
		#-------------------------------------------------------------------------------
		#ifmetric: https://github.com/Fourdee/DietPi/issues/273#issuecomment-213951519
		apt-get install -y ifmetric
		if (( $(cat /etc/network/interfaces | grep -ci -m1 '^metric ') == 0 )); then
			# - eth
			sed -i "/iface eth$(sed -n 1p /DietPi/dietpi/.network)/a metric 0" /etc/network/interfaces
			# - wlan
			sed -i "/iface wlan$(sed -n 2p /DietPi/dietpi/.network)/a metric 1" /etc/network/interfaces
		fi
		#-------------------------------------------------------------------------------
		#netplug. Resolves issues with unplugging eth and breaking all connections, when WiFi is also active: https://github.com/Fourdee/DietPi/issues/273#issuecomment-215996025
		apt-get install netplug -y
		cat << _EOF_ > /etc/netplug/netplugd.conf
eth*
wlan*
_EOF_
		#-------------------------------------------------------------------------------
		#Roll out allow-hotplug as default: https://github.com/Fourdee/DietPi/issues/305
		# - Active
		#	eth
		sed -i "/^auto eth$(sed -n 1p /DietPi/dietpi/.network)/c\allow-hotplug eth$(sed -n 1p /DietPi/dietpi/.network)" /etc/network/interfaces
		#	wlan
		sed -i "/^auto wlan$(sed -n 2p /DietPi/dietpi/.network)/c\allow-hotplug wlan$(sed -n 2p /DietPi/dietpi/.network)" /etc/network/interfaces
		# - inactive
		#	eth
		sed -i "/^#auto eth$(sed -n 1p /DietPi/dietpi/.network)/c\#allow-hotplug eth$(sed -n 1p /DietPi/dietpi/.network)" /etc/network/interfaces
		#	wlan
		sed -i "/^#auto wlan$(sed -n 2p /DietPi/dietpi/.network)/c\#allow-hotplug wlan$(sed -n 2p /DietPi/dietpi/.network)" /etc/network/interfaces
		#-------------------------------------------------------------------------------
		#apply to all DietPi systems (but targeted at Odroid XU4) - missing WiFi packages.
		apt-get install -y wireless-regdb iw crda wpasupplicant
		#-------------------------------------------------------------------------------
		#Missing line at EOF
		echo -e "" >> /etc/network/interfaces
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 117 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		# NB: We no longer need to do this.
		#		Users can download and copy the latest dietpi.txt file to SD, prior to boot, which will contain all current automation options.
		#		Theres no need for us to add them in during patching to their dietpi.txt.
		#-------------------------------------------------------------------------------
		#WiFi country code
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_country_code=') == 0 )); then
			echo -e "\n#WiFi country code. 2 character value (eg GB US DE JP): https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2\nwifi_country_code=" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Remove _ from installed file: https://github.com/Fourdee/DietPi/issues/322
		if [ -f /DietPi/dietpi/.installed ]; then
			sed -i '/^_$/d' /DietPi/dietpi/.installed
		fi
		#-------------------------------------------------------------------------------
		#Subsonic now has two installation versions, v5 being the previous installation option.: https://github.com/Fourdee/DietPi/issues/330
		if [ -f /DietPi/dietpi/.installed ]; then
			sed -i 's/^SUBSONIC=/SUBSONIC5=/' /DietPi/dietpi/.installed
		fi
		#-------------------------------------------------------------------------------
		#Patch PineA64 to include xz-utils for firmware upgrades (only needed w/ alpha v118 image
		if (( $HW_MODEL >= 40 && $HW_MODEL < 50 )); then
			apt-get update
			apt-get install -y --no-install-recommends xz-utils

			/usr/local/sbin/pine64_update_uboot.sh
			/usr/local/sbin/pine64_update_kernel.sh
			/usr/local/sbin/pine64_fix_whatever.sh
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 118 )); then
		#-------------------------------------------------------------------------------
		#Transmission, service starts before network via SystemD, instead of "dietpi-services start": https://github.com/Fourdee/DietPi/issues/350
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $DISTRO == 3 )) &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^TRANSMISSION=2' ) )); then

			rm /etc/init.d/transmission-daemon
			rm /etc/systemd/system/transmission-daemon.service
			cat << _EOF_ > /etc/systemd/system/transmission-daemon.service
[Unit]
Description=Barebones transmission-daemon service
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/transmission-daemon --config-dir /var/lib/transmission-daemon/info
ExecStop=/usr/bin/killall -w transmission-daemon
StandardOutput=tty

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl enable transmission-daemon.service
			systemctl daemon-reload
			/DietPi/dietpi/dietpi-services disable

		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt global vnc settings
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^dietpi_vncserver_height=') )); then
			echo -e "\n#VNC Server Options\ndietpi_vncserver_width=1280\ndietpi_vncserver_height=720\ndietpi_vncserver_depth=16\ndietpi_vncserver_display=0" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#VNC servers, now start automatically during boot via service.
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^TIGHTVNCSERVER=2' ) )); then

			#Wheezy
			if (( $DISTRO == 1 )); then

				cat << _EOF_ > /etc/init.d/vncserver
#!/bin/bash -e
### BEGIN INIT INFO
# Provides:          VNC server
# Required-Start:    \$all
# Should-Start:
# Required-Stop:	 \$local_fs \$network
# Should-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       DietPi VNC server control
### END INIT INFO

#Wheezy, to prevent "vncserver: The HOME/USER environment variable is not set"
export USER=root
export HOME='/root'

start(){

	/usr/local/bin/vncserver start

}

stop(){

	/usr/local/bin/vncserver stop

}

case "\$1" in
	start)
		start
	;;
	stop)
		stop
	;;
	restart)
		stop
		start
	;;
	*)
		echo "Usage: \$0 {start|stop|restart}"
	;;
esac
_EOF_

				chmod +x /etc/init.d/vncserver
				update-rc.d vncserver defaults 00 80


			#Jessie
			elif (( $DISTRO == 3 )); then

				cat << _EOF_ > /etc/systemd/system/vncserver.service
[Unit]
Description=Manage VNC Server
After=dietpi-service.service
After=rc.local.service

[Service]
Type=idle
RemainAfterExit=yes
ExecStart=/bin/bash /usr/local/bin/vncserver start
ExecStop=/bin/bash /usr/local/bin/vncserver stop
User=root

[Install]
WantedBy=multi-user.target
_EOF_

				systemctl enable vncserver.service
				systemctl daemon-reload

			fi

			# - Both
			cat << _EOF_ > /usr/local/bin/vncserver
#!/bin/bash

#Globals
VNC_INSTALLED=0
BINARY_FP=0

WIDTH=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_width=' | sed 's/.*=//')
HEIGHT=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_height=' | sed 's/.*=//')
DEPTH=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_depth=' | sed 's/.*=//')
DISPLAY=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_display=' | sed 's/.*=//')

#TightVNC or VNC4server?
if [ -f /usr/bin/vnc4server ]; then
    BINARY_FP='/usr/bin/vnc4server'
    VNC_INSTALLED=1
elif  [ -f /usr/bin/vncserver ]; then
    BINARY_FP='/usr/bin/vncserver'
    VNC_INSTALLED=1
fi

#Exit if no VNC binary found
if (( ! \$VNC_INSTALLED )); then
    exit 1
fi

case "\$1" in
    start)
        \$BINARY_FP :\$DISPLAY -geometry \$WIDTH'x'\$HEIGHT -depth \$DEPTH
        ;;

    stop)
        \$BINARY_FP -kill :\$DISPLAY
        ;;

esac

exit 0
_EOF_
			chmod +x /usr/local/bin/vncserver

		fi
		#-------------------------------------------------------------------------------
		#Removal of VNC server from DietPi-Autostart. Reset to console, manual login.
		if (( $(cat /DietPi/dietpi/.dietpi-autostart_index) == 6 )); then
			echo 0 > /DietPi/dietpi/.dietpi-autostart_index
		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt | Serial console global var
		# - Set this to 0 disabled (the previous default for all DietPi images). Future images will have this enabled by default.
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'serial_console_enabled=') == 0 )); then
			echo -e "\n#Serial Console: If you dont know what this is, you can safely disable it (=0) to reduce system resource usage.\nserial_console_enabled=0" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#dietpi.txt | Soundcard global var
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'soundcard=') == 0 )); then
			echo -e "\n#Soundcard\nsoundcard=none" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Odroid C2 boot.ini changes: https://github.com/Fourdee/DietPi/issues/366#issue-157399983
		#	I dont want to risk patching these additional options in, so lets overwrite the users boot.ini with the new one.
		if (( $HW_MODEL == 12 )); then

			DEBIAN_FRONTEND='noninteractive' apt-get upgrade -y linux-headers-arm64-odroid-c2 linux-image-arm64-odroid-c2

			whiptail --title "Kernel Upgrade" --msgbox "If the next screen shows a Yes/No prompt. Select No." 8 60
			DEBIAN_FRONTEND='noninteractive' apt-get autoremove --purge -y

			# - Because removing 3.14.29 also removes 3.14.65 (most likley same locations) we need to reinstall 3.14.65+
			DEBIAN_FRONTEND='noninteractive' apt-get install -y --reinstall linux-headers-3.14.65+ linux-image-3.14.65+

			wget https://raw.githubusercontent.com/Fourdee/DietPi/e8e0edf7193c61d6084bf252397561081e335dc5/boot_c2.ini -O /DietPi/boot.ini

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 119 )); then
		#-------------------------------------------------------------------------------
		#RPi 3 75 thermal limit: https://github.com/Fourdee/DietPi/issues/356#issuecomment-223282185
		if (( $HW_MODEL == 3 )); then

			sed -i '/temp_limit=/c\temp_limit=75' /DietPi/config.txt

		fi
		#-------------------------------------------------------------------------------
		#Disable internal WiFi and BT by default on new installs
		if [ ! -f /DietPi/dietpi/.installed ]; then

			# - changed from RPi3 only script to all devices, remove old references
			rm /etc/modprobe.d/disable_rpi3_bt.conf &> /dev/null
			rm /etc/modprobe.d/disable_rpi3_wifi.conf &> /dev/null

			/DietPi/dietpi/func/dietpi-set_hardware bluetooth disable

			#enable WiFi for automation
			if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'Wifi_Enabled=1') )); then
				/DietPi/dietpi/func/dietpi-set_hardware wifi enable
			else
				/DietPi/dietpi/func/dietpi-set_hardware wifi disable
			fi

		fi
		#-------------------------------------------------------------------------------
		#Pine A64 image, disable systemd-timesyncd as we use ntp/d. New installs only.
		if (( $HW_MODEL >= 40 && $HW_MODEL < 50 )) && [ ! -f /DietPi/dietpi/.installed ]; then
			systemctl disable systemd-timesyncd
			systemctl mask systemd-timesyncd
		fi
		#-------------------------------------------------------------------------------
		#Netplug is now installed on demand in dietpi-config, when both adapters are enabled.
		apt-get purge netplug -y
		#-------------------------------------------------------------------------------
		#DietPi-Cloudshell - New poweroff screen at specific time
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '7s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell #Enabled?
			sed -i '8s/.*/22/' /DietPi/dietpi/.dietpi-cloudshell #Start time (hour)
			sed -i '9s/.*/8/' /DietPi/dietpi/.dietpi-cloudshell #End time (hour)
		fi
		#-------------------------------------------------------------------------------
		#Pine A64, now using fbturbo driver: https://github.com/Fourdee/DietPi/issues/380
		if (( $HW_MODEL >= 40 && $HW_MODEL < 50 )) &&
			[ -f /DietPi/dietpi/.installed ] &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^XSERVERXORG=2' ) )); then

			wget http://dietpi.com/downloads/binaries/all/libump_1-1_arm64.deb -O package.deb
			dpkg -i package.deb
			rm package.deb

			wget http://dietpi.com/downloads/binaries/all/xf86-video-fbturbo_1-1_arm64.deb -O package.deb
			dpkg -i package.deb
			rm package.deb

		fi
		#-------------------------------------------------------------------------------
		#Always ensure dietpi_userdata directory exists
		mkdir -p /mnt/dietpi_userdata &> /dev/null

		#Setup dietpi_userdata symlink for existing installs, if not on flash drive
		if [ -f /DietPi/dietpi/.installed ]; then

			DIETPI_USERDATA_BASEDIRECTORY=$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_userdata_basedirectory=' | sed 's/.*=//' | tr '[:upper:]' '[:lower:]')

			if [ -n "$DIETPI_USERDATA_BASEDIRECTORY" ]; then

				#Auto
				if [ "$DIETPI_USERDATA_BASEDIRECTORY" = "auto" ]; then

					#USBDRIVE
					if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'USBDRIVE=2') && $(df | grep -ci -m1 '/mnt/usb_1') )); then
						/DietPi/dietpi/func/dietpi-set_userdata /mnt/dietpi_userdata /mnt/usb_1
					fi

				#CUSTOM
				else
					/DietPi/dietpi/func/dietpi-set_userdata /mnt/dietpi_userdata "$DIETPI_USERDATA_BASEDIRECTORY"
				fi

				# - dietpi-set_userdata restarts services, so stop them.
				/DietPi/dietpi/dietpi-services stop

			else

				read -p "Error: Unable to setup DietPi Userdata directories. dietpi_userdata_basedirectory= is missing or invalid value in dietpi.txt. It is highly recommended you backup any personal data on this system, then reinstall DietPi using the latest image available from http://dietpi.com/download. Press any key to continue..."

			fi

		fi
		#-------------------------------------------------------------------------------
		#xz-utils missing from some images, required for decompress tar.xz support.
		apt-get install -y xz-utils
		#-------------------------------------------------------------------------------
		#I left the serial console enabled for all the v120 images (my bad). Disable if not enabled in dietpi.txt
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^serial_console_enabled=1') )); then
			/DietPi/dietpi/func/dietpi-set_hardware serialconsole disable
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 120 )); then
		#-------------------------------------------------------------------------------
		#Update cron daily (Added daily filesystem TRIM for capable devices, eg: flash)
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		#-------------------------------------------------------------------------------
		#Xterm now installed by default with xserverxorg: https://github.com/Fourdee/DietPi/issues/388
		if [ -f /DietPi/dietpi/.installed ]; then

			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG=2') )); then
				apt-get install xterm -y
			fi

			# Mate: https://github.com/Fourdee/DietPi/issues/388
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_MATE=2') )); then

				# - Set execute to prevent "untrusted" prompt in Mate, and possibily other desktops.
				chmod +x /usr/share/applications/*

				# - remove pcmanfm link
				rm "$HOME"/Desktop/pcmanfm.desktop

			fi

		fi
		#-------------------------------------------------------------------------------
		#C2 X11 GPU/VPU patches: https://github.com/Fourdee/DietPi/issues/399
		# - boot.ini
		if (( $HW_MODEL == 12 )); then

			if [ -f /DietPi/dietpi/.installed ]; then

				whiptail --title "boot.ini updated" --msgbox "/DietPi/boot.ini has been overwritten and updated with the latest C2 options. Values such as display resolution and serial console have been reset.\nPlease check the file and adjust as needed." 10 70

			fi

			wget http://raw.githubusercontent.com/Fourdee/DietPi/f289eb0b3d1ab54980adf8e5d025b46d4c55c85d/boot_c2.ini -O /DietPi/boot.ini

			# - Xserver/LXDE
			if [ -f /DietPi/dietpi/.installed ]; then

				# - Xserver
				if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG=2') )); then

					# - Update/Upgrade apt
					/DietPi/dietpi/dietpi-apt-get_update 2
					apt-get upgrade -y

					# - Reinstall all packages, including the X11 additions (xf86-video-mali-odroid libump-odroid)
					apt-get install -y xcompmgr aml-libs-odroid mali450-odroid xf86-video-mali-odroid libump-odroid --no-install-recommends
					cp /DietPi/dietpi/conf/xorg_c2.conf /etc/X11/xorg.conf

				fi

				# - LXDE xcompmgr
				if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE=2') )); then

					cat << _EOF_ > /etc/xdg/lxsession/LXDE/autostart
xcompmgr -a
@lxpanel --profile LXDE
@pcmanfm --desktop --profile LXDE
@xscreensaver -no-splash
_EOF_

				fi

			fi

		fi
		#-------------------------------------------------------------------------------
		#Weekly cronjob to update Pihole adlist
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'PIHOLE=2') )); then

			cat << _EOF_ > /etc/cron.weekly/pihole_adlist_update
#!/bin/bash
{
	service dnsmasq stop

	echo -e "--------------------------------------------------------------------\n\n\$(date)\nDietPi - Running weekly adlist update" >> /var/log/pihole.log
	/usr/local/bin/gravity.sh &>> /var/log/pihole.log
	echo -e "--------------------------------------------------------------------\n" >> /var/log/pihole.log

	service dnsmasq start

	exit 0
}

_EOF_

			chmod +x /etc/cron.weekly/pihole_adlist_update

		fi
		#-------------------------------------------------------------------------------
		#MineOS requires rsync: https://github.com/Fourdee/DietPi/issues/403
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'MINEOS=2') )); then

			apt-get install -y rsync

		fi
		#-------------------------------------------------------------------------------


	elif (( $VERSION_CURRENT == 121 )); then
		#-------------------------------------------------------------------------------
		echo -e "Nothing here" &> /dev/null
 		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 122 )); then
		#-------------------------------------------------------------------------------
		#Pine a64 resolution option in dietpi-config: https://github.com/Fourdee/DietPi/issues/398
		if (( $HW_MODEL >= 40 && $HW_MODEL < 50 )); then

			if (( ! $(cat /DietPi/uEnv.txt | grep -ci -m1 '^optargs=disp.screen0_output_mode=') )); then

				echo -e "\noptargs=disp.screen0_output_mode=1080p60" >> /DietPi/uEnv.txt

			fi

		fi
 		#-------------------------------------------------------------------------------
		#MPD software mixer control
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'HIFI=2') )); then

			sed -i '/mixer_device/c\mixer_type "software"' /etc/mpd.conf

		fi
		#-------------------------------------------------------------------------------
		#PiHole, prevent warning of a "file not found" when running gravity.sh: https://github.com/Fourdee/DietPi/issues/311#issuecomment-230342269
		# + log-async for rsyslog
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'PIHOLE=2') )); then

			echo -e "#nothing here" > /etc/dnsmasq.d/01-pihole.conf

			if (( ! $(cat /etc/dnsmasq.conf | grep -ci -m1 'log-async') )); then

				echo -e "log-async" >> /etc/dnsmasq.conf

			fi

		fi
		#-------------------------------------------------------------------------------
		#RPi Monitor USB drive patch
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'RPIMONITOR=2') )) &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'USBDRIVE=2') )) &&
			(( ! $(cat /etc/rpimonitor/data.conf | grep -ci -m1 'usb_hdd.conf') )); then

			sed -i '\/include=\/etc\/rpimonitor\/template\/sdcard.conf/a include=\/etc\/rpimonitor\/template\/usb_hdd.conf' /etc/rpimonitor/data.conf

			cat << _EOF_ > /etc/rpimonitor/template/usb_hdd.conf
########################################################################
# Extract USB HDD (sda1) information
#  Page: 1
#  Information               Status     Statistics
#  - USBHDD1 total          - yes      - yes
#  - USBHDD1 used           - yes      - yes
########################################################################
static.10.name=usbhdd_total
static.10.source=df -t ext4
static.10.regexp=sda1\s+(\d+)
static.10.postprocess=\$1/1024

dynamic.14.name=usbhdd_used
dynamic.14.source=df -t ext4
dynamic.14.regexp=sda1\s+\d+\s+(\d+)
dynamic.14.postprocess=\$1/1024
dynamic.14.rrd=GAUGE

web.status.1.content.9.name=USB HDD
web.status.1.content.9.icon=usb_hdd.png
web.status.1.content.9.line.1="<b>/sda1</b> Used: <b>"+KMG(data.usbhdd_used,'M')+"</b> (<b>"+Percent(data.udbhdd_used,data.usbhdd_total,'M')+"</b>) Free: <b>"+KMG(data.usbhdd_total-data.usbhdd_used,'M')+ "</b> Total: <b>"+ KMG(data.usbhdd_total,'M') +"</b>"
web.status.1.content.9.line.2=ProgressBar(data.usbhdd_used,data.usbhdd_total)

web.statistics.1.content.9.name=USB HDD
web.statistics.1.content.9.graph.1=usbhdd_total
web.statistics.1.content.9.graph.2=usbhdd_used
web.statistics.1.content.9.ds_graph_options.usbhdd_total.label=USB HDD total space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_total.color="#FF7777"
web.statistics.1.content.9.ds_graph_options.usbhdd_used.label=USB HDD used space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_used.lines={ fill: true }
web.statistics.1.content.9.ds_graph_options.usbhdd_used.color="#7777FF"
_EOF_
		fi
 		#-------------------------------------------------------------------------------
		#Kodi add NFS support:
		if [ -f /DietPi/dietpi/.installed ] && (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'KODI=2') )); then

			apt-get install -y libnfs4

		fi
		#-------------------------------------------------------------------------------
		#Odroid C2, define default pulseaudio sink: https://github.com/Fourdee/DietPi/issues/415
		if (( $HW_MODEL == 12 )) &&
			[ -f /DietPi/dietpi/.installed ] &&
			(( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_MATE=2') )) &&
			(( ! $(cat /etc/pulse/default.pa | grep -ci -m1 '^set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo') )); then

			echo -e "set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo" >> /etc/pulse/default.pa

		fi
		#-------------------------------------------------------------------------------
		#ARMbian images, install armbian repo and update packages
		if (( $HW_MODEL == 30 || $HW_MODEL == 50 || $HW_MODEL == 51 )) &&
			[ ! -f /proc/sunxi_debug/sunxi_debug ]; then # Skip the replaced OPi PC loboris image.

			echo "deb http://apt.armbian.com jessie main" > /etc/apt/sources.list.d/armbian.list
			apt-key adv --keyserver keys.gnupg.net --recv-keys 0x93D6889F9F0E78D5
			apt-get update

			# - remove ye-olde packages
			apt-get purge -y armbian-firmware

			#BPi m2+
			if (( $HW_MODEL == 50 )); then

				apt-get install -y linux-jessie-root-bananapim2plus linux-u-boot-bananapim2plus-default linux-headers-sun8i linux-firmware-image-sun8i linux-image-sun8i

			#OPi PC
			elif (( $HW_MODEL == 30 )); then

				# - remove ye-olde packages
				apt-get purge -y linux-jessie-root-orangepih3 linux-u-boot-orangepih3-default

				apt-get install -y linux-jessie-root-orangepipc linux-u-boot-orangepipc-default linux-headers-sun8i linux-firmware-image-sun8i linux-image-sun8i

			#BPi pro
			elif (( $HW_MODEL == 51 )); then

				apt-get install -y linux-jessie-root-bananapipro linux-image-sun7i linux-headers-sun7i linux-firmware-image-sun7i linux-u-boot-bananapipro-default

			fi

		fi

		#-------------------------------------------------------------------------------
		#alias sudo='sudo ' # https://github.com/Fourdee/DietPi/issues/424#issuecomment-232016646
		if (( ! $(cat /etc/bash.bashrc | grep -ci -m1 '^alias sudo=') )); then

			echo -e "alias sudo='sudo ' # https://github.com/Fourdee/DietPi/issues/424" >> /etc/bash.bashrc

		fi
		#-------------------------------------------------------------------------------
		#RPi add dtparam=spi=off to config by default
		if (( $HW_MODEL < 10 &&
			! $(cat /DietPi/config.txt | grep -ci -m1 'dtparam=spi=') )); then

			echo -e "\ndtparam=spi=off" >> /DietPi/config.txt

		fi

		#-------------------------------------------------------------------------------
		#DietPi-Config > LCD Panel addon
		if (( ! $(cat /DietPi/dietpi.txt | grep -ci -m1 '^lcdpanel=') )); then

			echo -e "\nlcdpanel=none" >> /DietPi/dietpi.txt

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 123 )); then
		#-------------------------------------------------------------------------------
		#Pine remove vim-* (was left on latest image) for new installations.
		if [ ! -f /DietPi/dietpi/.installed ] && (( $HW_MODEL >= 40 && $HW_MODEL < 50 )); then

			apt-get purge -y vim-common vim-tiny

		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 124 )); then
		#-------------------------------------------------------------------------------
		#Disable daily fstrim until testing can be performed to ensure this isnt causing the recent influx of filesystem corruptions.
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 125 )); then
		#-------------------------------------------------------------------------------
		#libcurl3-gnutls required for C2. But lets apply to all: https://github.com/Fourdee/DietPi/issues/446
		if [ -f /DietPi/dietpi/.installed ] &&
			(( $( cat /DietPi/dietpi/.installed | grep -ci -m1 '^KODI=2' ) )); then

			apt-get install -y libcurl3-gnutls

		fi
		#-------------------------------------------------------------------------------
		#C2 remove asound.conf for hdmi: https://github.com/Fourdee/DietPi/issues/447
		if (( $HW_MODEL == 12 )) && [ -f /etc/asound.conf ] &&
			(( $(cat /etc/asound.conf | grep -ci -m1 'format S32_LE') )); then

			rm /etc/asound.conf

		fi
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		#NB: all if statements must contain at least one command. Prevents bash having a hissy fit :)
		#-------------------------------------------------------------------------------
		#Delete all lines starting with a comment?
		#Considering this for all dietpi-scripts to reduce the ramdisk size on installed system.
		#sed -i '/^[[:blank:]]*#/d' file
		#-------------------------------------------------------------------------------

	#-------------------------------------------------------------------------------
	sleep 0.25
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}
