#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Software
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - filename /DietPi/dietpi/dietpi-software
	# - Installs "ready to run" software with optimizations unique to the device.
	# - Runs dietpi-update during 1st run setup.
	# - Generates and uses /DietPi/dietpi/.installed (software list) # 0=not installed, 1=selected for install, 2=installed
	#
	# Usage:
	# - dietpi-software
	# - /DietPi/dietpi/dietpi-software install		iUNIQUEID (OR) sINDEX_{SSHSERVER,FILESERVER,LOGGING,WEBSERVER}_TARGET=-int
	# - /DietPi/dietpi/dietpi-software reinstall	Same as installed, however, only reinstalls if state =2. Does not uninstall due to package removal danger (eg: xserver removes kodi), simply flags to be installed (=1).
	# - /DietPi/dietpi/dietpi-software uninstall	iUNIQUEID
	# - /DietPi/dietpi/dietpi-software list			#Lists UNIQUEIDs for software
	# - /DietPi/dietpi/dietpi-software setpermissions #Sets shared permissions for /var/www and userdata folders
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	#Exit path for non-root logins.
	if (( $UID != 0 )); then
		clear
		echo -e "\n ERROR: You do not have root privileges.\n Please login as root, or, use:\n sudo dietpi-software\n"

		Exit_Destroy
	fi

	#/////////////////////////////////////////////////////////////////////////////////////
	#Obtain Install Stage Index
	#/////////////////////////////////////////////////////////////////////////////////////
	# -3 = first boot / -2 = partition / -1 = filesystem / 0 = run dietpi-software at login / 1 = completed
	DIETPI_INSTALL_STAGE=$(cat /DietPi/dietpi/.install_stage)

	#/////////////////////////////////////////////////////////////////////////////////////
	#Hardware Details
	#/////////////////////////////////////////////////////////////////////////////////////
	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model) # 0=1(256) 1=1(512) 2=2(1024)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)
	HW_ARCH=$(sed -n 6p /DietPi/dietpi/.hw_model)

	#cpu/core count
	CPU_CORES_TOTAL=$(nproc --all)

	#Overide XU3/4 to 4 cores
	if (( $HW_MODEL == 11 )); then

		CPU_CORES_TOTAL=4

	fi

	#/////////////////////////////////////////////////////////////////////////////////////
	#Filepath
	#/////////////////////////////////////////////////////////////////////////////////////
	FP_INSTALLED_FILE="/DietPi/dietpi/.installed"
	FP_INSTALLED_FILE_TEMP='/tmp/dietpi-software.installed'

	FP_DIETPIAUTOMATION_LOG="/root/DietPi-Automation.log"

	#Used to set user/personal data directories (eg: usbdrive /mnt/usb_1)
	FP_DIETPI_USERDATA_DIRECTORY='/mnt/dietpi_userdata'
	FP_DIETPI_DEDICATED_USBDRIVE='/mnt/usb_1'

	#Uninstall temp file
	UNINSTALL_FILE='/tmp/dietpi_uninstall_list'

	#Default user content folders used in DietPi.
	FOLDER_MUSIC='Music'
	FOLDER_PICTURES='Pictures'
	FOLDER_VIDEO='Video'
	FOLDER_DOWNLOADS='downloads'

	Write_InstallFileList(){

		local write_software_in_pending_state=0

		local fp_target="$FP_INSTALLED_FILE"

		if [ "$1" = "temp" ]; then

			fp_target="$FP_INSTALLED_FILE_TEMP"
			write_software_in_pending_state=1

		fi

		rm "$fp_target" &> /dev/null

		#Save installed states
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			# - Never save pending state for software (=1). Excluding temp saves.
			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 && ! $write_software_in_pending_state )); then

				echo -e "aSOFTWARE_INSTALL_STATE[$i]=0" >> "$fp_target"

			else

				echo -e "aSOFTWARE_INSTALL_STATE[$i]=${aSOFTWARE_INSTALL_STATE[$i]}" >> "$fp_target"

			fi

		done

		#Misc
		cat << _EOF_ >> "$fp_target"

#DietPi Choice System: SSH Server
INDEX_SSHSERVER_CURRENT=$INDEX_SSHSERVER_CURRENT
INDEX_SSHSERVER_TARGET=$INDEX_SSHSERVER_TARGET

#DietPi Choice System: File Server
INDEX_FILESERVER_CURRENT=$INDEX_FILESERVER_CURRENT
INDEX_FILESERVER_TARGET=$INDEX_FILESERVER_TARGET

#DietPi Choice System: Logging
INDEX_LOGGING_CURRENT=$INDEX_LOGGING_CURRENT
INDEX_LOGGING_TARGET=$INDEX_LOGGING_TARGET

#DietPi Preference System: Webserver base
INDEX_WEBSERVER_CURRENT=$INDEX_WEBSERVER_CURRENT
INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_TARGET

_EOF_

	}

	Read_InstallFileList(){

		local fp_target="$FP_INSTALLED_FILE"

		if [ "$1" = "temp" ]; then

			fp_target="$FP_INSTALLED_FILE_TEMP"

		fi

		#Load Software states
		/DietPi/dietpi/func/dietpi-notify 2 "Reading database, please wait..."

		#Load
		if [ -f "$fp_target" ]; then

			. "$fp_target"

		fi

		#FOURDEE: reset choice targets to current ( caused by menu uninstall, as we have to save the installed file after its run )
		INDEX_SSHSERVER_TARGET=$INDEX_SSHSERVER_CURRENT
		INDEX_FILESERVER_TARGET=$INDEX_FILESERVER_CURRENT
		INDEX_LOGGING_TARGET=$INDEX_LOGGING_CURRENT
		INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_CURRENT

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Installation System
	#/////////////////////////////////////////////////////////////////////////////////////
	#Reboot after installation has finished.
	DISABLE_REBOOT=0

	#Run Instalation Flag (1 = run installs)
	GOSTARTINSTALL=0
	INSTALL_URL_ADDRESS=""
	INSTALL_DESCRIPTION='DietPi'

	#Special installation Vars
	USER_EMONHUB_APIKEY_COMPLETED=0
	USER_EMONHUB_APIKEY_CURRENT=0
	WIFIHOTSPOT_RTL8188C_DEVICE=0
	USER_LINUX_AUTOINSTALL_PROMPT_DISPLAYED=0

	#
	USBDRIVE=0

	#Choices Made?
	INSTALL_DIETPI_CHOICESMADE=0
	INSTALL_LINUX_CHOICESMADE=0

	#DietPi Choice System: SSH Server
	INSTALL_SSHSERVER_CHOICESMADE=0
	INDEX_SSHSERVER_CURRENT=-1
	INDEX_SSHSERVER_TARGET=-1

	#DietPi Choice System: Fileserver
	INSTALL_FILESERVER_CHOICESMADE=0
	INDEX_FILESERVER_CURRENT=0
	INDEX_FILESERVER_TARGET=0

	#DietPi Choice System: Logging
	INSTALL_LOGGING_CHOICESMADE=0
	INDEX_LOGGING_CURRENT=-1
	INDEX_LOGGING_TARGET=-1

	#DietPi Preference System: Webserver base
	INDEX_WEBSERVER_CURRENT=-2
	INDEX_WEBSERVER_TARGET=-2

	#Create DietPi-Software Arrays
	# - Categories
	aSOFTWARE_CATEGORIES_DIETPI=0 		#List of cats
	MAX_SOFTWARE_CATEGORIES_DIETPI=0

	aSOFTWARE_CATEGORIES_LINUX=0
	MAX_SOFTWARE_CATEGORIES_LINUX=0

	# - Software
	#NB: All software has a unique index that must not be changed (eg: DESKTOP_LXDE = 23)
	TOTAL_SOFTWARE_INDEXS=0
	TOTAL_SOFTWARE_INDEXS_HARDLIMIT=116 #Increase as needed. Must be higher than TOTAL_SOFTWARE_INDEXS once calculated in Software_Arrays_Init

	INSTALLING_INDEX=0					#Which software index is currently being installed?

	aSOFTWARE_CATEGORY_INDEX=0			#Category index
	aSOFTWARE_TYPE=0					#0=DietPi 1=Linux | -1=Hidden from install menu, visible in uninstall menu | -2 Hidden from all menus

	aSOFTWARE_INSTALL_STATE=0			#0=not / 1=tobe, or not tobe that is the... / 2=installed

	aSOFTWARE_WHIP_NAME=0				#Item name eg: Kodi
	aSOFTWARE_WHIP_DESC=0				#Blah blah

	FP_ONLINEDOC_URL='http://dietpi.com/phpbb/viewtopic.php?'
	aSOFTWARE_ONLINEDOC_URL=0			#eg

	# - Optional pre req software that needs to be installed
	aSOFTWARE_REQUIRES_ALSA=0
	aSOFTWARE_REQUIRES_XSERVERXORG=0
	aSOFTWARE_REQUIRES_MYSQL=0
	aSOFTWARE_REQUIRES_SQLITE=0
	aSOFTWARE_REQUIRES_WEBSERVER=0
	aSOFTWARE_REQUIRES_DESKTOP=0
	aSOFTWARE_REQUIRES_GIT=0
	aSOFTWARE_REQUIRES_BUILDESSENTIAL=0
	aSOFTWARE_REQUIRES_RSYSLOG=0
	aSOFTWARE_REQUIRES_FFMPEG=0
	aSOFTWARE_REQUIRES_ORACLEJAVA=0
	aSOFTWARE_REQUIRES_NODEJS=0

	# - Available for
	MAX_HW_MODEL=62		#This needs to match highest HW_MODEL value in dietpi-obtain_hw_model
	MAX_HW_ARCH=21		#This needs to match highest HW_ARCH value in dietpi-obtain_hw_model
	#	2D array (well, bash style)
	declare -A aSOFTWARE_AVAIL_HW_MODEL
	declare -A aSOFTWARE_AVAIL_HW_ARCH

	Software_Arrays_Init(){

		#--------------------------------------------------------------------------------
		#Categories
		#NB: Unique Indexs, do not re-arrange or re-order.
		#--------------------------------------------------------------------------------
		#DietPi software
		aSOFTWARE_CATEGORIES_DIETPI=(

			"────Desktops──────────────────────────────────────────────" #0
			"────Remote Desktop Access─────────────────────────────────" #1
			"────Media Systems─────────────────────────────────────────" #2
			"────BitTorrent────────────────────────────────────────────" #3
			"────Cloud / Backups───────────────────────────────────────" #4
			"────Emulation & Gaming────────────────────────────────────" #5
			"────Social Media──────────────────────────────────────────" #6
			"────Camera / Surveillance─────────────────────────────────" #7
			"────WiFi Hotspot──────────────────────────────────────────" #8
			"────System Stats / Management─────────────────────────────" #9
			"────Remote Access─────────────────────────────────────────" #10
			"────Hardware Projects─────────────────────────────────────" #11
			"────System Security───────────────────────────────────────" #12
			"────Webserver Stacks──────────────────────────────────────" #13
			"────Pi-hole───────────────────────────────────────────────" #14
			"────File Servers──────────────────────────────────────────" #15
			"────VPN Servers───────────────────────────────────────────" #16
			"────Advanced Networking───────────────────────────────────" #17
			"────Home Automation───────────────────────────────────────" #18

		)

		MAX_SOFTWARE_CATEGORIES_DIETPI=${#aSOFTWARE_CATEGORIES_DIETPI[@]}

		#DietPi software
		aSOFTWARE_CATEGORIES_LINUX=(

			"────SSH Clients───────────────────────────────────────────" #0
			"────Fileserver Clients────────────────────────────────────" #1
			"────File Managers─────────────────────────────────────────" #2
			"────System────────────────────────────────────────────────" #3
			"────Shared Libraries──────────────────────────────────────" #4
			"────Network Tools─────────────────────────────────────────" #5
			"────Development / Programming─────────────────────────────" #6
			"────Text Editors──────────────────────────────────────────" #7
			"────Desktop Utilities─────────────────────────────────────" #8

		)

		MAX_SOFTWARE_CATEGORIES_LINUX=${#aSOFTWARE_CATEGORIES_LINUX[@]}

		#--------------------------------------------------------------------------------
		#Init | Available For
		#--------------------------------------------------------------------------------
		#Set available by default for all devices and arch

		local debug_array_count=0
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS_HARDLIMIT; i++))
		do

			for ((j=0; j<=$MAX_HW_MODEL; j++))
			do

				aSOFTWARE_AVAIL_HW_MODEL[$i,$j]=1
				# ((debug_array_count++))
				# echo -e "$debug_array_count ${aSOFTWARE_AVAIL_HW_MODEL[$i,$j]}"

			done

		done

		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS_HARDLIMIT; i++))
		do

			for ((j=0; j<=$MAX_HW_ARCH; j++))
			do

				aSOFTWARE_AVAIL_HW_ARCH[$i,$j]=1
				# ((debug_array_count++))
				# echo -e "$debug_array_count ${aSOFTWARE_AVAIL_HW_ARCH[$i,$j]}"

			done

		done

		#--------------------------------------------------------------------------------
		#Int Online Docs
		#--------------------------------------------------------------------------------
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS_HARDLIMIT; i++))
		do

			aSOFTWARE_ONLINEDOC_URL[$i]=''

		done

		#--------------------------------------------------------------------------------
		#Requires software to be installed
		#--------------------------------------------------------------------------------
		#As we don't define this for all software, init the arrays to 0
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS_HARDLIMIT; i++))
		do

			aSOFTWARE_REQUIRES_ALSA[$i]=0
			aSOFTWARE_REQUIRES_XSERVERXORG[$i]=0
			aSOFTWARE_REQUIRES_MYSQL[$i]=0
			aSOFTWARE_REQUIRES_SQLITE[$i]=0
			aSOFTWARE_REQUIRES_WEBSERVER[$i]=0
			aSOFTWARE_REQUIRES_DESKTOP[$i]=0
			aSOFTWARE_REQUIRES_GIT[$i]=0
			aSOFTWARE_REQUIRES_BUILDESSENTIAL[$i]=0
			aSOFTWARE_REQUIRES_RSYSLOG[$i]=0
			aSOFTWARE_REQUIRES_FFMPEG[$i]=0
			aSOFTWARE_REQUIRES_ORACLEJAVA[$i]=0
			aSOFTWARE_REQUIRES_NODEJS[$i]=0

		done


		#--------------------------------------------------------------------------------
		#DietPi software items
		#--------------------------------------------------------------------------------
		#Assign UNIQUE index to each item
		local index_current=0

		#Desktops
		#--------------------------------------------------------------------------------
		index_current=23

				 aSOFTWARE_WHIP_NAME[$index_current]='LXDE'
				 aSOFTWARE_WHIP_DESC[$index_current]='ultra lightweight desktop'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p42'

		#------------------
		index_current=24
				 aSOFTWARE_WHIP_NAME[$index_current]='MATE'
				 aSOFTWARE_WHIP_DESC[$index_current]='desktop enviroment'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=60#p2073'

		#------------------
		index_current=25

				 aSOFTWARE_WHIP_NAME[$index_current]='XFCE'
				 aSOFTWARE_WHIP_DESC[$index_current]='lightweight desktop environment'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=70#p2203'

		#------------------
		index_current=26

				 aSOFTWARE_WHIP_NAME[$index_current]='GNUStep'
				 aSOFTWARE_WHIP_DESC[$index_current]='lightweight based on OpenStep'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=60#p2072'

		#------------------
		index_current=113

				 aSOFTWARE_WHIP_NAME[$index_current]='Chromium'
				 aSOFTWARE_WHIP_DESC[$index_current]='(Optional) web browser'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='http://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=3011#p3011'

		# - disable for all
		# for ((i=0; i<=$MAX_HW_MODEL; i++))
		# do

			# aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		# done

		# - reenable for RPi 2+ requires openGL enable driver
		# for ((i=2; i<10; i++))
		# do

			# aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=1

		# done

		# - reenable for Pine A64 | software render
		# for ((i=40; i<50; i++))
		# do

			# aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=1

		# done


		#Remote Desktops
		#--------------------------------------------------------------------------------
		index_current=27

				 aSOFTWARE_WHIP_NAME[$index_current]='TightVNC Server'
				 aSOFTWARE_WHIP_DESC[$index_current]='desktop for remote connection'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p408'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0

		#------------------
		index_current=28

				 aSOFTWARE_WHIP_NAME[$index_current]='VNC4 Server'
				 aSOFTWARE_WHIP_DESC[$index_current]='desktop for remote connection'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p408'

		#------------------
		index_current=29

				 aSOFTWARE_WHIP_NAME[$index_current]='XRDP'
				 aSOFTWARE_WHIP_DESC[$index_current]='remote desktop protocol (rdp) server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=70#p2074'

		#------------------
		index_current=30

				 aSOFTWARE_WHIP_NAME[$index_current]='NoMachine'
				 aSOFTWARE_WHIP_DESC[$index_current]='multi-platform server and client access'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_DESKTOP[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=60#p2071'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0


		#Media Systems
		#--------------------------------------------------------------------------------
		index_current=31

				 aSOFTWARE_WHIP_NAME[$index_current]='Kodi'
				 aSOFTWARE_WHIP_DESC[$index_current]='the media centre for linux'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p43'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,21]=0

		# - Disabled for HW_MODEL
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,30]=0
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,31]=0
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,50]=0
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,51]=0
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,60]=0

		# - Disabled for All Pine64
		for ((i=40; i<50; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=32

				 aSOFTWARE_WHIP_NAME[$index_current]='HiFi'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface music & radio player'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p50'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,21]=0

		#------------------
		index_current=33

				 aSOFTWARE_WHIP_NAME[$index_current]='SubSonic 5'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$index_current]=1
	   aSOFTWARE_REQUIRES_ORACLEJAVA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p213'

		#------------------
		index_current=34

				 aSOFTWARE_WHIP_NAME[$index_current]='SubSonic 6'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$index_current]=1
	   aSOFTWARE_REQUIRES_ORACLEJAVA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p213'

		#------------------
		index_current=35

				 aSOFTWARE_WHIP_NAME[$index_current]='SqueezeBox'
				 aSOFTWARE_WHIP_DESC[$index_current]='logitech media server (lms)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1009#p1009'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		# - Available for ARM64: https://github.com/Fourdee/DietPi/issues/354
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,12]=1
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,40]=1
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,41]=1
		aSOFTWARE_AVAIL_HW_MODEL[$index_current,42]=1

		#------------------
		index_current=36

				 aSOFTWARE_WHIP_NAME[$index_current]='SqueezeLite'
				 aSOFTWARE_WHIP_DESC[$index_current]='audio player for lms & squeezebox'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1009#p1009'

		# - Disabled for All non-rpi
		# for ((i=10; i<=$MAX_HW_MODEL; i++))
		# do

			# aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		# done

		#------------------
		index_current=37

				 aSOFTWARE_WHIP_NAME[$index_current]='Shairport Sync'
				 aSOFTWARE_WHIP_DESC[$index_current]='airplay audio player with multiroom sync'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1221#p1221'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,21]=0

		#------------------
		index_current=38

				 aSOFTWARE_WHIP_NAME[$index_current]='BruteFIR'
				 aSOFTWARE_WHIP_DESC[$index_current]='eq and digital room correction via alsa'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=57#p57'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=39

				 aSOFTWARE_WHIP_NAME[$index_current]='MiniDLNA'
				 aSOFTWARE_WHIP_DESC[$index_current]='media streaming server (dlna, upnp)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p49'

		#------------------
		index_current=40

				 aSOFTWARE_WHIP_NAME[$index_current]='Ampache'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			  aSOFTWARE_REQUIRES_GIT[$index_current]=1
		   aSOFTWARE_REQUIRES_FFMPEG[$index_current]=1
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=40#p554'

		#------------------
		index_current=41

				 aSOFTWARE_WHIP_NAME[$index_current]='Emby Server'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
		   aSOFTWARE_REQUIRES_FFMPEG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1789#p1789'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0

		#------------------
		index_current=42

				 aSOFTWARE_WHIP_NAME[$index_current]='Plex Media Server'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface media streaming server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1949#p1949'

		#------------------
		index_current=43

				 aSOFTWARE_WHIP_NAME[$index_current]='Murmur'
				 aSOFTWARE_WHIP_DESC[$index_current]='mumble voip server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1691#p1691'

		#BitTorrent
		#--------------------------------------------------------------------------------
		index_current=44

				 aSOFTWARE_WHIP_NAME[$index_current]='Transmission'
				 aSOFTWARE_WHIP_DESC[$index_current]='bittorrent server with web interface (c)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=3
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p46'

		#------------------
		index_current=45

				 aSOFTWARE_WHIP_NAME[$index_current]='Deluge'
				 aSOFTWARE_WHIP_DESC[$index_current]='bittorrent server with web interface (python)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=3
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p61'

		#------------------
		index_current=46

				 aSOFTWARE_WHIP_NAME[$index_current]='qBitTorrent'
				 aSOFTWARE_WHIP_DESC[$index_current]='bittorrent server with web interface (c++)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=3
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=70#p2272'

		#------------------
		index_current=107

				 aSOFTWARE_WHIP_NAME[$index_current]='rTorrent'
				 aSOFTWARE_WHIP_DESC[$index_current]='bittorrent server with rutorrent web interface'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=3
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
		   #aSOFTWARE_REQUIRES_FFMPEG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=2603#p2603'


		#Cloud / Backups
		#--------------------------------------------------------------------------------
		index_current=47

				 aSOFTWARE_WHIP_NAME[$index_current]='OwnCloud'
				 aSOFTWARE_WHIP_DESC[$index_current]='your very own cloud (eg: dropbox)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p47'

		#------------------
		index_current=114

				 aSOFTWARE_WHIP_NAME[$index_current]='NextCloud'
				 aSOFTWARE_WHIP_DESC[$index_current]='your very own cloud (eg: dropbox)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'

		#------------------
		index_current=48

				 aSOFTWARE_WHIP_NAME[$index_current]='Pydio'
				 aSOFTWARE_WHIP_DESC[$index_current]='feature-rich backup and sync server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1064#p1064'

		#------------------
		index_current=111

				 aSOFTWARE_WHIP_NAME[$index_current]='UrBackup server'
				 aSOFTWARE_WHIP_DESC[$index_current]='full system backup server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=65#p65'

		#No deb packages for ARMv6:
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,1]=0

		#------------------
		index_current=49

				 aSOFTWARE_WHIP_NAME[$index_current]='Gogs'
				 aSOFTWARE_WHIP_DESC[$index_current]='personal github server with web interface'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=0
			  aSOFTWARE_REQUIRES_GIT[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=70#p2187'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0

		#------------------
		index_current=50

				 aSOFTWARE_WHIP_NAME[$index_current]='Syncthing'
				 aSOFTWARE_WHIP_DESC[$index_current]='backup and sync server with web interface'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=70#p2363'

		#------------------

		#Emulation / Gaming
		#--------------------------------------------------------------------------------
		index_current=108

				 aSOFTWARE_WHIP_NAME[$index_current]='AmiBerry (Uae4ARM)'
				 aSOFTWARE_WHIP_DESC[$index_current]='amiga emulator'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=64#p64'
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=51

				 aSOFTWARE_WHIP_NAME[$index_current]='OpenTyrian'
				 aSOFTWARE_WHIP_DESC[$index_current]='a classic retro game, addictive'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
	  aSOFTWARE_REQUIRES_XSERVERXORG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p45'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=112

				 aSOFTWARE_WHIP_NAME[$index_current]='DXX-Rebirth'
				 aSOFTWARE_WHIP_DESC[$index_current]='Descent 1/2'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_REQUIRES_ALSA[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=2963#p2963'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=52

				 aSOFTWARE_WHIP_NAME[$index_current]='Cuberite'
				 aSOFTWARE_WHIP_DESC[$index_current]='minecraft server with web interface (c++)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=60#p2068'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0

		#------------------
		index_current=53

				 aSOFTWARE_WHIP_NAME[$index_current]='MineOS'
				 aSOFTWARE_WHIP_DESC[$index_current]='minecraft servers with web interface (java)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$index_current]=1
			  aSOFTWARE_REQUIRES_GIT[$index_current]=1
	   aSOFTWARE_REQUIRES_ORACLEJAVA[$index_current]=1
		   aSOFTWARE_REQUIRES_NODEJS[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=60#p2069'

		#------------------

		#Social Media
		#--------------------------------------------------------------------------------
		index_current=54

				 aSOFTWARE_WHIP_NAME[$index_current]='Forums'
				 aSOFTWARE_WHIP_DESC[$index_current]='phpbb forums'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=5#p51'

		#------------------
		index_current=55

				 aSOFTWARE_WHIP_NAME[$index_current]='Wordpress'
				 aSOFTWARE_WHIP_DESC[$index_current]='website blog and publishing platform'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p395'

		#------------------
		index_current=56

				 aSOFTWARE_WHIP_NAME[$index_current]='Image Gallery'
				 aSOFTWARE_WHIP_DESC[$index_current]='website to host / browse your images'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=40#p480'

		#------------------
		index_current=57

				 aSOFTWARE_WHIP_NAME[$index_current]='BaiKal'
				 aSOFTWARE_WHIP_DESC[$index_current]='lightweight caldav + carddav server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=50#p1502'

		#------------------
		index_current=58

				 aSOFTWARE_WHIP_NAME[$index_current]='OpenBazaar'
				 aSOFTWARE_WHIP_DESC[$index_current]='decentralized peer to peer bitcoin market'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$index_current]=1
			  aSOFTWARE_REQUIRES_GIT[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1796#p1796'

		#------------------

		#Camera
		#--------------------------------------------------------------------------------
		index_current=59

				 aSOFTWARE_WHIP_NAME[$index_current]='DietPi Cam'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface & controls for your rpi camera'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=7
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p48'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------

		#WiFi Hotspot
		#--------------------------------------------------------------------------------
		index_current=60

				 aSOFTWARE_WHIP_NAME[$index_current]='WiFi Hotspot'
				 aSOFTWARE_WHIP_DESC[$index_current]='turn your device into a wifi hotspot'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=8
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1207#p1207'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,21]=0

		#------------------
		index_current=61

				 aSOFTWARE_WHIP_NAME[$index_current]='Tor Hotspot'
				 aSOFTWARE_WHIP_DESC[$index_current]='optional: route hotspot traffic through tor'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=8
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1529#p1529'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,21]=0

		#------------------

		#System stats
		#--------------------------------------------------------------------------------
		index_current=62

				 aSOFTWARE_WHIP_NAME[$index_current]='DietPi-Cloudshell'
				 aSOFTWARE_WHIP_DESC[$index_current]='system stats displayed on lcd/panel'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p204'

		#------------------
		index_current=63

				 aSOFTWARE_WHIP_NAME[$index_current]='LinuxDash'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p108'

		#------------------
		index_current=64

				 aSOFTWARE_WHIP_NAME[$index_current]='PhpSysInfo'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p451'

		#------------------
		index_current=65

				 aSOFTWARE_WHIP_NAME[$index_current]='netdata'
				 aSOFTWARE_WHIP_DESC[$index_current]='real-time performance monitoring'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
		   aSOFTWARE_REQUIRES_NODEJS[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=60#p1611'

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,21]=0

		#------------------
		index_current=66

				 aSOFTWARE_WHIP_NAME[$index_current]='RPi-Monitor'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=50#p1503'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=106

				 aSOFTWARE_WHIP_NAME[$index_current]='Raspcontrol'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface system stats'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p89'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0

		#------------------
		index_current=115

				 aSOFTWARE_WHIP_NAME[$index_current]='Webmin'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface system management'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=9
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='xxxxxxxxxxx'
		  aSOFTWARE_REQUIRES_RSYSLOG[$index_current]=1

		#------------------

		#Remote Access
		#--------------------------------------------------------------------------------
		index_current=67

				 aSOFTWARE_WHIP_NAME[$index_current]='NoIp'
				 aSOFTWARE_WHIP_DESC[$index_current]='url website address for your device'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=10
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p58'

		#------------------
		index_current=68

				 aSOFTWARE_WHIP_NAME[$index_current]='Weaved'
				 aSOFTWARE_WHIP_DESC[$index_current]='access your device over the internet'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=10
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p188'

		#------------------

		#Hardware projects
		#--------------------------------------------------------------------------------
		index_current=69

				 aSOFTWARE_WHIP_NAME[$index_current]='RPi.GPIO'
				 aSOFTWARE_WHIP_DESC[$index_current]='gpio interface library for rpi (python)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=11
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=40#p1065'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=70

				 aSOFTWARE_WHIP_NAME[$index_current]='WiringPi'
				 aSOFTWARE_WHIP_DESC[$index_current]='gpio interface library for rpi (c)'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=11
					  aSOFTWARE_TYPE[$index_current]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1066#p1066'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=71

				 aSOFTWARE_WHIP_NAME[$index_current]='WebIOPi'
				 aSOFTWARE_WHIP_DESC[$index_current]='web interface to control rpi.gpio'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=11
					  aSOFTWARE_TYPE[$index_current]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p189'

		# - Disabled for All non-rpi and RPi3
		for ((i=3; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=72

				 aSOFTWARE_WHIP_NAME[$index_current]='I2c'
				 aSOFTWARE_WHIP_DESC[$index_current]='enables support for i2c based hardware'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=11
					  aSOFTWARE_TYPE[$index_current]=0

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------

		#System security
		#--------------------------------------------------------------------------------
		index_current=73

				 aSOFTWARE_WHIP_NAME[$index_current]='Fail2Ban'
				 aSOFTWARE_WHIP_DESC[$index_current]='prevents brute-force attacks with ip ban'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=12
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_RSYSLOG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p452'
		#------------------

		#Webserver stacks
		#--------------------------------------------------------------------------------
		index_current=74

				 aSOFTWARE_WHIP_NAME[$index_current]='LAMP'
				 aSOFTWARE_WHIP_DESC[$index_current]='apache2  | mysql   | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p52'

		#------------------
		index_current=75

				 aSOFTWARE_WHIP_NAME[$index_current]='LASP'
				 aSOFTWARE_WHIP_DESC[$index_current]='apache2  | sqlite  | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p52'

		#------------------
		index_current=76

				 aSOFTWARE_WHIP_NAME[$index_current]='LAAP'
				 aSOFTWARE_WHIP_DESC[$index_current]='apache2  | mariadb | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p52'

		#------------------
		index_current=77

				 aSOFTWARE_WHIP_NAME[$index_current]='LEMP'
				 aSOFTWARE_WHIP_DESC[$index_current]='nginx    | mysql   | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p5'

		#------------------
		index_current=78

				 aSOFTWARE_WHIP_NAME[$index_current]='LESP'
				 aSOFTWARE_WHIP_DESC[$index_current]='nginx    | sqlite  | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p5'

		#------------------
		index_current=79

				 aSOFTWARE_WHIP_NAME[$index_current]='LEAP'
				 aSOFTWARE_WHIP_DESC[$index_current]='nginx    | mariadb | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p5'

		#------------------
		index_current=80

				 aSOFTWARE_WHIP_NAME[$index_current]='LLMP'
				 aSOFTWARE_WHIP_DESC[$index_current]='lighttpd | mysql   | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=81

				 aSOFTWARE_WHIP_NAME[$index_current]='LLSP'
				 aSOFTWARE_WHIP_DESC[$index_current]='lighttpd | sqlite  | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=82

				 aSOFTWARE_WHIP_NAME[$index_current]='LLAP'
				 aSOFTWARE_WHIP_DESC[$index_current]='lighttpd | mariadb | php'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=83

				 aSOFTWARE_WHIP_NAME[$index_current]='Apache2'
				 aSOFTWARE_WHIP_DESC[$index_current]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p52'

		#------------------
		index_current=84

				 aSOFTWARE_WHIP_NAME[$index_current]='Lighttpd'
				 aSOFTWARE_WHIP_DESC[$index_current]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=85

				 aSOFTWARE_WHIP_NAME[$index_current]='Nginx'
				 aSOFTWARE_WHIP_DESC[$index_current]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5#p5'

		#------------------
		index_current=86

				 aSOFTWARE_WHIP_NAME[$index_current]='MySQL'
				 aSOFTWARE_WHIP_DESC[$index_current]='database'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=87

				 aSOFTWARE_WHIP_NAME[$index_current]='SQlite'
				 aSOFTWARE_WHIP_DESC[$index_current]='database'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=88

				 aSOFTWARE_WHIP_NAME[$index_current]='MariaDB'
				 aSOFTWARE_WHIP_DESC[$index_current]='database'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=89

				 aSOFTWARE_WHIP_NAME[$index_current]='PHP'
				 aSOFTWARE_WHIP_DESC[$index_current]='webserver'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1335#p1335'

		#------------------
		index_current=90

				 aSOFTWARE_WHIP_NAME[$index_current]='phpMyAdmin'
				 aSOFTWARE_WHIP_DESC[$index_current]='optional mysql admin tools'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			aSOFTWARE_REQUIRES_MYSQL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p54'

		#------------------
		index_current=91

				 aSOFTWARE_WHIP_NAME[$index_current]='Redis'
				 aSOFTWARE_WHIP_DESC[$index_current]='optional non-sql database store'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0

		# - Disabled for HW_ARCH
		aSOFTWARE_AVAIL_HW_ARCH[$index_current,10]=0

		#------------------
		index_current=92

				 aSOFTWARE_WHIP_NAME[$index_current]='CertBot'
				 aSOFTWARE_WHIP_DESC[$index_current]='free, ssl cert install allowing https://'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=13
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1061#p1062'

		#------------------

		#PiHole
		#--------------------------------------------------------------------------------
		index_current=93

				 aSOFTWARE_WHIP_NAME[$index_current]='Pi-hole'
				 aSOFTWARE_WHIP_DESC[$index_current]='block adverts for any device on your network'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=14
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p174'

		#------------------

		#File servers
		#--------------------------------------------------------------------------------
		index_current=94

				 aSOFTWARE_WHIP_NAME[$index_current]='ProFTP'
				 aSOFTWARE_WHIP_DESC[$index_current]='lightweight ftp server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=15
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p55'

		#------------------
		index_current=95

				 aSOFTWARE_WHIP_NAME[$index_current]='vsFTPD'
				 aSOFTWARE_WHIP_DESC[$index_current]='alternative ftp server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=15
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='?f=8&t=5&p=2820#p2820'

		#------------------
		index_current=96

				 aSOFTWARE_WHIP_NAME[$index_current]='Samba'
				 aSOFTWARE_WHIP_DESC[$index_current]='feature-rich file server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=15
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p56'

		#------------------
		index_current=109

				 aSOFTWARE_WHIP_NAME[$index_current]='NFS'
				 aSOFTWARE_WHIP_DESC[$index_current]='network file system server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=15
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p56'

		#------------------

		#VPN servers
		#--------------------------------------------------------------------------------
		index_current=97

				 aSOFTWARE_WHIP_NAME[$index_current]='OpenVPN'
				 aSOFTWARE_WHIP_DESC[$index_current]='vpn server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=16
					  aSOFTWARE_TYPE[$index_current]=0
		  aSOFTWARE_REQUIRES_RSYSLOG[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=613#p613'

		#------------------


		#Advanced Networking
		#--------------------------------------------------------------------------------
		index_current=98

				 aSOFTWARE_WHIP_NAME[$index_current]='HaProxy'
				 aSOFTWARE_WHIP_DESC[$index_current]='high performance tcp/http load balancer'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=17
					  aSOFTWARE_TYPE[$index_current]=0
   aSOFTWARE_REQUIRES_BUILDESSENTIAL[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=30#p221'

		#Home automation
		#--------------------------------------------------------------------------------
		index_current=99

				 aSOFTWARE_WHIP_NAME[$index_current]='EmonPi'
				 aSOFTWARE_WHIP_DESC[$index_current]='energy usage addon board with web interface'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=18
					  aSOFTWARE_TYPE[$index_current]=0
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&p=1529#p1525'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------
		index_current=100

				 aSOFTWARE_WHIP_NAME[$index_current]='Grasshopper'
				 aSOFTWARE_WHIP_DESC[$index_current]='web app to control bticino myhome'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=18
					  aSOFTWARE_TYPE[$index_current]=0
		aSOFTWARE_REQUIRES_WEBSERVER[$index_current]=1
		   aSOFTWARE_REQUIRES_SQLITE[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p70'

		# - Disabled for All non-rpi
		for ((i=10; i<=$MAX_HW_MODEL; i++))
		do

			aSOFTWARE_AVAIL_HW_MODEL[$index_current,$i]=0

		done

		#------------------


		#--------------------------------------------------------------------------------
		#Additional linux software items
		#--------------------------------------------------------------------------------

		#SSH clients
		#--------------------------------------------------------------------------------
		index_current=0

				 aSOFTWARE_WHIP_NAME[$index_current]='OpenSSH Client'
				 aSOFTWARE_WHIP_DESC[$index_current]=''
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#File server clients
		#--------------------------------------------------------------------------------
		index_current=1

				 aSOFTWARE_WHIP_NAME[$index_current]='Samba Client'
				 aSOFTWARE_WHIP_DESC[$index_current]='access network shares'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]=' dietpi-config > Network Options: NAS/Misc'
		#------------------
		index_current=2

				 aSOFTWARE_WHIP_NAME[$index_current]='Curlftpfs'
				 aSOFTWARE_WHIP_DESC[$index_current]='ftp client with filesystem mount'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]=' dietpi-config > Network Options: NAS/Misc'
		#------------------
		index_current=110

				 aSOFTWARE_WHIP_NAME[$index_current]='NFS Client'
				 aSOFTWARE_WHIP_DESC[$index_current]='network file system client'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=1
					  aSOFTWARE_TYPE[$index_current]=1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]=' dietpi-config > Network Options: NAS/Misc'
		#------------------

		#File managers
		#--------------------------------------------------------------------------------
		index_current=3

				 aSOFTWARE_WHIP_NAME[$index_current]='MC'
				 aSOFTWARE_WHIP_DESC[$index_current]='midnight commander, powerful file manager'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=4

				 aSOFTWARE_WHIP_NAME[$index_current]='ViFM'
				 aSOFTWARE_WHIP_DESC[$index_current]='file manager with vi bindings'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=2
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#System
		#--------------------------------------------------------------------------------
		index_current=5

				 aSOFTWARE_WHIP_NAME[$index_current]='ALSA'
				 aSOFTWARE_WHIP_DESC[$index_current]='linux sound system'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=3
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=6

				 aSOFTWARE_WHIP_NAME[$index_current]='Xserver'
				 aSOFTWARE_WHIP_DESC[$index_current]='linux display system'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=3
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#Shared Libs
		#--------------------------------------------------------------------------------
		index_current=7

				 aSOFTWARE_WHIP_NAME[$index_current]='FFmpeg'
				 aSOFTWARE_WHIP_DESC[$index_current]='audio & visual libary'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=8

				 aSOFTWARE_WHIP_NAME[$index_current]='Java'
				 aSOFTWARE_WHIP_DESC[$index_current]='oracle java 8 jdk/jre libary'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=9

				 aSOFTWARE_WHIP_NAME[$index_current]='Node.js'
				 aSOFTWARE_WHIP_DESC[$index_current]='javascript runtime'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=4
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#Network tools
		#--------------------------------------------------------------------------------
		index_current=10

				 aSOFTWARE_WHIP_NAME[$index_current]='iftop'
				 aSOFTWARE_WHIP_DESC[$index_current]='displays bandwidth usage information'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=11

				 aSOFTWARE_WHIP_NAME[$index_current]='IPTraf'
				 aSOFTWARE_WHIP_DESC[$index_current]='interactive colorful ip lan monitor'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=12

				 aSOFTWARE_WHIP_NAME[$index_current]='Iperf'
				 aSOFTWARE_WHIP_DESC[$index_current]='internet protocol bandwidth measuring tool'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=13

				 aSOFTWARE_WHIP_NAME[$index_current]='MTR-Tiny'
				 aSOFTWARE_WHIP_DESC[$index_current]='full screen ncurses traceroute tool'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=14

				 aSOFTWARE_WHIP_NAME[$index_current]='nLoad'
				 aSOFTWARE_WHIP_DESC[$index_current]='realtime console network usage monitor'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=15

				 aSOFTWARE_WHIP_NAME[$index_current]='tcpdump'
				 aSOFTWARE_WHIP_DESC[$index_current]='command-line network traffic analyzer'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=5
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#Development / Programming
		#--------------------------------------------------------------------------------
		index_current=16

				 aSOFTWARE_WHIP_NAME[$index_current]='Build-Essentials'
				 aSOFTWARE_WHIP_DESC[$index_current]='common packages for compile'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=17

				 aSOFTWARE_WHIP_NAME[$index_current]='Git Client'
				 aSOFTWARE_WHIP_DESC[$index_current]='git clone etc'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=6
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#Text Editors
		#--------------------------------------------------------------------------------
		index_current=18

				 aSOFTWARE_WHIP_NAME[$index_current]='Emacs'
				 aSOFTWARE_WHIP_DESC[$index_current]='gnu emacs editor'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=7
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=19

				 aSOFTWARE_WHIP_NAME[$index_current]='Jed'
				 aSOFTWARE_WHIP_DESC[$index_current]='editor for programmers'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=7
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=20

				 aSOFTWARE_WHIP_NAME[$index_current]='Vim'
				 aSOFTWARE_WHIP_DESC[$index_current]='vi enhanced text editor'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=7
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------
		index_current=21

				 aSOFTWARE_WHIP_NAME[$index_current]='Vim-Tiny'
				 aSOFTWARE_WHIP_DESC[$index_current]='compact release of vim'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=7
					  aSOFTWARE_TYPE[$index_current]=1
		#------------------

		#Desktop Utilities
		#--------------------------------------------------------------------------------
		index_current=22

				 aSOFTWARE_WHIP_NAME[$index_current]='QuiteRSS'
				 aSOFTWARE_WHIP_DESC[$index_current]='cross-platform, free rss reader'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=8
					  aSOFTWARE_TYPE[$index_current]=1
		  aSOFTWARE_REQUIRES_DESKTOP[$index_current]=1

		#------------------

		#--------------------------------------------------------------------------------
		#Logging (hidden)
		#--------------------------------------------------------------------------------
		index_current=101

				 aSOFTWARE_WHIP_NAME[$index_current]='Log Rotate'
				 aSOFTWARE_WHIP_DESC[$index_current]='rotates log files'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p68'
		#------------------
		index_current=102

				 aSOFTWARE_WHIP_NAME[$index_current]='Rsyslog'
				 aSOFTWARE_WHIP_DESC[$index_current]='system logging'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p68'
		#------------------
		index_current=103

				 aSOFTWARE_WHIP_NAME[$index_current]='DietPi-Ramlog'
				 aSOFTWARE_WHIP_DESC[$index_current]='minimal, optimized logging'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p68'
		#------------------

		#--------------------------------------------------------------------------------
		#SSH servers (hidden from install menu)
		#--------------------------------------------------------------------------------
		index_current=104

				 aSOFTWARE_WHIP_NAME[$index_current]='Dropbear'
				 aSOFTWARE_WHIP_DESC[$index_current]='ssh server'
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=20#p68'
		#------------------
		index_current=105

				 aSOFTWARE_WHIP_NAME[$index_current]='OpenSSH Server'
				 aSOFTWARE_WHIP_DESC[$index_current]=''
			aSOFTWARE_CATEGORY_INDEX[$index_current]=0
					  aSOFTWARE_TYPE[$index_current]=-1
			 aSOFTWARE_ONLINEDOC_URL[$index_current]='f=8&t=5&start=10#p63'
		#------------------


		#--------------------------------------------------------------------------------
		#Total software installations
		TOTAL_SOFTWARE_INDEXS=${#aSOFTWARE_TYPE[@]}
		#--------------------------------------------------------------------------------
		#Init Installed state - 0=not 1=to be 2=installed
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			aSOFTWARE_INSTALL_STATE[$i]=0

		done

		#Installed software on DietPi image by default.
		aSOFTWARE_INSTALL_STATE[103]=2
		aSOFTWARE_INSTALL_STATE[104]=2
		#--------------------------------------------------------------------------------

	}

	Software_Arrays_Destroy(){

		unset aSOFTWARE_CATEGORIES_DIETPI
		unset aSOFTWARE_CATEGORIES_LINUX

		unset aSOFTWARE_CATEGORY_INDEX
		unset aSOFTWARE_TYPE
		unset aSOFTWARE_WHIP_NAME
		unset aSOFTWARE_WHIP_DESC
		unset aSOFTWARE_ONLINEDOC_URL
		unset aSOFTWARE_INSTALL_STATE

		unset aSOFTWARE_REQUIRES_ALSA
		unset aSOFTWARE_REQUIRES_XSERVERXORG
		unset aSOFTWARE_REQUIRES_MYSQL
		unset aSOFTWARE_REQUIRES_SQLITE
		unset aSOFTWARE_REQUIRES_WEBSERVER
		unset aSOFTWARE_REQUIRES_DESKTOP
		unset aSOFTWARE_REQUIRES_GIT
		unset aSOFTWARE_REQUIRES_BUILDESSENTIAL
		unset aSOFTWARE_REQUIRES_RSYSLOG
		unset aSOFTWARE_REQUIRES_FFMPEG
		unset aSOFTWARE_REQUIRES_ORACLEJAVA
		unset aSOFTWARE_REQUIRES_NODEJS

		unset aSOFTWARE_AVAIL_HW_MODEL
		unset aSOFTWARE_AVAIL_HW_ARCH

	}

	#Work out which additional software we need to install
	Install_Flag_Prereq_Software(){

		/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Checking for prerequisite software"

		#WEBSERVER - Manual stack install
		# - Define extra DietPi install flags for WEBSERVER_STACKS
		#LLAP
		if (( ${aSOFTWARE_INSTALL_STATE[82]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[84]=1
			aSOFTWARE_INSTALL_STATE[88]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LLSP
		if (( ${aSOFTWARE_INSTALL_STATE[81]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[84]=1
			aSOFTWARE_INSTALL_STATE[87]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LLMP
		if (( ${aSOFTWARE_INSTALL_STATE[80]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[84]=1
			aSOFTWARE_INSTALL_STATE[86]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LEAP
		if (( ${aSOFTWARE_INSTALL_STATE[79]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[85]=1
			aSOFTWARE_INSTALL_STATE[88]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LESP
		if (( ${aSOFTWARE_INSTALL_STATE[78]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[85]=1
			aSOFTWARE_INSTALL_STATE[87]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LEMP
		if (( ${aSOFTWARE_INSTALL_STATE[77]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[85]=1
			aSOFTWARE_INSTALL_STATE[86]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LAAP
		if (( ${aSOFTWARE_INSTALL_STATE[76]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[83]=1
			aSOFTWARE_INSTALL_STATE[88]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LASP
		if (( ${aSOFTWARE_INSTALL_STATE[75]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[83]=1
			aSOFTWARE_INSTALL_STATE[87]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#LAMP
		if (( ${aSOFTWARE_INSTALL_STATE[74]} == 1 )); then
			aSOFTWARE_INSTALL_STATE[83]=1
			aSOFTWARE_INSTALL_STATE[86]=1
			aSOFTWARE_INSTALL_STATE[89]=1
		fi

		#WEBSERVER - Auto install via choice system
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_WEBSERVER[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Check for existing webserver base (eg: apache2/nginx) installation
				#FOURDEE: We may want to check dpkg for installed packages also?
				if (( ! ${aSOFTWARE_INSTALL_STATE[83]} &&
					! ${aSOFTWARE_INSTALL_STATE[84]} &&
					! ${aSOFTWARE_INSTALL_STATE[85]} )); then

					# - None found, Select one for Install, based on user preference
					if (( $INDEX_WEBSERVER_TARGET == 0 )); then

						#WEBSERVER_APACHE
						aSOFTWARE_INSTALL_STATE[83]=1
						/DietPi/dietpi/func/dietpi-notify 2 "Apache2 will be installed"

					elif (( $INDEX_WEBSERVER_TARGET == -1 )); then

						#WEBSERVER_NGINX
						aSOFTWARE_INSTALL_STATE[85]=1
						/DietPi/dietpi/func/dietpi-notify 2 "Nginx will be installed"

					elif (( $INDEX_WEBSERVER_TARGET == -2 )); then

						#WEBSERVER_LIGHTTPD
						aSOFTWARE_INSTALL_STATE[84]=1
						/DietPi/dietpi/func/dietpi-notify 2 "Lighttpd will be installed"

					fi

					# - Always install WEBSERVER_PHP
					aSOFTWARE_INSTALL_STATE[89]=1
					/DietPi/dietpi/func/dietpi-notify 2 "PHP will be installed"

				fi

				break

			fi

		done

		#WEBSERVER_MYSQL
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_MYSQL[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Check for existing mysql/mariaDB installations
				if (( ! ${aSOFTWARE_INSTALL_STATE[86]} &&
					! ${aSOFTWARE_INSTALL_STATE[88]} )); then

					#WEBSERVER_MYSQL
					aSOFTWARE_INSTALL_STATE[86]=1

					/DietPi/dietpi/func/dietpi-notify 2 "MySQL will be installed"

				fi

				break

			fi

		done

		#WEBSERVER_SQLITE
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_SQLITE[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				#WEBSERVER_SQLITE
				aSOFTWARE_INSTALL_STATE[87]=1

				/DietPi/dietpi/func/dietpi-notify 2 "SQlite will be installed"

				break

			fi

		done

		#WEBSERVER - Check for stacks and flag as installing
		#WEBSERVER_APACHE
		if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

			#MySQL
			if (( ${aSOFTWARE_INSTALL_STATE[86]} >= 1 )); then

				#WEBSERVER_LAMP
				aSOFTWARE_INSTALL_STATE[74]=1

			fi

			#SQLite
			if (( ${aSOFTWARE_INSTALL_STATE[87]} >= 1 )); then

				#WEBSERVER_LASP
				aSOFTWARE_INSTALL_STATE[75]=1

			fi

			#MariaDB
			if (( ${aSOFTWARE_INSTALL_STATE[88]} >= 1 )); then

				#WEBSERVER_LAAP
				aSOFTWARE_INSTALL_STATE[76]=1

			fi


		#WEBSERVER_NGINX
		elif (( ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

			#MySQL
			if (( ${aSOFTWARE_INSTALL_STATE[86]} >= 1 )); then

				#WEBSERVER_LEMP
				aSOFTWARE_INSTALL_STATE[77]=1

			fi

			#SQLite
			if (( ${aSOFTWARE_INSTALL_STATE[87]} >= 1 )); then

				#WEBSERVER_LESP
				aSOFTWARE_INSTALL_STATE[78]=1

			fi

			#MariaDB
			if (( ${aSOFTWARE_INSTALL_STATE[88]} >= 1 )); then

				#WEBSERVER_LEAP
				aSOFTWARE_INSTALL_STATE[79]=1

			fi

		#WEBSERVER_LIGHTTPD
		elif (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 )); then

			#MySQL
			if (( ${aSOFTWARE_INSTALL_STATE[86]} >= 1 )); then

				#WEBSERVER_LLMP
				aSOFTWARE_INSTALL_STATE[80]=1

			fi

			#SQLite
			if (( ${aSOFTWARE_INSTALL_STATE[87]} >= 1 )); then

				#WEBSERVER_LLSP
				aSOFTWARE_INSTALL_STATE[81]=1

			fi

			#MariaDB
			if (( ${aSOFTWARE_INSTALL_STATE[88]} >= 1 )); then

				#WEBSERVER_LLAP
				aSOFTWARE_INSTALL_STATE[82]=1

			fi


		fi

		#DESKTOP
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_DESKTOP[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - If no desktop is selected or installed (0), default to LXDE
				if (( ! ${aSOFTWARE_INSTALL_STATE[23]} &&
					! ${aSOFTWARE_INSTALL_STATE[24]} &&
					! ${aSOFTWARE_INSTALL_STATE[25]} &&
					! ${aSOFTWARE_INSTALL_STATE[26]} )); then

					aSOFTWARE_INSTALL_STATE[23]=1
					/DietPi/dietpi/func/dietpi-notify 2 "LXDE desktop will be installed"

				fi

				break

			fi

		done

		#GIT
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_GIT[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[17]=1

				/DietPi/dietpi/func/dietpi-notify 2 "Git will be installed"

				break

			fi

		done

		#BUILDESSENTIAL
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_BUILDESSENTIAL[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[16]=1

				/DietPi/dietpi/func/dietpi-notify 2 "Build-Essential will be installed"

				break

			fi

		done

		#RSYSLOG
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_RSYSLOG[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[102]=1

				/DietPi/dietpi/func/dietpi-notify 2 "Rsyslog will be installed"

				break

			fi

		done

		#FFMPEG
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_FFMPEG[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[7]=1

				/DietPi/dietpi/func/dietpi-notify 2 "FFmpeg will be installed"

				break

			fi

		done

		#ORACLEJAVA
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_ORACLEJAVA[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[8]=1

				/DietPi/dietpi/func/dietpi-notify 2 "Oracle Java will be installed"

				break

			fi

		done

		#NODEJS
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_NODEJS[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[9]=1

				/DietPi/dietpi/func/dietpi-notify 2 "NodeJS will be installed"

				break

			fi

		done

		#ALSA
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_ALSA[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[5]=1

				/DietPi/dietpi/func/dietpi-notify 2 "Alsa will be installed"

				break

			fi

		done

		#XSERVERXORG
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_REQUIRES_XSERVERXORG[$i]} &&
				${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# - Flag for install
				aSOFTWARE_INSTALL_STATE[6]=1

				/DietPi/dietpi/func/dietpi-notify 2 "Xserver will be installed"

				break

			fi

		done

	}

	Create_Desktop_Shared_Items(){

		#Copy DietPi favourite links
		cp /DietPi/dietpi/conf/desktop/.gtk-bookmarks "$HOME"/.gtk-bookmarks

		#Create Desktop SymLinks
		mkdir -p "$HOME"/Desktop
		ln -sf /usr/share/applications/htop.desktop "$HOME"/Desktop/htop.desktop

		#DietPi Desktop symlinks
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-software.desktop "$HOME"/Desktop/dietpi-software.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-config.desktop "$HOME"/Desktop/dietpi-config.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-launcher.desktop "$HOME"/Desktop/dietpi-launcher.desktop

		#DietPi Menu symlinks
		mkdir -p /usr/share/applications
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-software.desktop /usr/share/applications/dietpi-software.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-update.desktop /usr/share/applications/dietpi-update.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-config.desktop /usr/share/applications/dietpi-config.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-uninstall.desktop /usr/share/applications/dietpi-uninstall.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-backup.desktop /usr/share/applications/dietpi-backup.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-sync.desktop /usr/share/applications/dietpi-sync.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-bugreport.desktop /usr/share/applications/dietpi-bugreport.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-cleaner.desktop /usr/share/applications/dietpi-cleaner.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-cron.desktop /usr/share/applications/dietpi-cron.desktop
		ln -sf /DietPi/dietpi/conf/desktop/dietpi-launcher.desktop /usr/share/applications/dietpi-launcher.desktop

		# - Set execute to prevent "untrusted" prompt in Mate, and possibily other desktops.
		chmod +x /usr/share/applications/*

	}

	Create_UserContent_Folders(){

		mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/"$FOLDER_MUSIC" &> /dev/null
		mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/"$FOLDER_PICTURES" &> /dev/null
		mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/"$FOLDER_VIDEO" &> /dev/null
		mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/"$FOLDER_DOWNLOADS" &> /dev/null

	}

	Download_Test_Media(){

		if [ ! -f "$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"/fourdee_tech.ogg ]; then

			#Grab My test music
			wget http://dietpi.com/downloads/audio/fourdee_tech.ogg -O "$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"/fourdee_tech.ogg

			#Grab Absolute Radio Streams
			wget http://network.absoluteradio.co.uk/core/audio/ogg/live.pls?service=vrbb -O "$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"/Absolute-Radio.pls
			wget http://network.absoluteradio.co.uk/core/audio/ogg/live.pls?service=a8bb -O "$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"/Absolute-Radio-80s.pls
			wget http://network.absoluteradio.co.uk/core/audio/ogg/live.pls?service=a9bb -O "$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"/Absolute-Radio-90s.pls
			wget http://network.absoluteradio.co.uk/core/audio/ogg/live.pls?service=a0bb -O "$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"/Absolute-Radio-00s.pls

		fi

	}

	#apt-get install
	AGI(){

		local string="$@"
		DEBIAN_FRONTEND=noninteractive apt-get install -y --force-yes $string

		local result=$?
		if (( $result != 0 )); then

			Error_AptGet_Failed

		fi

	}

	#apt-get purge
	AGP(){

		local string="$@"
		apt-get purge -y $string

	}

	#apt-get install -f
	AGF(){

		DEBIAN_FRONTEND=noninteractive apt-get install -f -y --force-yes

		local result=$?
		if (( $result != 0 )); then

			Error_AptGet_Failed

		fi

	}

	#Return optimization values for BitTorrent servers based on device and hardware capabilities.
	Optimize_BitTorrent(){

		local output=0

		local gigabit_device=1
		# - Lets hope the next RPi device is finally gigabit capable. I'll cry if it is not.
		if (( $HW_MODEL <= 3 || $HW_MODEL == 30 || $HW_MODEL == 40 || $HW_MODEL == 60 )); then

			gigabit_device=0

		fi

		#Cache size (MB) 1/7th of total mem
		if (( $1 == 0 )); then

			output=$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 7 ))

		#Max active downloads
		elif (( $1 == 1 )); then

			output=2

			# - Bump up for VM's
			if (( $HW_MODEL == 20 )); then

				output=3

			fi

		#Max global connections
		elif (( $1 == 2 )); then

			output=20

			# - Bump up for VM's
			if (( $HW_MODEL == 20 )); then

				output=40

			# - 1Gbit SBC's
			elif (( $gigabit_device )); then

				output=30

			# - Reduce for RPi's. This is due to the USB bus ethernet in the ARM SoC, which cripples network throughput/performance/latency.
			# - RPi v3
			elif (( $HW_MODEL == 3 )); then

				output=15

			# - RPi v2
			elif (( $HW_MODEL == 2 )); then

				output=13

			# - RPi v1 256/512
			elif (( $HW_MODEL <= 1 )); then

				output=7

			fi

		#Max upload slots
		elif (( $1 == 3 )); then

			output=3

			# - Bump up for VM's
			if (( $HW_MODEL == 20 )); then

				output=5

			# - 1Gbit devices
			elif (( $gigabit_device )); then

				output=4

			# - Reduce for RPi's. This is due to the USB bus ethernet in the ARM SoC, which cripples network throughput/performance/latency.
			elif (( $HW_MODEL <= 3 )); then

				output=2

			fi

		fi

		echo $output

	}

	Install_Dietpi_Software(){

		#--------------------------------------------------------------
		#Install Software

		#Desktop LXDE
		INSTALLING_INDEX=23
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI lxde upower policykit-1 iceweasel p7zip-full --no-install-recommends
			#upower policykit-1. Needed for LXDE logout menu item to show shutdown/restart ......

		fi

		#Desktop MATE
		INSTALLING_INDEX=24
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI mate-desktop-environment-extras upower policykit-1 iceweasel p7zip-full --no-install-recommends

		fi

		#Desktop GNUStep
		INSTALLING_INDEX=26
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI x-window-system-core wmaker gnustep gnustep-devel gnustep-games libc-dbg upower policykit-1 iceweasel p7zip-full --no-install-recommends

		fi

		#DESKTOP_XFCE
		INSTALLING_INDEX=25
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI xfce4 xfce4-terminal gnome-icon-theme tango-icon-theme iceweasel p7zip-full --no-install-recommends

		fi

		#XRDP
		INSTALLING_INDEX=29
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI xrdp

		fi

		#NOMACHINE
		INSTALLING_INDEX=30
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			INSTALL_DESCRIPTION="NoMachine (Secure RDP Server & Client)"

			#x86_64
			if (( $HW_ARCH == 21 )); then
				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/nomachine_5.1.44_1_amd64.deb'
			#arm6 (RPi1)
			elif (( $HW_ARCH == 1 )); then
				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/nomachine_5.1.44_3_armv6hf.deb'
			#arm7+ (RPi 2/3)
			elif (( $HW_ARCH >= 2 && $HW_ARCH < 10 )); then
				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/nomachine_5.1.44_1_armhf.deb'
			fi

			# Now, check that the links are legitimate
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#BitTorrent Transmission
		INSTALLING_INDEX=44
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI transmission-daemon

		fi

		#ProFTPd
		INSTALLING_INDEX=94
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			echo -e "proftpd-basic shared/proftpd/inetd_or_standalone select standalone" | debconf-set-selections
			AGI proftpd-basic

		fi

		#Samba Server
		INSTALLING_INDEX=96
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI samba samba-common-bin --no-install-recommends

		fi

		#vsFTPD
		INSTALLING_INDEX=95
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI vsftpd --no-install-recommends

		fi

		#NFS_SERVER
		INSTALLING_INDEX=109
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI nfs-kernel-server nfs-common ucf rpcbind

		fi

		#WEBSERVER_APACHE
		INSTALLING_INDEX=83
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI apache2

		fi

		#WEBSERVER_NGINX
		INSTALLING_INDEX=85
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI nginx xml-core --no-install-recommends

		fi

		#WEBSERVER_LIGHTTPD
		INSTALLING_INDEX=84
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI lighttpd

		fi


		#WEBSERVER_MYSQL
		INSTALLING_INDEX=86
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			echo -e "mysql-server mysql-server/root_password password dietpi" | debconf-set-selections
			echo -e "mysql-server mysql-server/root_password_again password dietpi" | debconf-set-selections

			AGI mysql-server mysql-client

			# Fix depricated key_buffer -> key_buffer_size per MySQL 5.x notification
			sed -i 's/^key_buffer[[:space:]]/key_buffer_size /g' /etc/mysql/my.cnf

			# Restart the service and install the client
			service mysql restart

		fi

		#WEBSERVER_MARIADB
		INSTALLING_INDEX=88
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			echo -e "mysql-server mysql-server/root_password password dietpi" | debconf-set-selections
			echo -e "mysql-server mysql-server/root_password_again password dietpi" | debconf-set-selections

			AGI mariadb-server mariadb-client

		fi

		#WEBSERVER_SQLITE
		INSTALLING_INDEX=87
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI sqlite3

		fi

		#WEBSERVER_REDIS
		INSTALLING_INDEX=91
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI redis-server

		fi

		#WEBSERVER_PHP
		INSTALLING_INDEX=89
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Install base PHP packages/modules.
			if (( ${aSOFTWARE_INSTALL_STATE[83]} == 1 )); then

				AGI php5 libapache2-mod-php5

			else

				AGI php5-fpm php5-cgi php5-xsl

			fi

			#php-SQL modules
			if (( ${aSOFTWARE_INSTALL_STATE[86]} == 1 )); then

				AGI php5-mysql

			elif (( ${aSOFTWARE_INSTALL_STATE[88]} == 1 )); then

				AGI php5-mysqlnd

			fi

			if (( ${aSOFTWARE_INSTALL_STATE[87]} == 1 )); then

				AGI php5-sqlite

			fi

			#Redis php5 module | >= 1 to check for existing installs (2)
			if (( ${aSOFTWARE_INSTALL_STATE[91]} >= 1 )); then

				AGI php5-redis

			fi

			#Jessie - APCu
			AGI php5-apcu

		fi

		#WEBSERVER_MYADMINPHP
		INSTALLING_INDEX=90
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Mysql must be running during install to allow debconf setup.
			service mysql restart

			# Set password parameters before installing
			echo "phpmyadmin phpmyadmin/dbconfig-install boolean true" | debconf-set-selections
			echo "phpmyadmin phpmyadmin/app-password-confirm password dietpi" | debconf-set-selections
			echo "phpmyadmin phpmyadmin/mysql/admin-pass password dietpi" | debconf-set-selections
			echo "phpmyadmin phpmyadmin/mysql/app-pass password dietpi" | debconf-set-selections

			if (( ${aSOFTWARE_INSTALL_STATE[83]} == 1 )); then

				echo "phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2" | debconf-set-selections

			elif (( ${aSOFTWARE_INSTALL_STATE[84]} == 1 )); then

				echo "phpmyadmin phpmyadmin/reconfigure-webserver multiselect lighttpd" | debconf-set-selections

			else

				echo "phpmyadmin phpmyadmin/reconfigure-webserver multiselect none" | debconf-set-selections

			fi

			AGI phpmyadmin
		fi

		#Forums PHPBB
		INSTALLING_INDEX=54
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://www.phpbb.com/files/release/phpBB-3.1.6.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www
				rm package.zip

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#OPENBAZAAR
		INSTALLING_INDEX=58
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/OpenBazaar/OpenBazaar-Server.git'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			#Install

			if (( $? == 0 )); then

				AGI libsodium-dev automake autoconf pkg-config libtool libssl-dev libffi-dev python-dev openssl python-pip libzmq3-dev

				#Not required.
				#AGI software-properties-common
				#add-apt-repository -y ppa:chris-lea/libsodium
				#apt-get update

				pip install cryptography


				cd "$HOME"
				git clone --depth 1 https://github.com/zeromq/libzmq
				git clone --depth 1 https://github.com/pyca/pynacl/
				git clone --depth 1 "$INSTALL_URL_ADDRESS"

				# - compile
				cd "$HOME"/libzmq
				./autogen.sh && ./configure && make -j "$(nproc --all)"
				make check && make install && ldconfig

				cd "$HOME"/pynacl
				python setup.py build && python setup.py install

				cd "$HOME"

				# - Move OpenBazaar to a 'better' location
				mkdir -p /etc/openbazaar-server
				mv "$HOME"/OpenBazaar-Server/* /etc/openbazaar-server/
				rm -R "$HOME"/OpenBazaar-Server

				# - install OpenBazaar
				cd /etc/openbazaar-server
				pip install -r requirements.txt

				cd "$HOME"

				# - Clean up, remove source libaries
				rm -R "$HOME"/libzmq
				rm -R "$HOME"/pynacl


			else

				Error_NoConnection_NoInstall

			fi

		fi


		#OwnCloud
		INSTALLING_INDEX=47
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://download.owncloud.org/download/repositories/stable/Debian_8.0/Release.key'

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			#Install
			if (( $? == 0 )); then

				if [ ! -f /etc/apt/sources.list.d/owncloud.list ]; then

					wget "$INSTALL_URL_ADDRESS" -O owncloud.key
					apt-key add - < owncloud.key
					rm owncloud.key

					echo -e "deb http://download.owncloud.org/download/repositories/stable/Debian_8.0/ /" > /etc/apt/sources.list.d/owncloud.list

					apt-get update

				fi

				AGI owncloud

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#NextCloud
		INSTALLING_INDEX=114
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://download.nextcloud.com/server/releases/nextcloud-10.0.0.zip'

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			#Install
			if (( $? == 0 )); then

				AGI php5-curl php5-gd

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www
				rm package.zip

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#Hifi
		INSTALLING_INDEX=32
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#ympd
			# - armhf
			if (( $HW_ARCH >= 1 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS='http://www.ympd.org/downloads/ympd-1.2.3-armhf.tar.bz2'

			# - arm64
			elif (( $HW_ARCH >= 10 && $HW_ARCH < 20 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/ympd-1.2.3-arm64.tar.bz2'

			fi
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				#Install ympd
				wget "$INSTALL_URL_ADDRESS"
				tar -xvf ympd-*
				rm ympd-*
				mv ympd /usr/bin/ympd

				#Install MPD
				AGI libmpdclient2

				# - arm64
				if (( $HW_ARCH >= 10 && $HW_ARCH < 20 )); then

					# - additional preqs
					#AGI libsmbclient libcurl4-gnutls-dev libmodplug1 libfaad2 libmpcdec6 libavformat56 libupnp6 libnfs4 libflac8 libyajl2 libvorbisfile3 libsndfile1 libaudiofile1 libgme0 libsidplay2 libresid-builder0c2a libsidutils0 libfluidsynth1 libWildMidi1 libwavpack1 libmad0 libmpg123-0

					# - Install same dev packages as per a compile to ensure libary's are available.
					AGI libmad0-dev libmpg123-dev libid3tag0-dev libflac-dev libvorbis-dev libopus-dev libaudiofile-dev libsndfile1-dev libfaad-dev libfluidsynth-dev libgme-dev libmikmod2-dev libmodplug-dev libmpcdec-dev libwavpack-dev libwildmidi-dev libsidplay2-dev libsidutils-dev libresid-builder-dev libavcodec-dev libavformat-dev libmp3lame-dev libsamplerate0-dev libsoxr-dev libbz2-dev libcdio-paranoia-dev libiso9660-dev libmms-dev libzzip-dev libcurl4-gnutls-dev libyajl-dev libexpat-dev libasound2-dev libao-dev libjack-jackd2-dev libopenal-dev libpulse-dev libroar-dev libshout3-dev libnfs-dev libsmbclient-dev libupnp-dev libavahi-client-dev libsqlite3-dev libsystemd-daemon-dev libwrap0-dev libcppunit-dev xmlto libboost-dev libicu-dev

					wget http://dietpi.com/downloads/binaries/all/mpd_0.19.16_arm64.deb -O package.deb
					dpkg -i package.deb
					rm package.deb

				# - everything else
				else

					AGI mpd

				fi


			else

				Error_NoConnection_NoInstall

			fi

		fi

		#Kodi
		INSTALLING_INDEX=31
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Odroids
			if (( $HW_MODEL >= 10 )) && (( $HW_MODEL < 20 )); then

				AGI kodi-odroid

				#XU4 - requires pulse audio (fixes corrupt sound)
				if (( $HW_MODEL == 11 )); then

					AGI pulseaudio --no-install-recommends

				fi

			#Everything else
			else

				AGI kodi

			fi

			#libcurl3-gnutls required for C2. But lets apply to all: https://github.com/Fourdee/DietPi/issues/446
			AGI libcurl3-gnutls

			# - Add NFS support for kodi
			AGI libnfs4

		fi

		#MINIDLNA
		INSTALLING_INDEX=39
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI minidlna

		fi

		#NoIp
		INSTALLING_INDEX=67
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#x32 x64
			if (( $HW_MODEL == 20 )); then

				INSTALL_URL_ADDRESS="http://dietpi.com/downloads/binaries/all/noip_x32_x64.zip"

			#arm64
			elif (( ( $HW_MODEL == 12 ) || ( $HW_MODEL >=40 && $HW_MODEL < 50 ) )); then

				INSTALL_URL_ADDRESS="http://dietpi.com/downloads/binaries/all/noip_arm64.zip"

			#armv6+
			else

				INSTALL_URL_ADDRESS="http://dietpi.com/downloads/binaries/all/noip_armhf.zip"

			fi
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				#NoIp Binary install
				wget "$INSTALL_URL_ADDRESS" -O dietpi-noip.zip
				unzip dietpi-noip.zip
				rm dietpi-noip.zip
				mv noip_binary /usr/local/bin/noip2
				chmod +x /usr/local/bin/noip2

				#noip2 service file
				cp /DietPi/dietpi/conf/noip_init /etc/init.d/noip2
				chmod +x /etc/init.d/noip2
				update-rc.d noip2 defaults

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#uae4arm
		INSTALLING_INDEX=108
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/uae4arm-rpi_v2.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				AGI alsa-oss joystick libsdl-image1.2 libsdl-ttf2.0-0 libsdl-gfx1.2-5 libguichan-0.8.1-1 libguichan-allegro-0.8.1-1 libguichan-sdl-0.8.1-1 libguichan-opengl-0.8.1-1 libjpgalleg4.4 libxml2 libmpg123-0

				#Download binaries
				# - Backup existing autostart.uae for user
				mv "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/conf/autostart.uae "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/conf/autostart_pre-dietpi-update.uae &> /dev/null

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip -o package.zip -d /etc
				rm package.zip

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#dxx-rebirth
		INSTALLING_INDEX=112
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/rpi/dxx-rebirth.7z'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				AGI libsdl-mixer1.2 libsdl1.2debian libphysfs1

				wget "$INSTALL_URL_ADDRESS" -O package.7z
				7z x -aoa package.7z -o"$FP_DIETPI_USERDATA_DIRECTORY"
				rm package.7z

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#urbackup server
		INSTALLING_INDEX=111
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			if (( $HW_ARCH == 21 )); then

				INSTALL_URL_ADDRESS="http://hndl.urbackup.org/Server/2.0.34/urbackup-server_2.0.34_amd64.deb"

			elif (( $HW_ARCH >= 1 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS="http://hndl.urbackup.org/Server/2.0.34/urbackup-server_2.0.34_armhf.deb"

			#ARM64 sourcebuild
			elif (( $HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS="http://hndl.urbackup.org/Server/2.0.34/urbackup-server-2.0.34.tar.gz"

			fi


			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then


				#ARM64 source build
				if (( $HW_ARCH == 10 )); then

					AGI build-essential zlib1g-dev libcurl4-openssl-dev libcrypto++-dev

					wget "$INSTALL_URL_ADDRESS" -O package.tar
					tar xzvf package.tar
					rm package.tar

					cd urbackup-server-*

					./configure
					make -j $(nproc --all)
					make install

					sed -i "/ExecStart=/c ExecStart=/usr/local/bin/urbackupsrv run --config /etc/default/urbackupsrv --no-consoletime" urbackup-server.service
					cp urbackup-server.service /etc/systemd/system/urbackupsrv.service
					cp defaults_server /etc/default/urbackupsrv
					cp logrotate_urbackupsrv /etc/logrotate.d/urbackupsrv

					cd ..

					rm -R urbackup-server-*

				#Deb
				else

					wget "$INSTALL_URL_ADDRESS" -O package.deb

					echo -e "urbackup-server urbackup/backuppath string $FP_DIETPI_USERDATA_DIRECTORY/urbackup" | debconf-set-selections
					dpkg -i package.deb

					apt-get -f install -y

					rm package.deb

				fi

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#OpenTyrian
		INSTALLING_INDEX=51
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS="http://dietpi.com/downloads/binaries/rpi/opentyrian_armhf.zip"
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				AGI ibsdl1.2debian libsdl-net1.2 --no-install-recommends

				#Download binaries
				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /
				rm package.zip
				chmod +x /usr/local/games/opentyrian/opentyrian

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#DietPi Cam
		INSTALLING_INDEX=59
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='https://github.com/Fourdee/RPi_Cam_Web_Interface/archive/6.1.6.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				#Install pre-reqs
				AGI gpac motion

				#Get source/binaries and extract
				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				rm package.zip

				#work form inside RPi_Cam folder
				cd RPi_Cam*

				#Config /etc/motion
				mkdir -p /etc/motion
				cp etc/motion/motion.conf.1 /etc/motion/motion.conf

				#Config /etc/raspimjpeg
				cp etc/raspimjpeg/raspimjpeg.1 /etc/raspimjpeg

				#Setup /var/www/dietpicam
				mkdir -p /var/www/dietpicam/media
				cp -R www/* /var/www/dietpicam/
				chmod +x /var/www/dietpicam/raspizip.sh
				mknod /var/www/dietpicam/FIFO p
				mknod /var/www/dietpicam/FIFO1 p

				#Temp cam.jpg file symlink
				ln -sf /run/shm/mjpeg/cam.jpg /var/www/dietpicam/cam.jpg

				#Setup Raspimjpeg binary
				cp bin/raspimjpeg /opt/vc/bin/raspimjpeg
				chmod +x /opt/vc/bin/raspimjpeg
				ln -s /opt/vc/bin/raspimjpeg /usr/bin/raspimjpeg

				#Cleanup / remove extracted source
				cd "$HOME"/
				rm -R "$HOME"/RPi_Cam*

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#DELUGE
		INSTALLING_INDEX=45
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI deluged deluge-web deluge-webui deluge-console

		fi

		#GRASSHOPPER
		INSTALLING_INDEX=100
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI python

			#Download Grasshopper
			local grasshopper_directory='/var/www'
			INSTALL_URL_ADDRESS='http://sourceforge.net/projects/grasshopperwebapp/files/grasshopper_v5_application.zip/download'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O grasshopper.zip
				unzip grasshopper.zip -d "$grasshopper_directory"
				rm grasshopper.zip

				#Install
				chmod +x "$grasshopper_directory"/install/install.sh
				"$grasshopper_directory"/install/install.sh

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#RASPCONTROL
		INSTALLING_INDEX=106
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/harmon25/raspcontrol/archive/master.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip

				unzip package.zip
				rm package.zip
				mkdir -p /var/www/raspcontrol
				mv raspcontrol-master/* /var/www/raspcontrol
				rm -R raspcontrol-master

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#WEBMIN
		INSTALLING_INDEX=115
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://www.webmin.com/download/deb/webmin-current.deb'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb

				AGF

				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#LINUXDASH
		INSTALLING_INDEX=63
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/afaqurk/linux-dash/archive/master.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip

				unzip package.zip
				rm package.zip
				mkdir -p /var/www/linuxdash
				mv linux-dash-master/* /var/www/linuxdash
				rm -R linux-dash-master

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#PIHOLE
		INSTALLING_INDEX=93
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			# local git_version='master'
			# local git_owner='pi-hole'
			local git_version='04_09_2016'
			local git_owner='Fourdee'

			# - Web stats
			INSTALL_URL_ADDRESS="https://github.com/$git_owner/AdminLTE/archive/$git_version.zip"
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				#Install

				AGI dnsmasq bc
				service dnsmasq stop

				#Generate PiHole Dirs
				mkdir -p /etc/pihole
				mkdir -p /etc/.pihole #gravity always wants to read from the "temp" installation folder used by their install script.
				mkdir -p /opt/pihole
				# - reinstall: Always remove existing pihole dashboard dir
				rm -R /var/www/pihole
				mkdir -p /var/www/pihole

				#Grab/Setup Web interface panel
				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				mv AdminLTE-*/* /var/www/pihole/
				rm -R AdminLTE-*
				rm package.zip

				# - Grab chronometer (this script is run to parse logfiles for PiHole webpage stats)
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/advanced/Scripts/chronometer.sh -O /usr/local/bin/chronometer.sh
				chmod +x /usr/local/bin/chronometer.sh

				# - Blacklist/whitelist scripts
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/advanced/Scripts/blacklist.sh -O /opt/pihole/blacklist.sh
				chmod +x /opt/pihole/blacklist.sh

				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/advanced/Scripts/whitelist.sh -O /opt/pihole/whitelist.sh
				chmod +x /opt/pihole/whitelist.sh

				# - update dashboard
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/advanced/Scripts/updateDashboard.sh -O /opt/pihole/updateDashboard.sh
				#chmod +x /opt/pihole/updateDashboard.sh #Disabled as it wants to install Git and expects official installation method.

				# - Default ads list
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/adlists.default -O /etc/pihole/adlists.default
				cp /etc/pihole/adlists.default /etc/.pihole/adlists.default

				#Check free available memory. Increase swapfile size to prevent gravity running out of mem.
				if (( $(free -m -o | grep -m1 'Mem:' | awk '{print $4}') < 512 )); then

					if [ -f /etc/dphys-swapfile ] &&
						(( $(cat /etc/dphys-swapfile | grep 'CONF_SWAPSIZE=' | sed 's/.*=//') < 512 )); then

						/DietPi/dietpi/func/dietpi-notify 2 "Increasing swapfile size to 512MB before running gravity.sh, please wait...\n"
						/DietPi/dietpi/func/dietpi-set_dphys-swapfile 512

					fi

				fi

				#Run and update adblocking databases (gravity)
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/gravity.sh -O /usr/local/bin/gravity.sh
				chmod 755 /usr/local/bin/gravity.sh
				/usr/local/bin/gravity.sh
				killall -w dnsmasq # gravity.sh restarts dnsmasq and creates a brief temp loss of connection. So lets kill the process and wait for it to terminate.
				ln -sf /usr/local/bin/gravity.sh /opt/pihole/gravity.sh #symlink to new location of script. We still use the old location for docs and cron

				#bash completion for pihole bin
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/advanced/bash-completion/pihole -O /etc/bash_completion.d/pihole
				. /etc/bash_completion.d/pihole

				#Pihole bin
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/pihole -O /usr/local/bin/pihole
				chmod +x /usr/local/bin/pihole

				#Pihole sudoers (to allow web interface access to pihole bin and add/remove white/black lists)
				mkdir -p /etc/sudoers.d
				wget https://raw.githubusercontent.com/"$git_owner"/pi-hole/"$git_version"/advanced/pihole.sudo -O /etc/sudoers.d/pihole
				chmod 0440 /etc/sudoers.d/pihole

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#SUBSONIC 5
		INSTALLING_INDEX=33
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://sourceforge.net/projects/subsonic/files/subsonic/5.3/subsonic-5.3.deb/download'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				AGI lame

				#Install SubSonic 5.3
				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#SUBSONIC 6
		INSTALLING_INDEX=34
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://sourceforge.net/projects/subsonic/files/subsonic/6.0/subsonic-6.0.deb/download'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				AGI lame

				#Install SubSonic 6.0
				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#WEAVED
		INSTALLING_INDEX=68
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='https://github.com/weaved/installer/raw/master/binaries/weaved-nixinstaller_1.2.13.bin'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				#Install WEAVED
				wget "$INSTALL_URL_ADDRESS" -O weaved_setup.bin
				chmod +x weaved_setup.bin

				##Dont run this, let the user run it for "1st time setup"
				#./weaved_setup.bin

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#WEBIOPI requires RPIGPIO
		if (( ${aSOFTWARE_INSTALL_STATE[71]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[69]=1

		fi

		#RPIGPIO
		INSTALLING_INDEX=69
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			# >= v111 image
			if [ -f /etc/.dietpi_image_version ]; then

				AGI python-rpi.gpio python3-rpi.gpio

			# - < v111 Bug in older DietPi images with sources.list | Use pip, as offical repo = python3-rpi.gpio: Depends: python3 (< 3.3) but 3.4.2-2 is to be installed
			else

				AGI python3-pip
				pip3 install RPi.GPIO

			fi

		fi

		#WIRINGPI
		INSTALLING_INDEX=70
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online | http://git.drogon.net/?p=wiringPi;a=shortlog;h=refs/heads/master snapshot
			INSTALL_URL_ADDRESS='http://git.drogon.net/?p=wiringPi;a=snapshot;h=HEAD;sf=tgz'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.tar
				tar xfz package.tar
				rm package.tar
				cd wiringPi*
				./build
				cd ..
				#rm -R /root/wiringPi* #Also Contains example code for users.

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#RPII2C
		INSTALLING_INDEX=72
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			/DietPi/dietpi/func/dietpi-set_hardware i2c enable

		fi

		#WEBIOPI
		INSTALLING_INDEX=71
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://sourceforge.net/projects/webiopi/files/WebIOPi-0.7.1.tar.gz/download'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			if (( $? == 0 )); then

				#Python dev, pre-reqs
				AGI python-dev python-setuptools --no-install-recommends

				#Install WEBIOPI
				wget "$INSTALL_URL_ADDRESS" -O package.tar
				tar xvzf package.tar
				rm package.tar

				cd WebIOPi*

				#Automate Weaved prompt
				sed -i '/read response/c\response="n"' setup.sh

				#Run setup script
				./setup.sh
				clear

				cd ..

				#Cleanup
				rm -R WebIOPi*

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#DIETPICLOUDSHELL
		INSTALLING_INDEX=62
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI net-tools

			#LCD panels can be enabled in Dietpi-config > display options

		fi

		#HAPROXY
		INSTALLING_INDEX=98
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='http://www.haproxy.org/download/1.6/src/haproxy-1.6.9.tar.gz'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				#Download HAPROXY
				wget "$INSTALL_URL_ADDRESS" -O package.tar
				tar -xvf package.tar
				rm package.tar

				cd haproxy-*

				#Pre-reqs
				AGI libpcre3-dev libssl-dev
				#Compile and install
				make -j "$(nproc --all)" TARGET=linux2628 CPU=generic USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_LINUX_SPLICE=1
				make install

				mkdir /etc/haproxy

				#Exit directory
				cd ..

				#Clean up
				rm -R haproxy-*

				#Install init script as service
				cp /DietPi/dietpi/conf/haproxy_init /etc/init.d/haproxy
				chmod +x /etc/init.d/haproxy
				update-rc.d haproxy defaults

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#SQUEEZEBOXSERVER
		INSTALLING_INDEX=35
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/logitechmediaserver_7.9.0_all.deb'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

				#Stop service
				service logitechmediaserver stop

				# + ARMv6 cpan
				if (( $HW_ARCH == 1 )); then

					wget http://dietpi.com/downloads/binaries/all/logitechmediaserver_7.9.0_CPAN_5.20_armv6hf.tar.gz -O package.tar
					tar xvzf package.tar -C /
					rm package.tar

				# + ARM64 cpan
				elif (( $HW_ARCH == 10 )); then

					AGI libxml-parser-perl
					AGI zlib1g-dev libjpeg-dev libpng-dev # shared libs needed for Image::Scale@0.08

					wget http://dietpi.com/downloads/binaries/all/DietPi-LMS7.9-CPAN_arm64.zip -O package.zip
					unzip -o package.zip -d /usr/share/squeezeboxserver
					rm package.zip

				fi

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#WORDPRESS
		INSTALLING_INDEX=55
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='https://wordpress.org/latest.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www/
				rm package.zip

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#TIGHTVNCSERVER
		INSTALLING_INDEX=27
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI tightvncserver --no-install-recommends

		fi

		#VNC4SERVER
		INSTALLING_INDEX=28
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI vnc4server --no-install-recommends

		fi

		#FAIL2BAN
		INSTALLING_INDEX=73
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI fail2ban --no-install-recommends

		fi

		#PHPSYSINFO
		INSTALLING_INDEX=64
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='https://github.com/phpsysinfo/phpsysinfo/archive/master.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www/
				rm package.zip
				mv /var/www/phpsysinfo-* /var/www/phpsysinfo

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#PHPIMAGEGALLERY
		INSTALLING_INDEX=56
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/Single_File_PHP_Gallery_4.6.1.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				AGI php5-gd
				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www/gallery
				rm package.zip

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#AMPACHE
		INSTALLING_INDEX=40
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='https://github.com/ampache/ampache/archive/master.zip'

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				AGI php5-curl

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				rm package.zip
				mv ampache-* /var/www/ampache

				#composer install required for 3.8.2
				php -r "readfile('https://getcomposer.org/installer');" > composer-setup.php
				php composer-setup.php
				php -r "unlink('composer-setup.php');"

				mv composer.phar /usr/local/bin/composer

				cd /var/www/ampache
				composer install --prefer-source --no-interaction
				cd ~/

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#OPENVPNSERVER
		INSTALLING_INDEX=97
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI openvpn easy-rsa iptables

		fi

		#LETSENCRYPT
		INSTALLING_INDEX=92
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			INSTALL_URL_ADDRESS='https://github.com/certbot/certbot/archive/master.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /root
				rm package.zip
				mv certbot* /etc/certbot_scripts

				# - Install packages
				cd /etc/certbot_scripts
				./certbot-auto -n --os-packages-only
				cd ~/

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#TORHOTSPOT requires WIFIHOTSPOT:
		if (( ${aSOFTWARE_INSTALL_STATE[61]} == 1 )); then

			aSOFTWARE_INSTALL_STATE[60]=1

		fi

		#WIFIHOTSPOT
		INSTALLING_INDEX=60
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/hostapd_2.5_all.zip'

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				# - Prereqs
				AGI hostapd isc-dhcp-server iptables libnl-3-200

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				rm package.zip

				# - Check for RTL8188C* device, use the patched binary I compiled: https://github.com/pritambaral/hostapd-rtl871xdrv#why
				if (( $(lsusb | grep -ci -m1 'RTL8188C') )); then

					WIFIHOTSPOT_RTL8188C_DEVICE=1

				fi

				#Which binary to install
				local filename_hostapd=''
				local filename_hostapd_cli=''

				# - armv6
				if (( $HW_ARCH == 1 )); then

					filename_hostapd='hostapd-nl80211-armv6'
					filename_hostapd_cli='hostapd_cli-armv6'

					if (( $WIFIHOTSPOT_RTL8188C_DEVICE )); then

						filename_hostapd='hostapd-rtl8188c-armv6'

					fi

				# - armv7+
				elif (( $HW_ARCH >= 2 && $HW_ARCH < 10 )); then

					filename_hostapd='hostapd-nl80211-armv7'
					filename_hostapd_cli='hostapd_cli-armv7'

					if (( $WIFIHOTSPOT_RTL8188C_DEVICE )); then

						filename_hostapd='hostapd-rtl8188c-armv7'

					fi

				# - arm64
				elif (( $HW_ARCH >= 10 && $HW_ARCH < 20 )); then

					filename_hostapd='hostapd-nl80211-arm64'
					filename_hostapd_cli='hostapd_cli-arm64'

					if (( $WIFIHOTSPOT_RTL8188C_DEVICE )); then

						filename_hostapd='hostapd-rtl8188c-arm64'

					fi

				fi

				mv "$filename_hostapd" /usr/sbin/hostapd
				mv "$filename_hostapd_cli" /usr/sbin/hostapd_cli

				chmod +x /usr/sbin/hostapd
				chmod +x /usr/sbin/hostapd_cli

				rm hostapd-*

				#Enable wifi modules
				/DietPi/dietpi/func/dietpi-set_hardware wifi enable

			else

				Error_NoConnection_NoInstall

			fi

		fi


		#TORHOTSPOT
		INSTALLING_INDEX=61
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			# - Prereqs
			AGI tor

		fi

		#SHAIRPORTSYNC
		INSTALLING_INDEX=37
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check source is online
			# - ARMv6
			if (( $HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/shairport-sync-dietpi_armv6.deb'

			# - ARMv7
			elif (( $HW_ARCH >= 2 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/shairport-sync-dietpi_armv7.deb'

			# - ARM64
			elif (( $HW_ARCH >= 10 && $HW_ARCH < 20 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/shairport-sync-dietpi_arm64.deb'

			fi

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				# - Prereqs
				AGI openssl avahi-daemon libsoxr0 libavahi-client3 libtool libconfig9 libpopt0 libdaemon0 --no-install-recommends

				# This occured on C2: shairport-sync : Depends: libpopt-dev but it is not installed
				AGI libpopt-dev

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#BRUTEFIR
		INSTALLING_INDEX=38
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check folder is online
			INSTALL_URL_ADDRESS='http://dietpi.com/downloads/conf/BruteFIR/'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				# - Prereqs
				AGI brutefir

				wget -r -nH --cut-dirs=2 --no-parent --reject="index.htm*" -e robots=off "$INSTALL_URL_ADDRESS"
				mv BruteFIR /etc/

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#PYDIO
		INSTALLING_INDEX=48
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check folder is online
			INSTALL_URL_ADDRESS='http://sourceforge.net/projects/ajaxplorer/files/pydio/stable-channel/6.2.2/pydio-core-6.2.2.zip/download'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				# - Prereqs
				AGI php5-mcrypt php5-gd

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www
				mv /var/www/pydio-core-* /var/www/pydio
				rm package.zip

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#SQUEEZELITE
		INSTALLING_INDEX=36
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			# - Prereqs
			AGI squeezelite

		fi

		#EMONHUB
		INSTALLING_INDEX=99
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check, is online
			INSTALL_URL_ADDRESS='https://github.com/Fourdee/emonhub/archive/emon-pi.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				# - Prereqs
				AGI minicom python-pip python-serial python-configobj --no-install-recommends
				pip install paho-mqtt pydispatcher

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				rm package.zip

				# - move everything to /etc/emonhub
				rm -R /etc/emonhub
				mkdir -p /etc/emonhub
				mv emonhub-*/* /etc/emonhub/
				rm -R emonhub-*

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#RPIMONITOR
		INSTALLING_INDEX=66
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check, is online
			INSTALL_URL_ADDRESS='https://github.com/XavierBerger/RPi-Monitor-deb/raw/a7ae61cec8589b0fe1a835170ff34a268ab4a295/packages/rpimonitor_2.11-r5_all.deb'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

				# - Prereqs
				apt-get -f -y install

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#NETDATA
		INSTALLING_INDEX=65
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Rpi 1
			if (( $HW_MODEL < 2 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/netdata_1.2.0_armv6.deb'

			#arm64
			elif (( ( $HW_MODEL == 12 ) || ( $HW_MODEL >= 40 && $HW_MODEL < 50 ) )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/netdata_1.2.0_arm64.deb'

			#all others
			else

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/netdata_1.2.0_armv7.deb'

			fi

			#check, is online
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				# - For compression
				AGI --no-install-recommends zlib1g-dev

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#BAIKAL
		INSTALLING_INDEX=57
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check folder is online
			INSTALL_URL_ADDRESS='https://github.com/fruux/Baikal/archive/master.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip -d /var/www
				rm package.zip
				mv /var/www/Baikal* /var/www/baikal

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#MUMBLESERVER
		INSTALLING_INDEX=43
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI mumble-server

		fi

		#EMBYSERVER
		INSTALLING_INDEX=41
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			local url_tests=0

			#check is online
			INSTALL_URL_ADDRESS='http://download.opensuse.org/repositories/home:/emby/Debian_8.0'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			if (( $? == 0 )); then

				INSTALL_URL_ADDRESS='http://download.mono-project.com/repo/debian'
				/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

				if (( $? == 0 )); then

					url_tests=1

				fi

			fi

			#install
			if (( $url_tests == 1 )); then

				# - Alternative mono repo: https://github.com/Fourdee/DietPi/issues/310#issuecomment-216247879
				apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
				echo -e "deb http://download.mono-project.com/repo/debian wheezy main" > /etc/apt/sources.list.d/mono-xamarin.list
				echo -e "deb http://download.mono-project.com/repo/debian wheezy-libjpeg62-compat main" >> /etc/apt/sources.list.d/mono-xamarin.list

				# - Emby repo
				wget http://download.opensuse.org/repositories/home:emby/Debian_8.0/Release.key
				apt-key add - < Release.key
				echo -e "deb http://download.opensuse.org/repositories/home:/emby/Debian_8.0/ /" > /etc/apt/sources.list.d/emby-server.list
				apt-get update

				AGI emby-server

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#PLEXMEDIASERVER
		INSTALLING_INDEX=42
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check folder is online

			#x86_64
			if (( $HW_ARCH == 21 )); then

				INSTALL_URL_ADDRESS='https://downloads.plex.tv/plex-media-server/1.0.0.2261-a17e99e/plexmediaserver_1.0.0.2261-a17e99e_amd64.deb'

			#ARM
			else

				INSTALL_URL_ADDRESS='http://dev2day.de/pms/'

			fi

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				#x86_64
				if (( $HW_ARCH == 21 )); then

					wget "$INSTALL_URL_ADDRESS" -O package.deb
					dpkg -i package.deb
					rm package.deb

				#ARM
				else

					echo -e "deb [arch=armhf] $INSTALL_URL_ADDRESS jessie main" > /etc/apt/sources.list.d/plex.list
					wget -O - "$INSTALL_URL_ADDRESS"dev2day-pms.gpg.key | apt-key add -
					#AGI apt-transport-https
					apt-get update

					#ARM64: Install 32bit binaries
					if (( $HW_ARCH == 10 )); then

						dpkg --add-architecture armhf
						apt-get update
						AGI binutils:armhf plexmediaserver-installer:armhf

					#ARM32
					else

						AGI plexmediaserver

					fi

				fi

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#CUBERITE
		INSTALLING_INDEX=52
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#x86_64
			if (( $HW_ARCH == 21 )); then

				INSTALL_URL_ADDRESS='http://builds.cuberite.org/job/Cuberite%20Linux%20x64%20Master/lastSuccessfulBuild/artifact/Cuberite.tar.gz'

			#32bit ARM
			elif (( $HW_ARCH >= 1 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS='http://builds.cuberite.org/job/Cuberite%20Linux%20raspi-armhf%20Master/lastSuccessfulBuild/artifact/Cuberite.tar.gz'

			fi
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.tar
				mkdir -p /etc/cubrite
				tar xzvf package.tar -C /etc/cubrite
				rm package.tar

				# - Move everything into base directory (cuberite)
				mv /etc/cubrite/Server/* /etc/cubrite/
				rm -R /etc/cuberite/Server

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#MINEOS
		INSTALLING_INDEX=53
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#check folder is online

			INSTALL_URL_ADDRESS='http://github.com/hexparrot/mineos-node.git'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				#prereqs
				AGI python python3 supervisor rdiff-backup screen rsync

				mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/mineos
				cd "$FP_DIETPI_USERDATA_DIRECTORY"/mineos
				git clone https://github.com/hexparrot/mineos-node.git minecraft

				cd minecraft
				git config core.filemode false
				chmod +x service.js mineos_console.js generate-sslcert.sh webui.js

				npm install

				cd "$HOME"

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#GOGS
		INSTALLING_INDEX=49
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#armv6
			if (( $HW_ARCH == 1 )); then

				INSTALL_URL_ADDRESS='https://dl.gogs.io/gogs_latest_linux_arm.zip'

			#armv7+
			elif (( $HW_ARCH >= 2 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS='https://dl.gogs.io/gogs_latest_raspi2.zip'

			#x86_64
			elif (( $HW_ARCH == 21 )); then

				INSTALL_URL_ADDRESS='https://dl.gogs.io/gogs_latest_linux_amd64.zip'
			fi

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				rm package.zip

				mv gogs* /etc/gogs

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#QBITTORRENT
		INSTALLING_INDEX=46
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI qbittorrent-nox

		fi

		#RTORRENT
		INSTALLING_INDEX=107
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			INSTALL_URL_ADDRESS='http://bintray.com/novik65/generic/download_file?file_path=ruTorrent-3.7.zip'
			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				AGI rtorrent screen php5-curl #mediainfo

				#Raspbian unrar free
				if (( $HW_MODEL < 10 )); then

					AGI unrar-free #https://github.com/Fourdee/DietPi/issues/176#issuecomment-240101365

				else

					AGI unrar #https://github.com/Fourdee/DietPi/issues/176#issuecomment-240101365

				fi


				wget "$INSTALL_URL_ADDRESS" -O package.zip
				unzip package.zip
				rm package.zip

				mkdir -p /var/www/rutorrent
				mv ruTorrent-*/* /var/www/rutorrent/
				rm -R ruTorrent-*

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#SYNCTHING
		INSTALLING_INDEX=50
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#armv6+
			if (( $HW_ARCH >= 1 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS='http://github.com/syncthing/syncthing/releases/download/v0.14.0/syncthing-linux-arm-v0.14.0.tar.gz'

			#arm64
			elif (( $HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='http://github.com/syncthing/syncthing/releases/download/v0.14.0/syncthing-linux-arm64-v0.14.0.tar.gz'

			#x86_64
			elif (( $HW_ARCH == 21 )); then

				INSTALL_URL_ADDRESS='http://github.com/syncthing/syncthing/releases/download/v0.14.0/syncthing-linux-amd64-v0.14.0.tar.gz'

			fi

			#??
			#For some reason checking connection (spider) against the files above fails.

			#/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"
			/DietPi/dietpi/func/check_connection http://github.com/syncthing/syncthing

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.tar
				tar xzvf package.tar
				rm package.tar

				mv syncthing-*/syncthing /usr/bin/
				rm -R syncthing-*

			else

				Error_NoConnection_NoInstall

			fi

		fi

		#CHROMIUM
		INSTALLING_INDEX=113
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#armv6+
			if (( $HW_ARCH >= 1 && $HW_ARCH < 10 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/chromium_52.0.2743.116-1-deb8u1.1_armhf.deb'

			#arm64
			elif (( $HW_ARCH == 10 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/chromium_52.0.2743.116-1-deb8u1.1_arm64.deb'

			fi

			/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

			#Install
			if (( $? == 0 )); then

				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb

				# - Odroid's, 'apt-get install -f' removes chromium package, rather than install required deps...
				if (( $HW_MODEL >= 10 && $HW_MODEL < 20 )); then

					AGI libgnome-keyring0 libnspr4 libnss3 libnss3-1d libspeechd2 libxslt1.1 libxss1 xdg-utils libgnome-keyring-common libltdl7

				else

					AGF

				fi

				wget http://dietpi.com/downloads/binaries/all/chromium-l10n_52.0.2743.116-1-deb8u1.1_all.deb -O package.deb
				dpkg -i package.deb

				#	armv6+
				if (( $HW_ARCH >= 1 && $HW_ARCH < 10 )); then

					wget http://dietpi.com/downloads/binaries/all/chromedriver_52.0.2743.116-1-deb8u1.1_armhf.deb -O package.deb
					dpkg -i package.deb

				#	arm64
				elif (( $HW_ARCH == 10 )); then

					wget http://dietpi.com/downloads/binaries/all/chromedriver_52.0.2743.116-1-deb8u1.1_arm64.deb -O package.deb
					dpkg -i package.deb

				fi

				rm package.deb

			else

				Error_NoConnection_NoInstall

			fi

		fi

	}

	Install_Linux_Software(){

		INSTALLING_INDEX=5
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			AGI alsa-base alsa-utils

			#Apply soundcard
			local soundcard=$(cat /DietPi/dietpi.txt | grep -m1 'soundcard=' | sed 's/.*=//')

			# - RPi enable internal HDMI+Analogue if currently set to 'none'
			if (( $HW_MODEL < 10 )) &&
				[ "$soundcard" = "none" ]; then

				soundcard='rpi-bcm2835'

			fi

			# - Apply
			/DietPi/dietpi/func/dietpi-set_hardware soundcard "$soundcard"

		fi


		INSTALLING_INDEX=6
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Xserver Prereqs (ALL)
			AGI xcompmgr xterm xinit xauth xserver-xorg dbus-x11 xfonts-base x11-xserver-utils x11-common x11-utils --no-install-recommends

			#Improve performance on all desktops and devices (eg: removes window lag in desktops) by limiting compositions
			mkdir -p /etc/xdg/autostart
			cat << _EOF_ > /etc/xdg/autostart/xcompmgr.desktop
[Desktop Entry]
Type=Application
Name=xcompmgr
NoDisplay=true
Exec=xcompmgr -a
_EOF_

			#RPI
			if (( $HW_MODEL < 10 )); then

				sleep 1

			#Odroid C2
			elif (( $HW_MODEL == 12 )); then

				AGI aml-libs-odroid mali450-odroid xf86-video-mali-odroid libump-odroid --no-install-recommends

				cp /DietPi/dietpi/conf/xorg_c2.conf /etc/X11/xorg.conf

			#Odroid XU4
			elif (( $HW_MODEL == 11 )); then

				AGI firmware-samsung xf86-video-armsoc-odroid malit628-odroid --no-install-recommends

				cp /DietPi/dietpi/conf/xorg_xu4.conf /etc/X11/xorg.conf

			#Odroid C1
			elif (( $HW_MODEL == 10 )); then

				AGI aml-libs-odroid xf86-video-mali-odroid libump-odroid mali450-odroid --no-install-recommends

				cp /DietPi/dietpi/conf/xorg_c1.conf /etc/X11/xorg.conf

			#Pine64
			elif (( $HW_MODEL >= 40 && $HW_MODEL < 50 )); then

				#check source is online
				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/libump_1-1_arm64.deb'
				/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

				#Install
				if (( $? == 0 )); then

					wget "$INSTALL_URL_ADDRESS" -O package.deb
					dpkg -i package.deb
					rm package.deb

					wget http://dietpi.com/downloads/binaries/all/xf86-video-fbturbo_1-1_arm64.deb -O package.deb
					dpkg -i package.deb
					rm package.deb

					cat << _EOF_ > /etc/X11/xorg.conf
Section "Device"
        Identifier      "Allwinner A10/A13 FBDEV"
        Driver          "fbturbo"
        Option          "fbdev" "/dev/fb0"
        Option          "SwapbuffersWait" "true"
EndSection
_EOF_

				else

					Error_NoConnection_NoInstall

				fi

			fi

		fi

		INSTALLING_INDEX=16
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI build-essential make autoconf automake --no-install-recommends

		fi

		INSTALLING_INDEX=17
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI git --no-install-recommends

		fi

		# if (( $QUITERSS == 1 )); then
			# INSTALL_DESCRIPTION="QuiteRSS"
			# Banner_Installing
			# AGI quiterss

			# QUITERSS=2

		# fi

		INSTALLING_INDEX=4
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI vifm

		fi

		INSTALLING_INDEX=20
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI vim

		fi

		INSTALLING_INDEX=21
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI vim-tiny

		fi

		INSTALLING_INDEX=18
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI emacs

		fi

		INSTALLING_INDEX=12
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI iperf

		fi

		INSTALLING_INDEX=3
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI mc

		fi

		INSTALLING_INDEX=19
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI jed

		fi

		INSTALLING_INDEX=10
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI iftop

		fi

		INSTALLING_INDEX=11
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI iptraf

		fi

		INSTALLING_INDEX=13
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI mtr-tiny

		fi

		INSTALLING_INDEX=14
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI nload

		fi

		INSTALLING_INDEX=15
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI tcpdump

		fi

		INSTALLING_INDEX=0
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI openssh-client

		fi

		INSTALLING_INDEX=1
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Remove Information file
			rm /mnt/samba/readme.txt &> /dev/null

			AGI smbclient cifs-utils --no-install-recommends

		fi

		INSTALLING_INDEX=2
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Remove information file
			rm /mnt/ftp_client/readme.txt &> /dev/null

			AGI curlftpfs

		fi

		INSTALLING_INDEX=110
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Remove information file
			rm /mnt/nfs_client/readme.txt &> /dev/null

			AGI nfs-common

		fi

		INSTALLING_INDEX=104
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI dropbear

			#set to start on next boot
			sed -i '/NO_START=1/c\NO_START=0' /etc/default/dropbear

		fi

		INSTALLING_INDEX=105
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI openssh-server --no-install-recommends

			sed -i '/PermitRootLogin/c\PermitRootLogin yes' /etc/ssh/sshd_config

			#Restart ssh server now so root users can login during setup.
			systemctl restart ssh

			#SSH server package also installs client.
			aSOFTWARE_INSTALL_STATE[0]=2

		fi

		INSTALLING_INDEX=103
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#Install (add tmpfs mount to fstab)
			sed -i '/\/var\/log/c\tmpfs                   \/var\/log                tmpfs   defaults,size=20m,noatime,nodev,nosuid,mode=1777  0 0' /etc/fstab

		fi

		INSTALLING_INDEX=101
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI logrotate --no-install-recommends

		fi

		INSTALLING_INDEX=102
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing
			AGI rsyslog --no-install-recommends

		fi

		INSTALLING_INDEX=7
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#RPi v1 armv6, broken packages in multimedia repo. https://github.com/Fourdee/DietPi/issues/84#issuecomment-151201361
			if (( $HW_MODEL < 2 )); then

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/ffmpeg_2.7.2-1_armhf-v6.deb'
				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/all/fdk-aac_0.1.4_armhf-v6.deb'
				wget "$INSTALL_URL_ADDRESS" -O package.deb
				dpkg -i package.deb
				rm package.deb

				#Install pre-reqs
				AGI libogg0 libvorbisenc2 libtheora0 libspeex1 libopencore-amrwb0 libopencore-amrnb0 libass5 libmp3lame0

			#rpi 2/3
			elif (( $HW_MODEL == 2 )) || (( $HW_MODEL == 3 )); then

				#Add Deb Multimedia repo for ffmpeg
				if [ ! -f /etc/apt/sources.list.d/debmultimedia.list ]; then

					echo -e "deb http://www.deb-multimedia.org jessie main non-free" > /etc/apt/sources.list.d/debmultimedia.list
					apt-get update
					AGI deb-multimedia-keyring
					apt-get update

					AGI ffmpeg

					#Done. Remove deb http://www.deb-multimedia.org from apt sources
					# - When installing Kodi, apt uses the packages from deb http://www.deb-multimedia.org, rather than Raspbian.
					rm /etc/apt/sources.list.d/debmultimedia.list
					apt-get update

				fi

			#Jessie (now available from backports).
			else

				AGI ffmpeg

			fi

		fi

		INSTALLING_INDEX=8
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			# - Raspbian
			if (( $HW_MODEL < 10 )); then

				AGI oracle-java8-jdk

			# - Debian. Add repo
			else

				cat << _EOF_ > /etc/apt/sources.list.d/webupd8team-java.list
deb http://ppa.launchpad.net/webupd8team/java/ubuntu trusty main
deb-src http://ppa.launchpad.net/webupd8team/java/ubuntu trusty main
_EOF_

				apt-key adv --keyserver keyserver.ubuntu.com --recv-keys EEA14886
				apt-get update

				# - Accept the license: https://github.com/Fourdee/DietPi/issues/298
				debconf-set-selections <<< "oracle-java8-installer shared/accepted-oracle-license-v1-1 boolean true"

				AGI oracle-java8-installer

			fi

		fi

		INSTALLING_INDEX=9
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Banner_Installing

			#arm64 - Not currently available via nodesource.com or https://raw.githubusercontent.com/taaem/nodejs-linux-installer/master/node-install.sh
			if (( $HW_ARCH == 10 )); then

				#check, is online
				INSTALL_URL_ADDRESS='http://dietpi.com/downloads/binaries/c2/nodejs_5-1_arm64.deb'
				/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

				#Install
				if (( $? == 0 )); then

					# - Preqs
					wget "$INSTALL_URL_ADDRESS" -O package.deb
					dpkg -i package.deb
					rm package.deb

				else

					Error_NoConnection_NoInstall

				fi

			#Everything else
			else

				#check, is online
				INSTALL_URL_ADDRESS='http://raw.githubusercontent.com/taaem/nodejs-linux-installer/master/node-install.sh'
				/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

				#Install
				if (( $? == 0 )); then

					# - Preqs
					wget "$INSTALL_URL_ADDRESS" -O node_install.sh
					chmod +x node_install.sh
					./node_install.sh

					rm node_install.sh


				else

					Error_NoConnection_NoInstall

				fi

			fi

		fi

		#-------------------------------------------------------------------

	}

	Uninstall_NonSelected_Choices(){

		#Uninstall software using our temp uninstall list
		if [ -f "$UNINSTALL_FILE" ]; then

			#Run the temp uninstall script
			while read -r line
			do
				Uninstall_Software "$line"

			done < $UNINSTALL_FILE
			rm $UNINSTALL_FILE

		fi

	}

	Apply_SSHServer_Choices(){

		#Work out which SSH Server needs installing from Indexs (if any)
		#Work out which SSH server needs removing (if any), and, create a temp script file
		if (( $INDEX_SSHSERVER_TARGET != $INDEX_SSHSERVER_CURRENT )); then

			# - No SSH server
			if (( $INDEX_SSHSERVER_TARGET == 0 )); then

				echo -e "104" >> "$UNINSTALL_FILE"
				echo -e "105" >> "$UNINSTALL_FILE"

			# - Dropbear
			elif (( $INDEX_SSHSERVER_TARGET == -1 )); then

				aSOFTWARE_INSTALL_STATE[104]=1
				echo -e "105" >> "$UNINSTALL_FILE"

			# - Openssh
			elif (( $INDEX_SSHSERVER_TARGET == -2 )); then

				aSOFTWARE_INSTALL_STATE[105]=1
				echo -e "104" >> "$UNINSTALL_FILE"

			fi

			#Inform user (From testing, stopping SSH server services does not disconnect user, however, just incase it does in the future)
			/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Stopping SSH servers"

			#stop all SSH server services
			service ssh stop &> /dev/null
			service dropbear stop &> /dev/null

			#Update Current SSHSERVER index
			INDEX_SSHSERVER_CURRENT=$INDEX_SSHSERVER_TARGET

		fi

	}

	Apply_FileServer_Choices(){

		#Work out which File Server needs installing from Indexs (if any)
		#Work out which File server needs removing (if any), and, create a temp script file
		if (( $INDEX_FILESERVER_TARGET != $INDEX_FILESERVER_CURRENT )); then

			#No File server
			if (( $INDEX_FILESERVER_TARGET == 0 )); then
				echo -e "96" >> "$UNINSTALL_FILE"
				echo -e "94" >> "$UNINSTALL_FILE"
				#echo -e "95" >> "$UNINSTALL_FILE"

			#ProFTP
			elif (( $INDEX_FILESERVER_TARGET == -1 )); then

				aSOFTWARE_INSTALL_STATE[94]=1
				echo -e "96" >> "$UNINSTALL_FILE"

			#Samba
			elif (( $INDEX_FILESERVER_TARGET == -2 )); then

				aSOFTWARE_INSTALL_STATE[96]=1
				echo -e "94" >> "$UNINSTALL_FILE"

			fi

			#Update Current SSHSERVER index
			INDEX_FILESERVER_CURRENT=$INDEX_FILESERVER_TARGET

		fi

	}

	Apply_Logging_Choices(){

		#Work out which Logging system needs installing from Indexs (if any)
		#Work out which Logging system needs removing (if any), and, create a temp script file
		if (( $INDEX_LOGGING_TARGET != $INDEX_LOGGING_CURRENT )); then

			#None
			if (( $INDEX_LOGGING_TARGET == 0 )); then

				echo -e "101" >> "$UNINSTALL_FILE"
				echo -e "103" >> "$UNINSTALL_FILE"
				echo -e "102" >> "$UNINSTALL_FILE"

			#Ramlog - clear every 24H
			elif (( $INDEX_LOGGING_TARGET == -1 )); then

				aSOFTWARE_INSTALL_STATE[103]=1
				echo -e "101" >> "$UNINSTALL_FILE"
				echo -e "102" >> "$UNINSTALL_FILE"

			#Ramlog - backup every 1H to $HOME/logfile_storage, then clear.
			elif (( $INDEX_LOGGING_TARGET == -2 )); then

				aSOFTWARE_INSTALL_STATE[103]=1
				echo -e "101" >> "$UNINSTALL_FILE"
				echo -e "102" >> "$UNINSTALL_FILE"

			#Logrotate + rsyslog - logs to disk
			elif (( $INDEX_LOGGING_TARGET == -3 )); then

				aSOFTWARE_INSTALL_STATE[101]=1
				aSOFTWARE_INSTALL_STATE[102]=1
				echo -e "103" >> "$UNINSTALL_FILE"

			fi

			#Update Current Logging index
			INDEX_LOGGING_CURRENT=$INDEX_LOGGING_TARGET

		fi

	}

	Apply_Webserver_Preference(){

		if (( $INDEX_WEBSERVER_TARGET != $INDEX_WEBSERVER_CURRENT )); then

			#Update Current to Target
			INDEX_WEBSERVER_CURRENT=$INDEX_WEBSERVER_TARGET

		fi

	}

	Install_Apply_Permissions(){

		#Not all permissions are listed here.
		# - Only ones which are shared across programs, and/or located inside FP_DIETPI_USERDATA_DIRECTORY that require non-root permissions.

		#www-data
		chown -R www-data:www-data /var/www
		chmod -R 775 /var/www

		#Apply non-root permissions for files and folders in FP_DIETPI_USERDATA_DIRECTORY
		chmod -R 775 "$FP_DIETPI_USERDATA_DIRECTORY"

		chown -R mineos:mineos "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/serverdata

		chown -R www-data:www-data "$FP_DIETPI_USERDATA_DIRECTORY"/dietpicam

		chown -R urbackup:urbackup "$FP_DIETPI_USERDATA_DIRECTORY"/urbackup
		chown -R www-data:www-data "$FP_DIETPI_USERDATA_DIRECTORY"/pydio_data
		chown -R www-data:www-data "$FP_DIETPI_USERDATA_DIRECTORY"/owncloud_data
		chown -R www-data:www-data "$FP_DIETPI_USERDATA_DIRECTORY"/nextcloud_data

	}

	Install_Apply_Configs(){

		# Copy/Set optimised Software settings.
		# Set install states to 2 (installed).

		#DESKTOP_LXDE
		INSTALLING_INDEX=23
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Remove Lxrandr Menu item (monitor configuration tool as we set res in dietpi-config)
			rm /usr/share/applications/lxrandr.desktop &> /dev/null

			#Copy PCmanFM configs
			mkdir -p "$HOME"/.config/pcmanfm/LXDE
			cp /DietPi/dietpi/conf/desktop/pcmanfm.conf "$HOME"/.config/pcmanfm/LXDE/pcmanfm.conf
			cp /DietPi/dietpi/conf/desktop/pcmanfm-desktopitems.conf "$HOME"/.config/pcmanfm/LXDE/desktop-items-0.conf

			#Disable Trash
			sed -i '/use_trash=/c\use_trash=0' /etc/xdg/libfm/libfm.conf

			#Copy DietPi Panel config
			mkdir -p "$HOME"/.config/lxpanel/LXDE/panels
			cp /DietPi/dietpi/conf/desktop/panel "$HOME"/.config/lxpanel/LXDE/panels/panel

			#Openbox config
			mkdir -p "$HOME"/.config/openbox
			cp /DietPi/dietpi/conf/desktop/lxde-rc.xml "$HOME"/.config/openbox/lxde-rc.xml

			# - file manager desktop icon
			ln -sf /usr/share/applications/pcmanfm.desktop "$HOME"/Desktop/pcmanfm.desktop

			Create_Desktop_Shared_Items

		fi

		#Desktop MATE
		INSTALLING_INDEX=24
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - file manager desktop icon
			ln -sf /usr/share/applications/caja.desktop "$HOME"/Desktop/caja.desktop

			Create_Desktop_Shared_Items

			#Odroid C2, define default pulseaudio sink: https://github.com/Fourdee/DietPi/issues/415
			if (( $HW_MODEL == 12 &&
				! $(cat /etc/pulse/default.pa | grep -ci -m1 '^set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo') )); then

				echo -e "set-default-sink alsa_output.platform-odroid_hdmi.37.analog-stereo" >> /etc/pulse/default.pa

			fi

		fi

		#Desktop GNUStep
		INSTALLING_INDEX=26
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Create_Desktop_Shared_Items

		fi

		#DESKTOP_XFCE
		INSTALLING_INDEX=25
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Create_Desktop_Shared_Items

		fi

		#WEBSERVER_APACHE
		INSTALLING_INDEX=83
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#create www directory
			mkdir -p /var/www

			#Apache2 confs
			cp /DietPi/dietpi/conf/apache2_jessie.conf /etc/apache2/apache2.conf
			cat << _EOF_ > /etc/apache2/sites-available/000-default.conf
<VirtualHost *:80>
ServerAdmin webmaster@localhost
DocumentRoot /var/www

ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
_EOF_

			cat << _EOF_ > /etc/apache2/mods-available/mpm_event.conf
<IfModule mpm_event_module>
StartServers		 $CPU_CORES_TOTAL
MinSpareThreads		 1
MaxSpareThreads		 8
ThreadLimit		 	16
ThreadsPerChild		 4
MaxRequestWorkers	 50
MaxConnectionsPerChild   0
</IfModule>
_EOF_

			cat << _EOF_ > /etc/apache2/mods-available/mpm_prefork.conf
<IfModule mpm_prefork_module>
StartServers		 $CPU_CORES_TOTAL
MinSpareServers		 1
MaxSpareServers		 $CPU_CORES_TOTAL
MaxRequestWorkers	 50
MaxConnectionsPerChild   0
</IfModule>
_EOF_

			cat << _EOF_ > /etc/apache2/mods-available/mpm_worker.conf
<IfModule mpm_worker_module>
StartServers		 $CPU_CORES_TOTAL
MinSpareThreads		 1
MaxSpareThreads		 8
ThreadLimit		 	16
ThreadsPerChild		 4
MaxRequestWorkers	 50
MaxConnectionsPerChild   0
</IfModule>
_EOF_

			#Use /var/www as default webfolder
			mv /var/www/html/index.html /var/www/index.html &> /dev/null
			rm -R /var/www/html &> /dev/null

			#Sites-Available settings. Disable access log, set error log level
			sed -i "/CustomLog /c\        #CustomLog "'${APACHE_LOG_DIR}'"/access.log combined" /etc/apache2/sites-available/*
			sed -i "/LogLevel /c\        LogLevel error" /etc/apache2/sites-available/*

		fi

		#WEBSERVER_NGINX
		INSTALLING_INDEX=85
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#create www directory
			mkdir -p /var/www

			#Nginx confs
			mkdir /etc/nginx/sites-dietpi
			cp /DietPi/dietpi/conf/nginx.conf /etc/nginx/nginx.conf
			cp /DietPi/dietpi/conf/nginx.site-available-default /etc/nginx/sites-available/default

			#Nginx index page
			cp /usr/share/nginx/html/index.html /var/www/index.html


			#CPU core count
			sed -i "/worker_processes/c\worker_processes $CPU_CORES_TOTAL;" /etc/nginx/nginx.conf

		fi

		#WEBSERVER_LIGHTTPD
		INSTALLING_INDEX=84
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#create www directory
			mkdir -p /var/www

			#www path
			sed -i '/^server.document-root/c\server.document-root        = "/var/www"' /etc/lighttpd/lighttpd.conf

			#Configure fastcgi for PHP-FPM
			cat << _EOF_ > /etc/lighttpd/conf-available/15-fastcgi-php.conf
# -*- depends: fastcgi -*-
# /usr/share/doc/lighttpd/fastcgi.txt.gz
# http://redmine.lighttpd.net/projects/lighttpd/wiki/Docs:ConfigurationOptions#mod_fastcgi-fastcgi

## Start an FastCGI server using php-fpm
fastcgi.server += ( ".php" =>
        ((
                "socket" => "/var/run/php5-fpm.sock",
                "broken-scriptfilename" => "enable"
        ))
)
_EOF_

			#enable cgi/php
			lighttpd-enable-mod fastcgi
			lighttpd-enable-mod fastcgi-php

			#Move default page
			mv /var/www/html/index.lighttpd.html /var/www/

			service lighttpd force-reload

		fi

		#WEBSERVER_PHP
		INSTALLING_INDEX=89
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - Apache2 has uses its own PHP module
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				echo -e "nothing here" &> /dev/null

			# - All other webservers (eg: Nginx/Lighttpd) use PHP-FPM
			else

				# - Php-FPM confs
				cp /DietPi/dietpi/conf/php-fpm.conf /etc/php5/fpm/php-fpm.conf
				cp /DietPi/dietpi/conf/php-fpm_pool.conf /etc/php5/fpm/pool.d/www.conf
				sed -i '/cgi.fix_pathinfo=/c\cgi.fix_pathinfo=1' /etc/php5/fpm/php.ini

				# - PHP5-fpm optimizations based on total cores
				sed -i "/pm.max_children = /c\pm.max_children = $CPU_CORES_TOTAL" /etc/php5/fpm/pool.d/www.conf
				sed -i "/pm.start_servers = /c\pm.start_servers = $CPU_CORES_TOTAL" /etc/php5/fpm/pool.d/www.conf
				sed -i "/pm.min_spare_servers = /c\pm.min_spare_servers = $CPU_CORES_TOTAL" /etc/php5/fpm/pool.d/www.conf
				sed -i "/pm.max_spare_servers = /c\pm.max_spare_servers = $CPU_CORES_TOTAL" /etc/php5/fpm/pool.d/www.conf

				# - Enviroment PHP settings:
				sed -i "/env\[HOSTNAME\]/c\env\[HOSTNAME\] = \$HOSTNAME" /etc/php5/fpm/pool.d/www.conf
				sed -i "/env\[PATH\]/c\env\[PATH\] = /usr/local/bin:/usr/bin:/bin" /etc/php5/fpm/pool.d/www.conf

				#	/tmp is mounted to RAM, so use DISK (/var/tmp) instead
				sed -i "/env\[TMP\]/c\env\[TMP\] = /var/tmp" /etc/php5/fpm/pool.d/www.conf
				sed -i "/env\[TMPDIR\]/c\env\[TMPDIR\] = /var/tmp" /etc/php5/fpm/pool.d/www.conf
				sed -i "/env\[TEMP\]/c\env\[TEMP\] = /var/tmp" /etc/php5/fpm/pool.d/www.conf

			fi

			#php APC/u settings
			local target_php_ini=0
			local target_php_cachesize=$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 30 ))
			if (( $target_php_cachesize < 10 )); then

				target_php_cachesize=10

			fi

			# - 3days TTL
			local target_apc_ttl='259200'

			#PHP OPcache
			php5enmod opcache

			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				target_php_ini='/etc/php5/apache2/php.ini'

			else

				target_php_ini='/etc/php5/fpm/php.ini'

			fi

			sed -i "/opcache.enable=/c\opcache.enable=1" $target_php_ini
			sed -i "/opcache.memory_consumption=/c\opcache.memory_consumption=$target_php_cachesize" $target_php_ini
			sed -i "/opcache.revalidate_freq=/c\opcache.revalidate_freq=60" $target_php_ini

			wget https://raw.githubusercontent.com/rlerdorf/opcache-status/master/opcache.php -O /var/www/opcache.php

			#APCu
			php5enmod apcu

			# - apc.shm_size= requires M at end to prevent warning: https://github.com/Fourdee/DietPi/issues/218
			target_php_cachesize+="M"
			target_php_ini='/etc/php5/mods-available/apcu.ini'

			cat << _EOF_ > "$target_php_ini"
extension=apcu.so
apc.shm_size=$target_php_cachesize
apc.ttl=$target_apc_ttl
_EOF_

			cp /usr/share/doc/php5-apcu/apc.php /var/www/apc.php

			#Array to store known locations of php.ini, so we can apply same settings to all of them.
			local afp_php_ini=(
				"/etc/php5/apache2/php.ini"
				"/etc/php5/cli/php.ini"
				"/etc/php5/cgi/php.ini"
				"/etc/php5/fpm/php.ini"
			)

			# - temp dir
			local tmp_upload_dir="/var/tmp/php_upload_tmp"
			mkdir -p "$tmp_upload_dir"
			chown -R www-data:www-data "$tmp_upload_dir"

			# - max upload size
			php_max_upload_size="$(( $(php -r 'print(PHP_INT_MAX);') / 1024 / 1024))M"

			#Set all PHP.INI
			for ((i=0; i<${#afp_php_ini[@]}; i++))
			do

				if [ -f "${afp_php_ini[$i]}" ]; then

					# - Set UTF-8
					sed -i '/default_charset/c\default_charset = "UTF-8"' "${afp_php_ini[$i]}"

					# - Set tmp_upload_dir to sd (cant be /tmp as its ramdisk and limited size. Also used by Owncloud uploads
					sed -i "/upload_tmp_dir =/c\upload_tmp_dir = $tmp_upload_dir" "${afp_php_ini[$i]}"

					# - Set max upload sizes.
					sed -i "/upload_max_filesize =/c\upload_max_filesize = $php_max_upload_size" "${afp_php_ini[$i]}"
					sed -i "/post_max_size =/c\post_max_size = $php_max_upload_size" "${afp_php_ini[$i]}"

				fi

			done

			unset afp_php_ini

			#PHP info web file
			cat << _EOF_ > /var/www/phpinfo.php
<?php
phpinfo();
?>
_EOF_

		fi

		#WEBSERVER_MYADMINPHP
		INSTALLING_INDEX=90
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#NGINX LIGHTTPD symlink to var www
			if (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 ||
				${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				ln -sf /usr/share/phpmyadmin /var/www

			fi

		fi

		#WEBSERVER_REDIS
		INSTALLING_INDEX=91
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Enable resdis extensions for all webstacks:
			echo -e "extension=redis.so" > /etc/php5/cli/conf.d/20-redis.ini &> /dev/null
			echo -e "extension=redis.so" > /etc/php5/apache2/conf.d/20-redis.ini &> /dev/null

		fi

		#OPENBAZAAR
		INSTALLING_INDEX=58
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - service
			cp /DietPi/dietpi/conf/openbazaar-server.service /etc/dietpi/dietpi-software/services/openbazaar-server.service
			chmod +x /etc/dietpi/dietpi-software/services/openbazaar-server.service

		fi

		#OWNCLOUD
		INSTALLING_INDEX=47
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Setup Data directory
			local target_data_dir="$FP_DIETPI_USERDATA_DIRECTORY/owncloud_data"
			mkdir -p "$target_data_dir"

			#Create symlink from default /var/www/owncloud/data to FP_DIETPI_USERDATA_DIRECTORY
			local target_data_symlink="/var/www/owncloud/data"
			mkdir -p "$target_data_symlink" &> /dev/null

			# - Copy existing data to our data location
			cp -R "$target_data_symlink" "$target_data_dir"

			# - Create symlink
			rm -R "$target_data_symlink" &> /dev/null
			ln -fs "$target_data_dir" "$target_data_symlink"

			#Php env
			sed -i "/env\[HOSTNAME\] = /c\env\[HOSTNAME\] = \$HOSTNAME" /etc/php5/fpm/pool.d/www.conf
			sed -i "/env\[PATH\] = /c\env\[PATH\] = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" /etc/php5/fpm/pool.d/www.conf
			sed -i "/env\[TMP\] = /c\env\[TMP\] = /tmp" /etc/php5/fpm/pool.d/www.conf
			sed -i "/env\[TMPDIR\] = /c\env\[TMPDIR\] = /tmp" /etc/php5/fpm/pool.d/www.conf
			sed -i "/env\[TEMP\] = /c\env\[TEMP\] = /tmp" /etc/php5/fpm/pool.d/www.conf

##################################################################################################
			#Currently in user docs:

			#Unless https://github.com/owncloud/core/issues/25773 has a solution,
			#User will need to apply this after 1st run setup wizard, else, non-removable failed integrity check warning....


			#NB: When applied prior to 1st run end-user setup, following creates failed integrity check
			#Set max upload size
			# sed -i "/upload_max_filesize=/c\upload_max_filesize=2048M" /var/www/owncloud/.user.ini
			# sed -i "/post_max_size=/c\post_max_size=2048M" /var/www/owncloud/.user.ini

			# local memory_limit_max="$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 4 ))M"
			# sed -i "/memory_limit=/c\memory_limit=$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 4 ))M" /var/www/owncloud/.user.ini

			#APCu Memcache
			#NB: /var/www/owncloud/config/config.php does not exist until after 1st run setup.
			#NB: Has no effect.
			# if (( ! $(cat /var/www/owncloud/config/config.php | grep -ci -m1 "'memcache.local'") )); then

				# sed -i "/'version'/a 'memcache.local' => '\\\OC\\\Memcache\\\APCu'," /var/www/owncloud/config/config.php

			# fi

##################################################################################################

			#NGINX setup default site
			if (( ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				cp /DietPi/dietpi/conf/nginx.sites-dietpi.owncloud.config /etc/nginx/sites-dietpi/owncloud.config

			fi

		fi


		#NextCloud
		INSTALLING_INDEX=114
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/nextcloud_data

			Install_Apply_Permissions &> /dev/null

			service mysql start

			cd /var/www/nextcloud
			sudo -u www-data php occ maintenance:install --no-interaction --database "mysql" --database-name "nextcloud" --database-user "root" --database-pass "dietpi" --admin-user "admin" --admin-pass "dietpi" --data-dir "$FP_DIETPI_USERDATA_DIRECTORY/nextcloud_data"
			cd "$HOME"

			#Disable trusted_domains.
			if (( ! $(cat /var/www/nextcloud/config/config.php | grep -ci -m1 "1 => '*'") )); then

				sed -i "/0 => 'localhost'/a     1 => '*'," /var/www/nextcloud/config/config.php

			fi

			#Owncloud/Nextcloud ignores system wide php.ini settings. Use their own config.
			# - max upload size
			php_max_upload_size="$(( $(php -r 'print(PHP_INT_MAX);') / 1024 / 1024))M"

			sed -i "/upload_max_filesize=/c\upload_max_filesize=$php_max_upload_size" /var/www/nextcloud/.user.ini
			sed -i "/post_max_size=/c\post_max_size=$php_max_upload_size" /var/www/nextcloud/.user.ini

			# - Memory limit, total / 4
			local memory_limit_max="$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 4 ))M"
			sed -i "/memory_limit=/c\memory_limit=$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 4 ))M" /var/www/nextcloud/.user.ini

			# - APCu Memcache
			if (( ! $(cat /var/www/nextcloud/config/config.php | grep -ci -m1 "'memcache.local'") )); then

				sed -i "/'version'/a 'memcache.local' => '\\\OC\\\Memcache\\\APCu'," /var/www/nextcloud/config/config.php

			fi

		fi

		# Transmission
		INSTALLING_INDEX=44
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Jessie, Transmission uses my systemd service: https://github.com/Fourdee/DietPi/issues/350#issuecomment-220828884
			rm /etc/init.d/transmission-daemon
			rm /etc/systemd/system/transmission-daemon.service
			cat << _EOF_ > /etc/systemd/system/transmission-daemon.service
[Unit]
Description=Barebones transmission-daemon service
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/transmission-daemon --config-dir /var/lib/transmission-daemon/info
ExecStop=/usr/bin/killall -w transmission-daemon
StandardOutput=tty

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl enable transmission-daemon.service

			cp /DietPi/dietpi/conf/transmission_settings /etc/transmission-daemon/settings.json

			Create_UserContent_Folders

			#Apply optimized settings
			sed -i '/cache-size-mb/c\    "cache-size-mb": '$(Optimize_BitTorrent 0)',' /etc/transmission-daemon/settings.json
			sed -i '/download-queue-size/c\    "download-queue-size": '$(Optimize_BitTorrent 1)',' /etc/transmission-daemon/settings.json
			sed -i '/peer-limit-global/c\    "peer-limit-global": '$(Optimize_BitTorrent 2)',' /etc/transmission-daemon/settings.json
			sed -i '/max-peers-global/c\    "max-peers-global": '$(Optimize_BitTorrent 2)',' /etc/transmission-daemon/settings.json
			sed -i '/peer-limit-per-torrent/c\    "peer-limit-per-torrent": '$(Optimize_BitTorrent 2)',' /etc/transmission-daemon/settings.json
			sed -i '/upload-slots-per-torrent/c\    "upload-slots-per-torrent": '$(Optimize_BitTorrent 3)',' /etc/transmission-daemon/settings.json

		fi

		#PHPBB
		INSTALLING_INDEX=54
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			/DietPi/dietpi/func/create_mysql_db phpbb3 dietpi root dietpi

		fi

		# Proftpd
		INSTALLING_INDEX=94
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			sed -i "/root/c\#root" /etc/ftpusers
			cp /DietPi/dietpi/conf/proftpd.conf /etc/proftpd/proftpd.conf
			sed -i "/DefaultRoot /c\DefaultRoot $FP_DIETPI_USERDATA_DIRECTORY" /etc/proftpd/proftpd.conf

		fi

		#Samba Server
		INSTALLING_INDEX=96
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			echo -e "dietpi\ndietpi" | smbpasswd -s -a root
			cp /DietPi/dietpi/conf/smb.conf /etc/samba/smb.conf

			sed -i "/path = /c\path = $FP_DIETPI_USERDATA_DIRECTORY" /etc/samba/smb.conf

		fi

		#vsFTPD
		INSTALLING_INDEX=95
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			sed -i '/root/c\#root' /etc/ftpusers

			cp /DietPi/dietpi/conf/vsftpd.conf /etc/vsftpd.conf
			sed -i "/^local_root=/c\local_root=$FP_DIETPI_USERDATA_DIRECTORY" /etc/vsftpd.conf

		fi

		#NFS_SERVER
		INSTALLING_INDEX=109
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			cat << _EOF_ > /etc/exports
$FP_DIETPI_USERDATA_DIRECTORY *(rw,async,no_root_squash,fsid=0,crossmnt,no_subtree_check)
_EOF_

		fi

		#HIFI
		INSTALLING_INDEX=32
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Start at boot
			cp /DietPi/dietpi/conf/ympd_init /etc/init.d/ympd
			chmod +x /etc/init.d/ympd
			update-rc.d ympd defaults

			# + arm64 MPD using our compiled mpd binary.
			if (( $HW_ARCH >= 10 && $HW_ARCH < 20 )); then

				cat << _EOF_ > /etc/default/mpd
#Even though we declare the conf location in our service, MPD will fail to start if this file does not exist.

## The configuration file location for mpd:
MPDCONF=/etc/mpd.conf
_EOF_


				cat << _EOF_ > /lib/systemd/system/mpd.service
[Unit]
Description=Music Player Daemon
After=network.target sound.target

[Service]
User=root
EnvironmentFile=/etc/default/mpd
ExecStartPre=/bin/mkdir -p /var/lib/mpd
ExecStartPre=/bin/mkdir -p /var/log/mpd
ExecStartPre=/bin/mkdir -p /var/run/mpd
ExecStartPre=/bin/mkdir -p /var/lib/mpd
ExecStart=/usr/local/bin/mpd --no-daemon /etc/mpd.conf

# allow MPD to use real-time priority 50
LimitRTPRIO=50
LimitRTTIME=-1

[Install]
WantedBy=multi-user.target

_EOF_

				systemctl daemon-reload

			fi

			#Copy default config
			cp /DietPi/dietpi/conf/mpd.conf /etc/mpd.conf

			#Add audio output options to mpd config
			cat << _EOF_ >> /etc/mpd.conf
audio_output {
	type							"alsa"
	name							"DietPi Alsa"
#	device							"hw:0,0"
	format							"44100:16:2"
	mixer_type						"software"
#	mixer_control					"PCM"
#	mixer_index						"0"
}
#HDMI - Set format and audio_output_format to 48000hz
#audio_output_format				"48000:16:2"
#samplerate_converter				"soxr"
_EOF_

			#Setup data locations
			Create_UserContent_Folders
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/.mpd_cache

			#Grab our test music for the user.
			Download_Test_Media

		fi

		#Kodi
		INSTALLING_INDEX=31
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Remove Kodi user (Whilst waving)
			userdel -r kodi &> /dev/null

			#Run Kodi as root
			sed -i '/USER=/c\USER=root' /etc/default/kodi &> /dev/null

			#Copy udev rules, probably not needed for root, but we'll do it anyway
			cp /DietPi/dietpi/conf/kodi_udev /etc/udev/rules.d/99-input.rules
			chmod +x /etc/udev/rules.d/99-input.rules

			#Create .desktop SymLinks
			mkdir -p "$HOME"/Desktop
			rm /usr/share/applications/kodi.desktop &> /dev/null
			ln -sf /DietPi/dietpi/conf/desktop/kodi.desktop /usr/share/applications/kodi.desktop
			ln -sf /DietPi/dietpi/conf/desktop/kodi.desktop "$HOME"/Desktop/kodi.desktop

			#startkodi alias.
			if (( $(cat /etc/bash.bashrc | grep -ci -m1 'startkodi') == 0 )); then

				echo -e "alias startkodi='/DietPi/dietpi/misc/start_kodi'" >> /etc/bash.bashrc

			fi

		fi

		#MINIDLNA
		INSTALLING_INDEX=39
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Run as root
			sed -i '/USER=m/c\USER=root' /etc/init.d/minidlna
			# + SystemD
			sed -i '/User=m/c\User=root' /lib/systemd/system/minidlna.service &> /dev/null
			sed -i '/Group=m/c\Group=root' /lib/systemd/system/minidlna.service &> /dev/null

			#Copy Config
			cp /DietPi/dietpi/conf/minidlna.conf /etc/minidlna.conf

			#Setup data directories
			Create_UserContent_Folders
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/.MiniDLNA_Cache

		fi

		#uae4arm
		INSTALLING_INDEX=108
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Allow binary execution
			chmod +x /etc/uae4arm-rpi/uae4arm*

			#Create userdata/rom directories and symlink from /etc/uae4arm-rpi/
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi

			#Copy default configs, then setup symlinks from Uae4ARM folders to userdata.
			# - Conf
			cp -R /etc/uae4arm-rpi/conf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/
			rm -R /etc/uae4arm-rpi/conf &> /dev/null
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/conf /etc/uae4arm-rpi/conf

			# - Disks
			rm -R /etc/uae4arm-rpi/disks &> /dev/null
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/disks
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/disks /etc/uae4arm-rpi/disks

			# - floppy_images
			rm -R /etc/uae4arm-rpi/floppy_images &> /dev/null
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/floppy_images
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/floppy_images /etc/uae4arm-rpi/floppy_images
			cat << _EOF_ > "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/floppy_images/dir.txt
Put your Amiga floopy images (*.adf) in this directory.
_EOF_

			# - HDF
			rm -R /etc/uae4arm-rpi/hdf &> /dev/null
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/hdf
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/hdf /etc/uae4arm-rpi/hdf

			# - Kickstarts
			rm -R /etc/uae4arm-rpi/kickstarts &> /dev/null
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/kickstarts
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/kickstarts /etc/uae4arm-rpi/kickstarts
			cat << _EOF_ > "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/kickstarts/dir.txt
Put your Kickstart Roms (*.rom) in this directory.
They should be named accordingly depending on version: kick12.rom , kick13.rom , kick20.rom, kick31.rom
_EOF_

			# - Savestates
			rm -R /etc/uae4arm-rpi/savestates &> /dev/null
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/savestates
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/savestates /etc/uae4arm-rpi/savestates
			cat << _EOF_ > "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/savestates/dir.txt
Saved states will be stored here.
_EOF_

			# - Screenshots
			rm -R /etc/uae4arm-rpi/screenshots &> /dev/null
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/screenshots
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/screenshots /etc/uae4arm-rpi/screenshots
			cat << _EOF_ > "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/screenshots/dir.txt
Screenshots will be stored here.
_EOF_


			#Uae4arm does not support browsing symlinks (https://github.com/Fourdee/DietPi/issues/474#issuecomment-242973839)
			#	So we need to change config file default paths to actual userdata location:
			local fp_userdata_actual=$(readlink /mnt/dietpi_userdata) # Only returns a value if symlink exists (eg: off SDcard)
			if [ -n "$fp_userdata_actual" ]; then

				sed -i "s:$FP_DIETPI_USERDATA_DIRECTORY:$fp_userdata_actual:g" "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/conf/adfdir.conf
				sed -i "s:$FP_DIETPI_USERDATA_DIRECTORY:$fp_userdata_actual:g" "$FP_DIETPI_USERDATA_DIRECTORY"/uae4arm-rpi/conf/autostart.uae

			fi

			#Symlink HW specific binary for this system to /etc/uae4arm-rpi/uae4arm-rpi
			local uae_filename=''

			# - RPi 3
			if (( $HW_MODEL == 3 )); then

				uae_filename='uae4arm-rpi3'

			# - RPi 2
			elif (( $HW_MODEL == 2 )); then

				uae_filename='uae4arm-rpi2'

			# - Assume RPi 1 (ARMv6)
			else

				uae_filename='uae4arm-rpi1'

			fi

			ln -sf /etc/uae4arm-rpi/"$uae_filename" /etc/uae4arm-rpi/uae4arm-rpi

			#service
			cp /DietPi/dietpi/conf/uae4arm-rpi.service /etc/systemd/system/uae4arm-rpi.service

			#run script | checks and runs xinit as needed:
			cat << _EOF_ > /etc/uae4arm-rpi/uae4arm-rpi_run.sh
#!/bin/bash

#From Desktop
if (( \$( ps aux | grep -ci -m1 '/usr/bin/[X]' ) == 1 )); then

    ./uae4arm-rpi -f conf/autostart.uae

else

    xinit ./uae4arm-rpi -f conf/autostart.uae

fi
_EOF_

			chmod +x /etc/uae4arm-rpi/uae4arm-rpi_run.sh

		fi

		#dxx-rebirth
		INSTALLING_INDEX=112
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Symlink savegames to root
			# - Remove existing syslinks
			rm -R "$HOME"/.d1x-rebirth &> /dev/null
			rm -R "$HOME"/.d2x-rebirth &> /dev/null

			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/descent_1_profiles "$HOME"/.d1x-rebirth
			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/descent_2_profiles "$HOME"/.d2x-rebirth

			#+exe
			chmod +x -R "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/*

			#Alias
			if (( ! $(cat /etc/bash.bashrc | grep -ci -m1 'dxx-rebirth') )); then

				sed -i "/#DietPi Additions/a alias dxx-rebirth='$FP_DIETPI_USERDATA_DIRECTORY/dxx-rebirth/run.sh'" /etc/bash.bashrc

			fi

			#Create .Desktop SymLinks
			mkdir -p "$HOME"/Desktop
			mkdir -p /usr/share/applications

			ln -s "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/dxx-rebirth.desktop "$HOME"/Desktop/dxx-rebirth.desktop
			ln -s "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/dxx-rebirth.desktop  /usr/share/applications/dxx-rebirth.desktop

		fi

		#OpenTyrian
		INSTALLING_INDEX=51
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Copy the DietPi run file for OpenTyrian
			cp /DietPi/dietpi/conf/opentyrian_run /usr/local/games/opentyrian/run
			chmod +x /usr/local/games/opentyrian/run

			#Create .Desktop SymLinks
			mkdir -p "$HOME"/Desktop
			rm /usr/share/applications/opentyrian.desktop &> /dev/null
			ln -s /DietPi/dietpi/conf/desktop/opentyrian.desktop /usr/share/applications/opentyrian.desktop
			ln -s /DietPi/dietpi/conf/desktop/opentyrian.desktop "$HOME"/Desktop/opentyrian.desktop

		fi

		#DIETPICAM
		INSTALLING_INDEX=59
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - raspimjpeg conf
			chmod +x /etc/raspimjpeg
			ln -s /etc/raspimjpeg /var/www/dietpicam/raspimjpeg

			# - Motion conf
			chgrp www-data /etc/motion/motion.conf
			chmod 777 /etc/motion/motion.conf
			usermod -a -G video www-data

			# - raspimjpeg/php schedule startup and control script
			cp /DietPi/dietpi/conf/raspimjpeg.service /etc/dietpi/dietpi-software/services/raspimjpeg.service

			# - Setup Data directory
			local dietpicam_media_directory=$FP_DIETPI_USERDATA_DIRECTORY

			mkdir -p "$dietpicam_media_directory"/dietpicam
			rm -R /var/www/dietpicam/media
			ln -s "$dietpicam_media_directory"/dietpicam /var/www/dietpicam/media

			# - Enable RPi Camera module
			sed -i '/start_x=/c\start_x=1' /DietPi/config.txt

		fi

		#Deluge
		INSTALLING_INDEX=45
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#copy init
			cp /DietPi/dietpi/conf/deluge.service /etc/dietpi/dietpi-software/services/deluge.service

			#Generate deluge default config
			deluged
			killall -w deluged

			#Copy DietPi configs
			cp /DietPi/dietpi/conf/deluge.conf "$HOME"/.config/deluge/core.conf
			cp /DietPi/dietpi/conf/deluge_web.conf "$HOME"/.config/deluge/web.conf

			#Set remote access login details
			echo -e "root:dietpi:10" > "$HOME"/.config/deluge/auth

			#Setup data directory
			Create_UserContent_Folders

			#Apply Optimized settings
			# - Cache size is in steps of 16 KiB. (Cachesize * 16 = total KiB)
			local deluge_cache_size=$(( $(echo -e "scale=0; $(Optimize_BitTorrent 0) * 1024 / 16" | bc -l ) ))
			sed -i '/"cache_size": /c\ "cache_size": '"$deluge_cache_size"',' "$HOME"/.config/deluge/core.conf

			sed -i '/"max_active_limit": /c\ "max_active_limit": '"$(Optimize_BitTorrent 1)"',' "$HOME"/.config/deluge/core.conf
			sed -i '/"max_active_downloading": /c\ "max_active_downloading": '"$(Optimize_BitTorrent 1)"',' "$HOME"/.config/deluge/core.conf
			sed -i '/"max_connections_global": /c\ "max_connections_global": '"$(Optimize_BitTorrent 2)"',' "$HOME"/.config/deluge/core.conf
			sed -i '/"max_upload_slots_global": /c\ "max_upload_slots_global": '"$(Optimize_BitTorrent 3)"',' "$HOME"/.config/deluge/core.conf

		fi

		#RaspControl
		INSTALLING_INDEX=106
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Setup login file
			mkdir -p /etc/raspcontrol

cat << _EOF_ > /etc/raspcontrol/database.aptmnt
{
    "user": "root",
    "password": "dietpi"
}
_EOF_

			chown -R www-data:www-data /etc/raspcontrol
			chmod -R 750 /etc/raspcontrol

		fi

		#PIHOLE
		INSTALLING_INDEX=93
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Generate index page that replaces adverts
			cat << _EOF_ > /var/www/index.html
<html>
Blocked by Pi-hole.
<script>window.close();</script>
</html>
_EOF_

			#Generate pihole.log , set permissions to www-data
			echo -e "" > /var/log/pihole.log
			chown www-data:www-data /var/log/pihole.log &> /dev/null
			chmod 775 /var/log/pihole.log

			#Apply dnsmasq.conf
			cp /DietPi/dietpi/conf/dnsmasq.conf /etc/dnsmasq.conf

			#Add active network adapter
			local active_network_adapter=$(sed -n 3p /DietPi/dietpi/.network)
			sed -i "/interface=/c\interface=$active_network_adapter" /etc/dnsmasq.conf

			#Set dnsmasq service to user www-data.
			sed -i '/DNSMASQ_USER=/c\DNSMASQ_USER="www-data"' /etc/init.d/dnsmasq

			#Add weekly cronjob to update adlist
			cat << _EOF_ > /etc/cron.weekly/pihole_adlist_update
#!/bin/bash
{
	service dnsmasq stop

	echo -e "--------------------------------------------------------------------\n\n\$(date)\nDietPi - Running weekly adlist update" >> /var/log/pihole.log
	/usr/local/bin/gravity.sh &>> /var/log/pihole.log
	echo -e "--------------------------------------------------------------------\n" >> /var/log/pihole.log

	service dnsmasq start

	exit 0
}

_EOF_

			chmod +x /etc/cron.weekly/pihole_adlist_update

			# - Prevent warning of missing file during gravity.sh: https://github.com/Fourdee/DietPi/issues/311#issuecomment-230276175
			#	NB: The contents of this file is not "currently" required for our installation.
			echo -e "#nothing here" > /etc/dnsmasq.d/01-pihole.conf

		fi

		#SUBSONIC 5/6
		#INSTALLING_INDEX=33/34
		if (( ${aSOFTWARE_INSTALL_STATE[33]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[34]} == 1 )); then

			#Generate user dir
			Create_UserContent_Folders

			#Optimize memory limit
			local subsonic_memory_max=$(( $(free -m -o | grep -m1 'Mem:' | awk '{print $2}') / 5 ))
			#Minimum cap 150mb
			if (( $subsonic_memory_max < 150 )); then

				subsonic_memory_max=150

			fi

			cat << _EOF_ > /etc/default/subsonic
SUBSONIC_USER=root
SUBSONIC_ARGS="--quiet --pidfile=/run/subsonic.pid --max-memory=$subsonic_memory_max --default-music-folder=$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC --default-podcast-folder=$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC --default-playlist-folder=$FP_DIETPI_USERDATA_DIRECTORY/$FOLDER_MUSIC"
_EOF_

			#Grab our test media for user
			Download_Test_Media

			#Symlink ffmpeg to subsonic transcoder
			#rpi armv6 jessie (using compiled ffmpeg)
			if (( $HW_MODEL < 2 )); then

				ln -fs /usr/local/bin/ffmpeg /var/subsonic/transcode

			#ARMv7
			else

				ln -fs /usr/bin/ffmpeg /var/subsonic/transcode

			fi

		fi

		#WEBIOPI
		INSTALLING_INDEX=71
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#auto start
			update-rc.d webiopi defaults

			WEBIOPI=2
		fi

		#DIETPICLOUDSHELL
		INSTALLING_INDEX=62
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Enable DietPi-Cloudshell autostart
			/DietPi/dietpi/dietpi-autostart 5

			#add alias
			if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cloudshell=' ) == 0 )); then

				sed -i "/#DietPi Additions/a alias dietpi-cloudshell='/DietPi/dietpi/dietpi-cloudshell'" /etc/bash.bashrc

			fi

		fi

		#HAPROXY
		INSTALLING_INDEX=98
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Create jail directory
			mkdir -p /var/lib/haproxy

			cat << _EOF_ > /etc/haproxy/haproxy.cfg
global

	#rsyslog is required for logging
	#log /var/log    local0
	#log /var/log    local1 notice
	maxconn 64
	#Jail directory
	chroot /var/lib/haproxy
	stats socket /run/haproxy.sock mode 660 level admin
	stats timeout 30s
	user root
	group root
	daemon

	# Default SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# Default ciphers to use on SSL-enabled listening sockets.
	# For more information, see ciphers(1SSL).
	ssl-default-bind-ciphers kEECDH+aRSA+AES:kRSA+AES:+AES256:RC4-SHA:!kEDH:!LOW:!EXP:!MD5:!aNULL:!eNULL

defaults

	log     global
	mode    http
	option  httplog
	option  dontlognull
	timeout connect 5000
	timeout client  50000
	timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

frontend localnodes

	bind *:80
	mode http
	default_backend nodes

backend nodes

	mode http
	balance roundrobin
	option forwardfor
	http-request set-header X-Forwarded-Port %[dst_port]
	http-request add-header X-Forwarded-Proto https if { ssl_fc }
	option httpchk HEAD / HTTP/1.1\r\nHost:localhost
	server web01 127.0.0.1:9000 check
	server web02 127.0.0.1:9001 check
	server web03 127.0.0.1:9002 check

#Admin web page

	listen stats *:1338
	stats enable
	stats uri /
	stats hide-version
	stats auth admin:dietpi
_EOF_

			#Add html error pages
			mkdir -p /etc/haproxy/errors
			local errorcode=0

			errorcode=400; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=403; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=408; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=500; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=502; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=503; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http
			errorcode=504; echo -e "[html]$errorcode[/html]" > /etc/haproxy/errors/"$errorcode".http

		fi

		#SQUEEZEBOXSERVER
		INSTALLING_INDEX=35
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Remove service
			update-rc.d logitechmediaserver remove
			rm /etc/init.d/logitechmediaserver

			#DietPi-Services init
			cp /DietPi/dietpi/conf/squeezeboxserver.service /etc/dietpi/dietpi-software/services/squeezeboxserver.service

			#Generate user dir
			Create_UserContent_Folders

			#Grab our test media for user
			Download_Test_Media

		fi

		#WORDPRESS
		INSTALLING_INDEX=55
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Create mysql DB
			/DietPi/dietpi/func/create_mysql_db wordpress dietpi root dietpi
			service mysql stop

		fi

		#TIGHTVNCSERVER & VNC4SERVER - Shared setup
		#INSTALLING_INDEX=27/28
		if (( ${aSOFTWARE_INSTALL_STATE[27]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[28]} == 1 )); then

			#User, enter PW
			if (( $USER_INPUTS )); then

				local entering_pw=1
				local loop_count=0

				WHIP_QUESTION='A password is required for your VNC Server.\n\nThe next screen will allow you to set your password, this password will be used when connecting from a VNC client/viewer.\n\nPress Ok/Enter when ready.'
				whiptail --title "VNC Server Password" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 13 70


				while (( $entering_pw == 1 )); do

					vncpasswd
					((loop_count++))

					# - Password file created
					if [ -f "$HOME"/.vnc/passwd ]; then

						entering_pw=0

					# - Endless loop
					elif (( $loop_count >= 30 )); then

						entering_pw=0

					fi

				done

			fi

			cat << _EOF_ > /etc/systemd/system/vncserver.service
[Unit]
Description=Manage VNC Server
After=dietpi-service.service
After=rc.local.service

[Service]
Type=idle
RemainAfterExit=yes
ExecStart=/bin/bash /usr/local/bin/vncserver start
ExecStop=/bin/bash /usr/local/bin/vncserver stop
User=root

[Install]
WantedBy=multi-user.target
_EOF_

			systemctl enable vncserver.service
			systemctl daemon-reload

			cat << _EOF_ > /usr/local/bin/vncserver
#!/bin/bash

#Globals
VNC_INSTALLED=0
BINARY_FP=0

WIDTH=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_width=' | sed 's/.*=//')
HEIGHT=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_height=' | sed 's/.*=//')
DEPTH=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_depth=' | sed 's/.*=//')
DISPLAY=\$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_vncserver_display=' | sed 's/.*=//')

#TightVNC or VNC4server?
if [ -f /usr/bin/vnc4server ]; then
    BINARY_FP='/usr/bin/vnc4server'
    VNC_INSTALLED=1
elif [ -f /usr/bin/vncserver ]; then
    BINARY_FP='/usr/bin/vncserver'
    VNC_INSTALLED=1
fi

#Exit if no VNC binary found
if (( ! \$VNC_INSTALLED )); then
    exit 1
fi

case "\$1" in
    start)
        \$BINARY_FP :\$DISPLAY -geometry \$WIDTH'x'\$HEIGHT -depth \$DEPTH
        ;;

    stop)
        \$BINARY_FP -kill :\$DISPLAY
        ;;

esac

exit 0
_EOF_
			chmod +x /usr/local/bin/vncserver

		fi

		#VNC4SERVER
		INSTALLING_INDEX=28
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			local cmd_launch_desktop=''
			#DESKTOP_LXDE
			if (( ${aSOFTWARE_INSTALL_STATE[23]} == 1 )); then

				cmd_launch_desktop='/usr/bin/lxsession -s LXDE &'

			#DESKTOP_MATE
			elif (( ${aSOFTWARE_INSTALL_STATE[24]} == 1 )); then

				cmd_launch_desktop='x-window-manager &'

			#DESKTOP_GNUSTEP
			elif (( ${aSOFTWARE_INSTALL_STATE[26]} == 1 )); then

				cmd_launch_desktop='x-window-manager &'

			#DESKTOP_XFCE
			elif (( ${aSOFTWARE_INSTALL_STATE[25]} == 1 )); then

				cmd_launch_desktop='/usr/bin/xfce4-session &'

			fi

			cat << _EOF_ > "$HOME"/.vnc/xstartup
[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
[ -r /root/.Xresources ] && xrdb /root/.Xresources
xsetroot -solid grey
vncconfig -iconic &
$cmd_launch_desktop
_EOF_

			chmod +x "$HOME"/.vnc/xstartup

		fi


		#FAIL2BAN
		INSTALLING_INDEX=73
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			cat << _EOF_ > /etc/fail2ban/fail2ban.conf
[Definition]
# loglevel #1=error #2=warn #3=info
loglevel = 3
logtarget = /var/log/fail2ban.log
socket = /var/run/fail2ban/fail2ban.sock
pidfile = /var/run/fail2ban/fail2ban.pid
_EOF_

			cp /DietPi/dietpi/conf/fail2ban_jail.conf /etc/fail2ban/jail.conf

		fi

		#PHPSYSINFO
		INSTALLING_INDEX=64
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#conf
			cp /DietPi/dietpi/conf/phpsysinfo.ini /var/www/phpsysinfo/phpsysinfo.ini

		fi

		#PHPIMAGEGALLERY
		INSTALLING_INDEX=56
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Get test images
			mkdir -p /var/www/gallery/DietPi
			wget http://dietpi.com/images/dietpi-logo_256.png -O /var/www/gallery/DietPi/logo_256.png

			mkdir -p /var/www/gallery/Tr-Zero
			wget http://media.indiedb.com/images/games/1/25/24673/SS_0.jpg -O /var/www/gallery/Tr-Zero/SS_0.jpg
			wget http://media.indiedb.com/images/games/1/25/24673/SS_44.jpg -O /var/www/gallery/Tr-Zero/SS_1.jpg
			wget http://media.indiedb.com/images/games/1/25/24673/3.png -O /var/www/gallery/Tr-Zero/SS_2.jpg

			#permissions for cache/thumbnail/database
			mkdir -p /var/www/gallery/_sfpg_data

			#enable (Some type of security trigger)
			sed -i "/define('SECURITY_PHRASE'/c\define('SECURITY_PHRASE', 'true');" /var/www/gallery/index.php

		fi

		#AMPACHE
		INSTALLING_INDEX=40
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Create_UserContent_Folders
			Download_Test_Media

			#create/insert our pre-made ampache sql db
			wget http://dietpi.com/downloads/mysql_databases/ampache_mysql_3.8.2-v113.zip -O sql.zip
			unzip sql.zip
			rm sql.zip

			/DietPi/dietpi/func/create_mysql_db ampache dietpi root dietpi
			mysql -u root -pdietpi ampache < ampache.sql
			rm ampache.sql

			#Grab config
			wget http://dietpi.com/downloads/conf/ampache.cfg.php_3.8.2-v113 -O /var/www/ampache/config/ampache.cfg.php

		fi

		#OPENVPNSERVER
		INSTALLING_INDEX=97
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			local key_size=1024

			#Start Cert/Key generation.
			cp -R /usr/share/easy-rsa/ /etc/openvpn
			mkdir -p /etc/openvpn/easy-rsa/keys
			cat << _EOF_ >> /etc/openvpn/easy-rsa/vars
export KEY_SIZE=$key_size
export KEY_COUNTRY="UK"
export KEY_PROVINCE="DietPi"
export KEY_CITY="DietPi"
export KEY_ORG="DietPi"
export KEY_EMAIL="noreply@DietPi.com"
export KEY_OU="DietPi"
export KEY_NAME="DietPi_OpenVPN_Server"
_EOF_

			#Create Server Cert Auth
			/DietPi/dietpi/func/dietpi-notify 2 "Generating unique OpenVPN certificates and keys. Please wait...\n"
			openssl dhparam -out /etc/openvpn/dh"$key_size".pem "$key_size"

			#Build Server certs/keys
			chmod -R +x /etc/openvpn/easy-rsa
			cd /etc/openvpn/easy-rsa
			. ./vars
			./clean-all
			./build-ca --batch DietPi_OpenVPN_Server
			./build-key-server --batch DietPi_OpenVPN_Server

			#Copy Server cert/keys
			cp /etc/openvpn/easy-rsa/keys/{DietPi_OpenVPN_Server.crt,DietPi_OpenVPN_Server.key,ca.crt} /etc/openvpn/

			#Build client cert/keys
			./build-key --batch DietPi_OpenVPN_Client

			cd ..
			#End Cert/Key generation.

			#Server config
			cat << _EOF_ > /etc/openvpn/server.conf
port 1194
proto udp
dev tun

ca ca.crt
cert DietPi_OpenVPN_Server.crt
key DietPi_OpenVPN_Server.key
dh dh$key_size.pem

server 10.8.0.0 255.255.255.0

client-to-client
keepalive 10 60
comp-lzo
max-clients 10

user nobody
group nogroup

persist-key
persist-tun
verb 3

#Web Forwarding (uncomment to enable)
#push "redirect-gateway"
#push "dhcp-option DNS 10.8.0.1"

_EOF_

			#Client config
			cat << _EOF_ > /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
client
proto udp
dev tun

#Ip/Domain name of DietPi system, running OpenVPN server.
remote mywebsite.com 1194

resolv-retry infinite
nobind

user nobody
group nogroup

persist-key
persist-tun

ns-cert-type server
comp-lzo
verb 3

_EOF_

			#Unified client file. Add DietPi generated certs/keys.
			# - Add Server Cert auth
			echo '<ca>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			cat /etc/openvpn/ca.crt >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			echo '</ca>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			# - Add Client Cert
			echo '<cert>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			cat /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.crt >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			echo '</cert>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			# - Add Client Key
			echo '<key>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			cat /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.key >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn
			echo '</key>' >> /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn

			#Copy client file to DietPi fileserver locations (/root or /mnt/usb_1)
			cp /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn "$FP_DIETPI_USERDATA_DIRECTORY"/
			# - and /boot partition
			cp /etc/openvpn/easy-rsa/keys/DietPi_OpenVPN_Client.ovpn /boot/

			#enable ipv4 forwarding
			sed -i '/net.ipv4.ip_forward=/c\net.ipv4.ip_forward=1' /etc/sysctl.conf

			#Web Fowarding (Setup IPtables, must also be run during boot)
			#iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o "$(sed -n 3p /DietPi/dietpi/.network)" -j MASQUERADE

		fi

		#WIFIHOTSPOT
		INSTALLING_INDEX=60
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			local eth_index=$(sed -n 1p /DietPi/dietpi/.network)
			local wifi_index=$(sed -n 2p /DietPi/dietpi/.network)

			# - DHCPD Config
			cat << _EOF_ > /etc/dhcp/dhcpd.conf
ddns-update-style none;
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;

subnet 192.168.42.0 netmask 255.255.255.0 {
        range 192.168.42.10 192.168.42.50;
        option broadcast-address 192.168.42.255;
        option routers 192.168.42.1;
        option domain-name "local";
        option domain-name-servers 8.8.8.8, 8.8.4.4;
}
_EOF_

			# - Assign wlan as interface for dhcp server.
			cat << _EOF_ > /etc/default/isc-dhcp-server
INTERFACES="wlan$wifi_index"
_EOF_

			# - Remove all entries below wlan, so we can recreate them.
			sed -i '/allow-hotplug wlan/q0' /etc/network/interfaces

			# - enable up wlan
			sed -i "/allow-hotplug wlan/c\allow-hotplug wlan$wifi_index" /etc/network/interfaces

			# - Add wifi settings to network interfaces config
			cat << _EOF_ >> /etc/network/interfaces
iface wlan$wifi_index inet static
address 192.168.42.1
netmask 255.255.255.0
#gateway 192.168.0.1
#wireless-essid FuzonWifi
#wireless-key abcde12345
#wireless-mode Managed
wireless-power off
#wpa-ssid FuzonWifi
#wpa-psk abcde12345
#dns-nameservers 8.8.8.8 8.8.4.4

# IP tables
up iptables-restore < /etc/iptables.ipv4.nat
_EOF_

			# - Assign static IP for wlan now
			ifconfig wlan$wifi_index 192.168.42.1

			# - Create access point config
			cat << _EOF_ > /etc/hostapd/hostapd.conf
interface=wlan$wifi_index
driver=nl80211
ssid=$(cat /DietPi/dietpi.txt | grep -m1 '^wifi_hotspot_ssid=' | sed 's/.*=//')
hw_mode=g
channel=$(cat /DietPi/dietpi.txt | grep -m1 '^wifi_hotspot_channel=' | sed 's/.*=//')
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=$(cat /DietPi/dietpi.txt | grep -m1 '^wifi_hotspot_key=' | sed 's/.*=//')
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
_EOF_

			# - Check for RTL8188C* device, use the patched driver with compiled binary: https://github.com/pritambaral/hostapd-rtl871xdrv#why
			if (( $WIFIHOTSPOT_RTL8188C_DEVICE )); then

				sed -i "/^driver=/c\driver=rtl871xdrv" /etc/hostapd/hostapd.conf

			fi

			# - Enable access point config
			cat << _EOF_ > /etc/default/hostapd
DAEMON_CONF="/etc/hostapd/hostapd.conf"
_EOF_

			# - Enable IPv4 forwarding
			sed -i "/net.ipv4.ip_forward=/c\net.ipv4.ip_forward=1" /etc/sysctl.conf
			echo 1 > /proc/sys/net/ipv4/ip_forward

			# - Apply iptables
			iptables -t nat -A POSTROUTING -o eth$eth_index -j MASQUERADE
			iptables -A FORWARD -i eth$eth_index -o wlan$wifi_index -m state --state RELATED,ESTABLISHED -j ACCEPT
			iptables -A FORWARD -i wlan$wifi_index -o eth$eth_index -j ACCEPT

			# - Save IP tables, applied during ifup in /etc/network/interfaces.
			iptables-save > /etc/iptables.ipv4.nat

			# - RPi 3 - onboard wifi, enable N
			if (( $HW_MODEL == 3 && ! $WIFIHOTSPOT_RTL8188C_DEVICE )); then

				# - Add Wireless N support
				echo -e "ieee80211n=1" >> /etc/hostapd/hostapd.conf

			fi

		fi

		#TORHOTSPOT
		INSTALLING_INDEX=61
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

# - Tor config
			cat << _EOF_ > /etc/tor/torrc
Log notice file /var/log/tor/notices.log
VirtualAddrNetwork 10.192.0.0/10
AutomapHostsSuffixes .onion,.exit
AutomapHostsOnResolve 1
TransPort 9040
TransListenAddress 192.168.42.1
DNSPort 53
DNSListenAddress 192.168.42.1
_EOF_

			# - Flush IP tables
			iptables -F
			iptables -t nat -F

			# - Generate tor prerouting tables
			local wifi_index=$(sed -n 2p /DietPi/dietpi/.network)
			iptables -t nat -A PREROUTING -i wlan$wifi_index -p tcp --dport 22 -j REDIRECT --to-ports 22
			iptables -t nat -A PREROUTING -i wlan$wifi_index -p udp --dport 53 -j REDIRECT --to-ports 53
			iptables -t nat -A PREROUTING -i wlan$wifi_index -p tcp --syn -j REDIRECT --to-ports 9040

			# - Save
			iptables-save > /etc/iptables.ipv4.nat

			# - Generate Logfile
			mkdir -p /var/log/tor
			echo 0 > /var/log/tor/notices.log
			chown -R debian-tor:nogroup /var/log/tor/notices.log

			# - User: Test tor is functional.
			#https://check.torproject.org

		fi

		#SHAIRPORTSYNC
		INSTALLING_INDEX=37
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Reduce min volume scale threshold (prevents hissing on low end soundcards eg:rpi)
			sed -i '/volume_range_db = /c\volume_range_db = 40;' /etc/shairport-sync.conf

			#set service user to root (mainly for for arm64, but no harm in doing it for all installs)
			sed -i '/^User=/d' /lib/systemd/system/shairport-sync.service &> /dev/null
			sed -i '/^Group=/d' /lib/systemd/system/shairport-sync.service &> /dev/null

		fi

		#BRUTEFIR
		INSTALLING_INDEX=38
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Copy configs and services
			cp /DietPi/dietpi/conf/brutefir_config /etc/BruteFIR/
			cp /DietPi/dietpi/conf/brutefir.service /etc/dietpi/dietpi-software/services/brutefir.service

			#Modules
			echo -e "snd-aloop" > /etc/modules-load.d/brutefir-alsa-loopback.conf
			echo -e "options snd-aloop id=BruteFIR enable=1 pcm_substreams=1 pcm_notify=1"	> /etc/modprobe.d/brutefir-alsa-loopback.conf

			#Asound.conf RPI
			cat << _EOF_ > /etc/asound.conf
pcm.!default {

	type plug

	slave {
		pcm {

			type hw
			card "BruteFIR"
			device 0
			channels 2
			format "S16_LE"
			rate 44100
		}
	}
}

ctl.!default {

	type hw
	card "BruteFIR"
}
_EOF_

		fi


		#PYDIO
		INSTALLING_INDEX=48
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Configure apache2
			# - Disable php output_buffering =
			sed -i '/output_buffering = /c\output_buffering = Off/' /etc/php5/apache2/php.ini
			# - Allow overrides and redirects
			sed -i "/AllowOverride /c\    AllowOverride All" /etc/apache2/sites-enabled/000-default*
			# - +Jessie
			sed -i "/AllowOverride /c\    AllowOverride All" /etc/apache2/apache2.conf

			# - Enable apache2 rewrite engine
			a2enmod rewrite

			# - Enable PHP mods
			php5enmod mcrypt
			php5enmod gd

			#Create Mysql DB
			/DietPi/dietpi/func/create_mysql_db pydio dietpi root dietpi

			#Setup Data directory
			local target_data_dir="$FP_DIETPI_USERDATA_DIRECTORY/pydio_data"

			# - Generate user data dir
			mkdir -p "$target_data_dir"

			# - move data structure
			mv /var/www/pydio/data/* "$target_data_dir"/
			rm -R /var/www/pydio/data
			ln -sf "$target_data_dir" /var/www/pydio/data

		fi


		#SQUEEZELITE
		INSTALLING_INDEX=36
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Specify buffers for RPi (prevents buffer underruns on default settings)
			# - Miliseconds

			# -- Nice big buffer for single cores
			if (( $CPU_CORES_TOTAL == 1 )); then

				sed -i '/SB_EXTRA_ARGS=/c\SB_EXTRA_ARGS="-a 180"' /etc/default/squeezelite

			# -- lapse buffer for >=2 cores
			else

				sed -i '/SB_EXTRA_ARGS=/c\SB_EXTRA_ARGS="-a 75"' /etc/default/squeezelite

			fi

			# - Buffer/period/bit
			#sed -i '/SB_EXTRA_ARGS=/c\SB_EXTRA_ARGS="-a 4096:8:16:0"' /etc/default/squeezelite

			Download_Test_Media

		fi

		#EMONHUB
		INSTALLING_INDEX=99
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - Copy configs
			cp /etc/emonhub/conf/default/emonhub /etc/default/emonhub

			# - Setup service
			cp /etc/emonhub/service/emonhub /etc/init.d/emonhub
			chmod +x /etc/init.d/emonhub
			update-rc.d emonhub defaults

			chmod +x -R /etc/emonhub

			#RPI 3 - Must disable BCM BT to recover UART 0
			if (( $HW_MODEL == 3 )); then

				# - Add DToverlay to disable bluetooth
				if (( $(cat /DietPi/config.txt | grep -ci -m1 '=pi3-disable-bt') == 0 )); then

					echo -e "\ndtoverlay=pi3-disable-bt" >> /DietPi/config.txt

				# - Enable
				else

					sed -i '/pi3-disable-bt/c\dtoverlay=pi3-disable-bt' /DietPi/config.txt

				fi

				# - Disable bluetooth service
				systemctl stop hciuart
				systemctl disable hciuart

			fi

			#RPi - Disable serial tty that emonPi uses.
			/DietPi/dietpi/func/dietpi-set_hardware serialconsole disable

			# - Apply user API KEY
			USER_EMONHUB_APIKEY_CURRENT=$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_emonhub_apikey=' | sed 's/.*=//')
			sed -i "/apikey/c\        apikey = $USER_EMONHUB_APIKEY_CURRENT" /etc/emonhub/conf/emonhub.conf

		fi

		#RPIMONITOR
		INSTALLING_INDEX=66
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - Update apt package stats
			/usr/share/rpimonitor/scripts/updatePackagesStatus.pl

			# - USBdrive stats implimentation by Rich
			if (( $USBDRIVE )); then

				sed -i '\/include=\/etc\/rpimonitor\/template\/sdcard.conf/a include=\/etc\/rpimonitor\/template\/usb_hdd.conf' /etc/rpimonitor/data.conf

				cat << _EOF_ > /etc/rpimonitor/template/usb_hdd.conf
########################################################################
# Extract USB HDD (sda1) information
#  Page: 1
#  Information               Status     Statistics
#  - USBHDD1 total          - yes      - yes
#  - USBHDD1 used           - yes      - yes
########################################################################
static.10.name=usbhdd_total
static.10.source=df -t ext4
static.10.regexp=sda1\s+(\d+)
static.10.postprocess=\$1/1024

dynamic.14.name=usbhdd_used
dynamic.14.source=df -t ext4
dynamic.14.regexp=sda1\s+\d+\s+(\d+)
dynamic.14.postprocess=\$1/1024
dynamic.14.rrd=GAUGE

web.status.1.content.9.name=USB HDD
web.status.1.content.9.icon=usb_hdd.png
web.status.1.content.9.line.1="<b>/sda1</b> Used: <b>"+KMG(data.usbhdd_used,'M')+"</b> (<b>"+Percent(data.udbhdd_used,data.usbhdd_total,'M')+"</b>) Free: <b>"+KMG(data.usbhdd_total-data.usbhdd_used,'M')+ "</b> Total: <b>"+ KMG(data.usbhdd_total,'M') +"</b>"
web.status.1.content.9.line.2=ProgressBar(data.usbhdd_used,data.usbhdd_total)

web.statistics.1.content.9.name=USB HDD
web.statistics.1.content.9.graph.1=usbhdd_total
web.statistics.1.content.9.graph.2=usbhdd_used
web.statistics.1.content.9.ds_graph_options.usbhdd_total.label=USB HDD total space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_total.color="#FF7777"
web.statistics.1.content.9.ds_graph_options.usbhdd_used.label=USB HDD used space (MB)
web.statistics.1.content.9.ds_graph_options.usbhdd_used.lines={ fill: true }
web.statistics.1.content.9.ds_graph_options.usbhdd_used.color="#7777FF"
_EOF_

			fi

		fi

		#NETDATA
		INSTALLING_INDEX=65
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - service
			cat << _EOF_ > /etc/systemd/system/netdata.service
[Unit]
Description=netdata
After=network.target httpd.service squid.service nfs-server.service mysqld.service named.service postfix.service

[Service]
Type=forking
WorkingDirectory=/tmp
User=root
Group=root
PIDFile=/var/run/netdata.pid
ExecStart=/usr/sbin/netdata -pidfile /var/run/netdata.pid
ExecStop=/bin/kill -SIGTERM \$MAINPID

TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
_EOF_

			systemctl daemon-reload

			# - Create netdata user/group
			getent group netdata > /dev/null || groupadd -r netdata
			getent passwd netdata > /dev/null || useradd -r -g netdata -c netdata -s /sbin/nologin -d / netdata

			for x in /var/cache/netdata /usr/share/netdata/web /etc/netdata /var/log/netdata; do

				chown -R netdata.netdata $x
				chmod 0775 -R $x

			done

			# - Workaround to prevent update checks and the "distracting update flashing button": https://github.com/firehol/netdata/issues/233#issuecomment-210468649
			#echo 0 > /usr/share/netdata/web/version.txt

		fi

		#BAIKAL
		INSTALLING_INDEX=57
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Install_Apply_Permissions

			# - install/run composer | Also run for ampache. Move this to a global function....
			php -r "readfile('https://getcomposer.org/installer');" > composer-setup.php
			php composer-setup.php
			php -r "unlink('composer-setup.php');"

			mv composer.phar /usr/local/bin/composer

			cd /var/www/baikal
			composer install --no-interaction
			cd ~/

			# - Mysql DB
			/DietPi/dietpi/func/create_mysql_db baikal dietpi root dietpi

		fi

		#MUMBLESERVER
		INSTALLING_INDEX=43
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Cap total connections
			sed -i '/users=/c\users=40' /etc/mumble-server.ini

			if (( $CPU_CORES_TOTAL == 1 )); then

				sed -i '/users=/c\users=8' /etc/mumble-server.ini

			fi

			#Name the root channel
			sed -i '/registerName=/c\registerName=DietPi Mumble Server' /etc/mumble-server.ini

			#Disable DB logging
			sed -i '/logdays=/c\logdays=-1' /etc/mumble-server.ini

		fi

		#EMBYSERVER
		INSTALLING_INDEX=41
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Create_UserContent_Folders
			Download_Test_Media

		fi

		#PLEXMEDIASERVER
		INSTALLING_INDEX=42
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Create_UserContent_Folders
			Download_Test_Media

			#For all ARM devices:
			# - en_US.UTF8 must be installed and the default locale on system. This is for SBC installs using dev2day repo: https://github.com/Fourdee/DietPi/issues/116#issuecomment-222195911
			if (( $USER_INPUTS &&
				$HW_ARCH < 20 && ! $(locale | grep -ci -m1 'en_US.UTF-8') )); then

				sed -i '/en_US.UTF-8 UTF-8/c\en_US.UTF-8 UTF-8' /etc/locale.gen
				locale-gen

				WHIP_QUESTION='Plex Media Server requires en_US.UTF8 locale to be installed and set to default, else, Plex will not start.\n\nOn the next screen:\n - Press enter (Do not make any changes to the selections, we have already selected en_US.UTF8 for you).\n\nOn the screen after:\n - Select en_US.UTF8 and press enter.'
				whiptail --title "Plex en_US.UTF8" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 16 70

				dpkg-reconfigure locales

			fi

		fi

		#CUBERITE
		INSTALLING_INDEX=52
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			cat << _EOF_ > /etc/systemd/system/cuberite.service
[Unit]
Description=Cuberite Server

[Service]
Type=oneshot
WorkingDirectory=/etc/cubrite
ExecStart=/etc/cubrite/Cuberite --service
ExecStop=/usr/bin/killall -w Cuberite
RemainAfterExit=yes
User=root

[Install]
WantedBy=multi-user.target
_EOF_
systemctl enable cuberite.service
systemctl daemon-reload

			#WebUI settings
			cat << _EOF_ > /etc/cubrite/webadmin.ini
[User:root]
Password=dietpi

[WebAdmin]
Ports=1339
Enabled=1
_EOF_

		fi

		#MINEOS
		INSTALLING_INDEX=53
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Stop mineos from running while we config it. When we didnt do this, the program would constantly overwrite our symlink from (/var/games/minecraft).
			/DietPi/dietpi/dietpi-services stop
			killall -w supervisord &> /dev/null
			killall -w node &> /dev/null
			killall -w nodejs &> /dev/null

			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/minecraft/mineos_console.js /usr/local/bin/mineos

			cp "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/minecraft/mineos.conf /etc/mineos.conf

			# - setup SSL cert
			cd "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/minecraft
			./generate-sslcert.sh

			# - Supervisor service
			cp "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/minecraft/init/supervisor_conf /etc/supervisor/conf.d/mineos.conf

			cd "$HOME"

			# - Add underprivilged user for web access
			useradd mineos
			echo -e "dietpi\ndietpi\n" | passwd mineos

			# - Move server data storage to userdata dir (High disk writes)
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/serverdata
			mkdir -p /var/games #sometimes this is not created by mineos after installation... Ensures symlink creation does not fail.
			cp -R /var/games/minecraft/* "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/serverdata/ #Folder does not exist during installation, as of 18/09/16
			rm -R /var/games/minecraft

			ln -sf "$FP_DIETPI_USERDATA_DIRECTORY"/mineos/serverdata /var/games/minecraft

			chown -R mineos:mineos /var/games/minecraft

			# - correct the node filepath for supervisor mineos
			sed -i '/^command=/c\command=/usr/local/bin/node webui.js' /etc/supervisor/conf.d/mineos.conf

			# - Set directory to FP_DIETPI_USERDATA_DIRECTORY
			sed -i "/^directory=/c\directory=$FP_DIETPI_USERDATA_DIRECTORY/mineos/minecraft" /etc/supervisor/conf.d/mineos.conf

			supervisorctl reload

		fi

		#GOGS
		INSTALLING_INDEX=49
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - Data storage / user data
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/gogs-repo

			# - sqldb
			/DietPi/dietpi/func/create_mysql_db gogs dietpi root dietpi

			# - service (couldnt get this to run as a new thread with systemD (&). so bash script ftw.
			cat << _EOF_ > /etc/gogs/start.sh
#!/bin/bash
#Simple script to start gogs for DietPi systems
/etc/gogs/gogs web &> /var/log/gogs_daemon.log &
exit
_EOF_

			chmod +x /etc/gogs/start.sh

			cat << _EOF_ > /etc/systemd/system/gogs.service
[Unit]
Description=DietPi Gogs service
DefaultDependencies=no

[Service]
Type=oneshot
RemainAfterExit=yes
User=root
ExecStart=/bin/bash /etc/gogs/start.sh
ExecStop=/usr/bin/killall -w gogs
StandardOutput=tty

[Install]
WantedBy=multi-user.target
_EOF_

		fi

		#QBITTORRENT
		INSTALLING_INDEX=46
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			Create_UserContent_Folders

			# - conf.
			mkdir -p "$HOME"/.config/qBittorrent
			cat << _EOF_ > "$HOME"/.config/qBittorrent/qBittorrent.conf
[General]
ported_to_new_savepath_system=true

[Preferences]
Downloads\DiskWriteCacheSize=$(Optimize_BitTorrent 0)
Downloads\DiskWriteCacheTTL=60
Queueing\MaxActiveDownloads=$(Optimize_BitTorrent 1)
Queueing\MaxActiveTorrents=$(Optimize_BitTorrent 1)
Queueing\MaxActiveUploads=1
Queueing\IgnoreSlowTorrents=false
Bittorrent\MaxConnecs=$(Optimize_BitTorrent 2)
Bittorrent\MaxConnecsPerTorrent=$(Optimize_BitTorrent 2)
Bittorrent\MaxUploads=$(Optimize_BitTorrent 3)
Bittorrent\MaxUploadsPerTorrent=$(Optimize_BitTorrent 3)
WebUI\Port=1340
WebUI\Enabled=true
General\Locale=en_GB
Downloads\SavePath=$FP_DIETPI_USERDATA_DIRECTORY/downloads
Downloads\TempPathEnabled=false
Downloads\TempPath=$FP_DIETPI_USERDATA_DIRECTORY/downloads
Downloads\ScanDirs=@Invalid()
Downloads\DownloadInScanDirs=@Invalid()
Downloads\TorrentExportDir=
MailNotification\enabled=false
MailNotification\email=
MailNotification\smtp_server=smtp.changeme.com
MailNotification\req_ssl=false
MailNotification\req_auth=false
MailNotification\username=
MailNotification\password=
Downloads\PreAllocation=false
Queueing\QueueingEnabled=false
Downloads\UseIncompleteExtension=false
Connection\PortRangeMin=6881
Connection\UPnP=true
Connection\GlobalDLLimit=-1
Connection\GlobalUPLimit=-1
Bittorrent\uTP=true
Bittorrent\uTP_rate_limited=false
Advanced\IncludeOverhead=false
Connection\GlobalDLLimitAlt=10
Connection\GlobalUPLimitAlt=10
Scheduler\Enabled=false
Bittorrent\DHT=true
Bittorrent\sameDHTPortAsBT=true
Bittorrent\DHTPort=6881
Bittorrent\PeX=true
Bittorrent\LSD=true
Bittorrent\Encryption=1
Advanced\AnonymousMode=false
Connection\ProxyType=-1
Connection\Proxy\IP=0.0.0.0
Connection\Proxy\Port=8080
Connection\ProxyPeerConnections=false
Connection\Proxy\Authentication=false
Connection\Proxy\Username=
Connection\Proxy\Password=
IPFilter\Enabled=false
IPFilter\File=
WebUI\Username=root
WebUI\LocalHostAuth=true
WebUI\HTTPS\Enabled=false
DynDNS\Enabled=false
DynDNS\Service=0
DynDNS\Username=
DynDNS\Password=
DynDNS\DomainName=changeme.dyndns.org
WebUI\Password_ha1=@ByteArray(5e434b0004be6970cf8878fcf929baba)

[LegalNotice]
Accepted=true

[AutoRun]
enabled=false
program=
_EOF_

			# - service
			cat << _EOF_ > /etc/systemd/system/qbittorrent.service
[Unit]
Description=qBittorrent Daemon Service
After=network.target

[Service]
Type=oneshot
User=root
RemainAfterExit=yes
ExecStart=/usr/bin/qbittorrent-nox -d --webui-port=1340
ExecStop=/usr/bin/killall -w qbittorrent-nox

[Install]
WantedBy=multi-user.target
_EOF_

			systemctl daemon-reload

		fi

		#RTORRENT
		INSTALLING_INDEX=107
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			#Create username/password for rutorrent based on webserver type.
			# - Apache2
			if (( ${aSOFTWARE_INSTALL_STATE[83]} >= 1 )); then

				# - Allow overrides redirects and .htaccess
				sed -i "/AllowOverride /c\    AllowOverride All" /etc/apache2/sites-enabled/000-default*
				sed -i "/AllowOverride /c\    AllowOverride All" /etc/apache2/apache2.conf

				a2enmod rewrite

				#install scgi module
				AGI libapache2-mod-scgi

				htpasswd -cb /etc/.rutorrent-htaccess root dietpi
				cat << _EOF_ > /var/www/rutorrent/.htaccess
AuthUserFile /etc/.rutorrent-htaccess
AuthName "ruTorrent_login"
AuthType Basic
require user root
_EOF_

				cat << _EOF_ > /etc/apache2/sites-available/rutorrent.conf
SCGIMount /RPC2 127.0.0.1:5000
<location /RPC2>
AuthName "rTorrent secure access"
AuthType Basic
AuthBasicProvider file
AuthUserFile /etc/.rutorrent-htaccess
Require user root
</location>
_EOF_
				ln -s /etc/apache2/sites-available/rutorrent.conf /etc/apache2/sites-enabled/rutorrent.conf

			# - Lighttpd
			elif (( ${aSOFTWARE_INSTALL_STATE[84]} >= 1 )); then

				echo -e "root:rtorrent:$(echo -n "root:rtorrent:dietpi" | md5sum | cut -b -32)" > /etc/.rutorrent-htaccess

				# - add to /etc/lighttpd/lighttpd.conf
				if (( ! $(cat /etc/lighttpd/lighttpd.conf | grep -ci -m1 '^#RUTORRENT_DIETPI') )); then

					cat << _EOF_ >> /etc/lighttpd/lighttpd.conf
#RUTORRENT_DIETPI
server.modules += ( "mod_fastcgi" )
server.modules += ( "mod_scgi" )
server.modules += ( "mod_auth" )
auth.debug = 0
auth.backend = "htdigest"
auth.backend.htdigest.userfile = "/etc/.rutorrent-htaccess"

auth.require = ( "/rutorrent/" => (
                    "method"  => "digest",
                    "realm"   => "rtorrent",
                    "require" => "valid-user"
               ))

scgi.server = ( "/RPC2" =>
    ( "127.0.0.1" =>
        (
            "host" => "127.0.0.1",
            "port" => 5000,
            "check-local" => "disable"
        )
    )
)
#RUTORRENT_DIETPI
_EOF_

				fi

			# - Nginx
			elif (( ${aSOFTWARE_INSTALL_STATE[85]} >= 1 )); then

				echo "root:$(openssl passwd -crypt dietpi)" > /etc/.rutorrent-htaccess

				cat << _EOF_ > /etc/nginx/sites-dietpi/rutorrent.config
location /rutorrent {
    auth_basic "Restricted Content";
    auth_basic_user_file /etc/.rutorrent-htaccess;
}

location /RPC2 {
    include scgi_params;
    scgi_pass 127.0.0.1:5000;
}
_EOF_

			fi

			# - Define curl location in config.php (for lighttpd and nginx)
			sed -i '/"curl"[[:space:]]/c\        "curl" => "/usr/bin/curl",' /var/www/rutorrent/conf/config.php

			chown www-data:www-data /etc/.rutorrent-htaccess
			chmod 400 /etc/.rutorrent-htaccess

			# - Session folder
			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/downloads/.session

			# - Service using screen | '/usr/bin/rtorrent &> /var/log/rtorrent.log &' doesnt work, hangs program after 5 seconds
			cat << _EOF_ > /etc/systemd/system/rtorrent.service
[Unit]
Description=rTorrent
After=network.target

[Service]
User=root
Type=forking
KillMode=none
ExecStart=/usr/bin/screen -d -m -fa -S rtorrent /usr/bin/rtorrent
ExecStop=/usr/bin/killall -w -s 2 /usr/bin/rtorrent
WorkingDirectory=%h

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl daemon-reload

			#Default conf
			cat << _EOF_ > "$HOME"/.rtorrent.rc
#Attempt to reduce disk throttling/abuse | 0.9.2 command does not exist
#max_open_files = 50

#Max queue
scheduler.max_active.set = 3

#byte value
max_memory_usage = $(( $(Optimize_BitTorrent 0) * 1024 * 1024 ))

# Maximum and minimum number of peers to connect to per torrent.
min_peers = 1
max_peers = $(( $(Optimize_BitTorrent 2) / 2 + 1 ))

# Same as above but for seeding completed torrents (-1 = same as downloading)
min_peers_seed = -1
max_peers_seed = -1

# Maximum number of simultaneous downloads
max_downloads_global = $(Optimize_BitTorrent 2)
# Maximum number of simultaneous uploads
max_uploads_global = $(Optimize_BitTorrent 3)

# Global upload and download rate in KiB. "0" for unlimited.
download_rate = 0
upload_rate = 0

# Default directory to save the downloaded torrents.
directory = $FP_DIETPI_USERDATA_DIRECTORY/downloads

# Default session directory. Make sure you don't run multiple instance
# of rtorrent using the same session directory. Perhaps using a
# relative path?
session = $FP_DIETPI_USERDATA_DIRECTORY/downloads/.session

# Close torrents when diskspace is low.
schedule = low_diskspace,5,60,close_low_diskspace=1000M

# Periodically save session data
schedule = session_save,240,300,session_save=

# Enable the default ratio group.
ratio.enable=yes
# Change the limits, the defaults should be sufficient.
# Upload to a minimum ratio of 1.01
ratio.min.set=101
# Upload to a maximum ratio of 1.25
ratio.max.set=125
# Upload a minimum of x MB
ratio.upload.set=1M

# When seeding ratio is reached close the torrent
system.method.set = group.seeding.ratio.command, d.close=

# Move files to ./unsorted when download completes
system.method.set_key = event.download.finished,move_complete,"execute=mv,-n,$d.get_base_path=,./unsorted/;d.set_directory=./unsorted/"

# Port range to use for listening.
port_range = 33101-33199

# Start opening ports at a random position within the port range.
port_random = yes

# Encryption options, set to none (default) or any combination of the following:
# allow_incoming, try_outgoing, require, require_RC4, enable_retry, prefer_plaintext
#
# The example value allows incoming encrypted connections, starts unencrypted
# outgoing connections but retries with encryption if they fail, preferring
# plaintext to RC4 encryption after the encrypted handshake
#
encryption = require

# Sort the main view by ratio
view.sort_current = main,greater=d.get_ratio=
view.sort_new = main,less=d.get_ratio=
view.sort = main

# Sort the seeding view by the upload rate and only show torrents with peers
view.sort_current = seeding,greater=d.get_up_rate=
view.filter = seeding,"and=d.get_complete=,d.get_peers_connected="
view.sort_new = seeding,less=d.get_up_rate=
view.sort = seeding

# Sort the leeching view by name
view.sort_current = leeching,greater=d.get_name=
view.sort_new = leeching,greater=d.get_name=
view.sort = leeching

# Filter the active view by connected peers
view.sort_current = active,less=d.get_name=
view.sort_new = leeching,less=d.get_name=
view.filter = active,d.get_peers_connected=
view.sort = active

schedule = sort_main,11,5,view.sort=main
schedule = sort_seeding,12,5,view.sort=seeding
schedule = sort_leeching,13,5,view.sort=leeching
schedule = sort_active,14,5,view.sort=active

# Enable DHT support for trackerless torrents or when all trackers are down.
# May be set to "disable" (completely disable DHT), "off" (do not start DHT),
# "auto" (start and stop DHT as needed), or "on" (start DHT immediately).
# The default is "off". For DHT to work, a session directory must be defined.
#
dht = auto

# UDP port to use for DHT.
#
#dht_port = 6881

# Enable peer exchange (for torrents not marked private)
#
peer_exchange = yes

#Enable remote access (eg: webui)
scgi_port = localhost:5000

_EOF_


		fi

		#SYNCTHING
		INSTALLING_INDEX=50
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			# - run syncthing to create cert/config and exit
			syncthing -generate="/$HOME/.config/syncthing"

			# - Disable automatic upgrades
			sed -i '/<\/autoUpgradeIntervalH>/c\        <autoUpgradeIntervalH>0<\/autoUpgradeIntervalH>' "$HOME"/.config/syncthing/config.xml

			# - Allow external access (LAN).
			sed -i '/:8384<\/address>/c\        <address>0.0.0.0:8384<\/address>' "$HOME"/.config/syncthing/config.xml

			# - Set default folder
			sed -i '/label=\"Default Folder/c\    <folder id=\"0000-0000\" label=\"DietPi user data\" path=\"/mnt/dietpi_userdata/\" type=\"readwrite\" rescanIntervalS=\"60\" ignorePerms=\"false\" autoNormalize=\"true\">' "$HOME"/.config/syncthing/config.xml

			# - Disable browser starting
			sed -i '/<\/startBrowser>/c\        <startBrowser>false<\/startBrowser>' "$HOME"/.config/syncthing/config.xml

			# service
			cat << _EOF_ > /etc/systemd/system/syncthing.service
[Unit]
Description=Syncthing

[Service]
Type=oneshot
ExecStart=/bin/bash -c '/usr/bin/syncthing > /var/log/syncthing.log &'
ExecStop=/usr/bin/killall -w syncthing
RemainAfterExit=yes
User=root

[Install]
WantedBy=multi-user.target
_EOF_
			systemctl enable syncthing.service
			systemctl daemon-reload

		fi

		#Urbackup server
		INSTALLING_INDEX=111
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then

			mkdir -p "$FP_DIETPI_USERDATA_DIRECTORY"/urbackup/urbackup_tmp_files

			#As we have /tmp mounted to RAM, change tmp locations
			sed -i '/DAEMON_TMPDIR=/c\DAEMON_TMPDIR="/var/tmp"' /etc/default/urbackupsrv

		fi

		#Chromium
		INSTALLING_INDEX=113
		if (( ${aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]} == 1 )); then


			#RPi enable and use OpenGL
			if (( $HW_MODEL >= 2 && $HW_MODEL < 10 )); then

				/DietPi/dietpi/func/dietpi-set_hardware rpi-opengl enable

				# - Allow root and disable sandbox (blank screen without)
				sed -i '/Exec=/c\Exec=chromium --no-sandbox --user-data-dir --temp-profile' /usr/share/applications/chromium.desktop

			#GLES
			else

				# - Allow root, egl and disable sandbox (blank screen without)
				sed -i '/Exec=/c\Exec=chromium --no-sandbox --use-gl=egl --user-data-dir --temp-profile' /usr/share/applications/chromium.desktop

			fi

			#Symlink to desktop
			ln -sf /usr/share/applications/chromium.desktop "$HOME"/Desktop/chromium.desktop

		fi

		#-------------------------------------------------------------------

	}

	Install_Apply_GPU_Settings(){

		local gpu_enabled=0
		local gpu_memory=0

		#Define Memory Split Modes with installed software
		#Mode 4 RPI ONLY (Descent HIGH GPU RAM / 192MB)
		if (( ${aSOFTWARE_INSTALL_STATE[112]} == 2 )); then

			gpu_enabled=1
			gpu_memory=192

		#Define Memory Split Modes with installed software
		#Mode 3 (KODI / DIETPICAM / UAE4ARM / MED GPU RAM / 128MB)
		elif (( ${aSOFTWARE_INSTALL_STATE[31]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[59]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[108]} == 2 )); then

			gpu_enabled=1
			gpu_memory=128

		#Mode 2 (Desktop / LOW GPU RAM)
		#All DESKTOP_* and OPENTYRIAN
		elif (( ${aSOFTWARE_INSTALL_STATE[23]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[24]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[25]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[26]} == 2 ||
			${aSOFTWARE_INSTALL_STATE[51]} == 2 )); then

			gpu_enabled=1
			gpu_memory=64

		#Mode 1 - DIETPICLOUDSHELL (forces display output)
		elif (( ${aSOFTWARE_INSTALL_STATE[62]} == 2 )); then

			gpu_enabled=1

		fi

		#Apply
		if (( $gpu_memory > 0 )); then

			#RPi
			if (( $HW_MODEL < 10 )); then

				sed -i "/gpu_mem_256=/c\gpu_mem_256=$gpu_memory" /DietPi/config.txt
				sed -i "/gpu_mem_512=/c\gpu_mem_512=$gpu_memory" /DietPi/config.txt
				sed -i "/gpu_mem_1024=/c\gpu_mem_1024=$gpu_memory" /DietPi/config.txt

			fi

		fi

		if (( $gpu_enabled )); then

			#RPi
			if (( $HW_MODEL < 10 )); then

				sed -i "/rpi_hdmi_output=/c\rpi_hdmi_output=1" /DietPi/dietpi.txt

			#odroid C1
			elif (( $HW_MODEL == 10 )); then

				sed -i '/setenv hdmioutput /c\setenv hdmioutput "1"' /DietPi/boot.ini
				sed -i '/setenv vpu /c\setenv vpu "1"' /DietPi/boot.ini
				sed -i '/setenv m_bpp /c\setenv m_bpp "32"' /DietPi/boot.ini

			#Odroid C2
			elif (( $HW_MODEL == 12 )); then

				sed -i '/setenv nographics /c\setenv nographics "0"' /DietPi/boot.ini

			fi

		fi

	}

	Dedicated_Usb_Drive_Enable(){

		USBDRIVE=0

		#Only enable if mounted
		if (( $(df -P | grep -ci -m1 "$FP_DIETPI_DEDICATED_USBDRIVE") )); then

			USBDRIVE=1

		fi

	}

	Uninstall_Software(){

		#----------------------------------------------------------------------
		#Inform User
		/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Uninstall"

		echo -e ""
		/DietPi/dietpi/func/dietpi-notify 0 "Uninstalling ${aSOFTWARE_WHIP_NAME[$1]}: ${aSOFTWARE_WHIP_DESC[$1]}\n"

		#Was a uninstall event trigged?
		local valid_input=1

		#----------------------------------------------------------------------
		#DIETPI SOFTWARE
		if (( $1 == 100 )); then

			grasshopper_directory='/var/www'
			rm -R "$grasshopper_directory"/documentation
			rm -R "$grasshopper_directory"/css
			rm -R "$grasshopper_directory"/db
			rm -R "$grasshopper_directory"/exec
			rm -R "$grasshopper_directory"/includes
			rm -R "$grasshopper_directory"/install
			rm -R "$grasshopper_directory"/phpliteadmin
			rm -R "$grasshopper_directory"/js
			rm -R "$grasshopper_directory"/setup
			rm -R "$grasshopper_directory"/pics
			rm -R "$grasshopper_directory"/themes
			rm "$grasshopper_directory"/favicon.ico
			rm "$grasshopper_directory"/index.php
			#PDF documentation
			rm "$grasshopper_directory"/Grasshopper*

			update-rc.d grasshopper remove
			rm /etc/init.d/grasshopper

		elif (( $1 == 23 )); then

			AGP lxde lxde-* upower policykit-1 iceweasel p7zip-full

		elif (( $1 == 24 )); then

			AGP mate-desktop-environment-extras upower policykit-1 iceweasel p7zip-full

		elif (( $1 == 26 )); then

			AGP x-window-system-core wmaker gnustep gnustep-devel gnustep-games upower policykit-1 iceweasel p7zip-full

		elif (( $1 == 25 )); then

			AGP xfce4 gnome-icon-theme tango-icon-theme iceweasel p7zip-full

		elif (( $1 == 22 )); then

			AGP quiterss

		elif (( $1 == 30 )); then

			AGP nomachine

		elif (( $1 == 29 )); then

			AGP xrdp

		elif (( $1 == 44 )); then

			AGP transmission-daemon
			rm /etc/init.d/transmission-daemon &> /dev/null
			rm /etc/systemd/system/transmission-daemon.service &> /dev/null

		elif (( $1 == 83 )); then

			AGP apache2

		elif (( $1 == 85 )); then

			AGP nginx

		elif (( $1 == 84 )); then

			AGP lighttpd

		elif (( $1 == 86 )); then

			AGP mysql-server

		elif (( $1 == 88 )); then

			AGP mariadb-server mariadb-client
			# - Remove debian flag generated by mariaDB install that prevents mysql 5.5 being installed.
			rm /var/lib/mysql/debian-*

		elif (( $1 == 87 )); then

			AGP sqlite3

		elif (( $1 == 91 )); then

			AGP redis-server

		elif (( $1 == 89 )); then

			AGP php5 libapache2-mod-php5 php5-fpm php5-cgi php5-mysql php5-curl php5-sqlite php-apc php5-apcu
			rm /var/www/phpinfo.php
			rm /var/www/apc.php
			rm /var/www/opcache.php
			rm /etc/php5/fpm/pool.d/www.conf
			#temp php uploads
			rm -R /var/tmp/php_upload_tmp

		elif (( $1 == 90 )); then

			AGP phpmyadmin

		elif (( $1 == 54 )); then

			service mysql start
			mysqladmin -u root -pdietpi drop phpbb3 -f
			rm -R /var/www/phpBB3

		elif (( $1 == 47 )); then

			AGP owncloud
			service mysql start
			mysqladmin -u root -pdietpi drop owncloud -f
			rm /etc/apt/sources.list.d/owncloud.list
			apt-get update
			rm -R /var/www/owncloud

		elif (( $1 == 114 )); then

			service mysql start
			mysqladmin -u root -pdietpi drop nextcloud -f
			rm -R /var/www/nextcloud

		elif (( $1 == 115 )); then

			AGP webmin

		elif (( $1 == 32 )); then

			AGP mpd libmpdclient2
			update-rc.d ympd remove
			rm /etc/init.d/ympd
			rm /usr/bin/ympd

		elif (( $1 == 31 )); then

			AGP kodi
			#+Odroids
			AGP kodi-odroid
			rm /usr/share/applications/kodi.desktop
			rm ~/Desktop/kodi.desktop

		elif (( $1 == 39 )); then

			AGP minidlna

		elif (( $1 == 51 )); then

			AGP ibsdl1.2debian libsdl-net1.2
			rm -R /usr/local/games/opentyrian
			rm /usr/share/applications/opentyrian.desktop
			rm ~/Desktop/opentyrian.desktop

		elif (( $1 == 59 )); then

			AGP gpac motion
			rm -R /var/www/dietpicam
			rm /opt/vc/bin/raspimjpeg
			rm /usr/bin/raspimjpeg
			rm /etc/dietpi/dietpi-software/services/raspimjpeg.service
			rm /etc/raspimjpeg
			rm /etc/motion/motion.conf

		elif (( $1 == 45 )); then

			AGP deluged deluge-web deluge-webui deluge-console
			rm /etc/dietpi/dietpi-software/services/deluge.service
			rm -R ~/.config/deluge

		elif (( $1 == 94 )); then

			AGP proftpd-basic

		elif (( $1 == 96 )); then

			AGP samba samba-common-bin

		elif (( $1 == 95 )); then

			AGP vsftpd

		elif (( $1 == 109 )); then

			AGP nfs-kernel-server

		elif (( $1 == 67 )); then

			update-rc.d noip2 remove
			rm /usr/local/bin/noip2
			rm /etc/init.d/noip2

		elif (( $1 == 106 )); then

			rm -R /var/www/raspcontrol
			rm -R /etc/raspcontrol

		elif (( $1 == 63 )); then

			rm -R /var/www/linuxdash

		elif (( $1 == 93 )); then

			AGP dnsmasq
			rm /etc/dnsmasq.conf
			rm /usr/local/bin/gravity.sh
			rm /usr/local/bin/chronometer.sh
			rm -R /var/www/pihole
			rm -R /etc/pihole
			rm -R /etc/.pihole
			rm -R /opt/pihole
			rm /var/log/pihole.log
			rm /etc/cron.weekly/pihole_adlist_update
			rm /etc/dnsmasq.d/01-pihole.conf

			rm /opt/pihole/gravity.sh
			rm /etc/bash_completion.d/pihole
			rm /usr/local/bin/pihole
			rm /etc/sudoers.d/pihole


		elif (( $1 == 33 || $1 == 34 )); then

			AGP subsonic
			rm -R /var/subsonic
			#Leave possible shared Java etc, on system
			#AGP lame ffmpeg oracle-java8-jdk oracle-java8-installer

		elif (( $1 == 71 )); then

			update-rc.d webiopi remove
			rm -R /etc/webiopi
			rm -R /usr/share/webiopi
			rm /usr/bin/webiopi
			rm /etc/init.d/webiopi

		elif (( $1 == 68 )); then

			#Uninstaller does not uninstall.
			#"$HOME"/weaved_software/uninstaller.sh

			rm -R /etc/weaved
			rm -R "$HOME"/weaved_software
			rm "$HOME"/weaved_setup.bin

		elif (( $1 == 62 )); then

			#Kill
			killall dietpi-cloudshell

			#Disable auto login, revert boot index to console
			/DietPi/dietpi/dietpi-autostart 0

			#Remove alias
			sed -i '/dietpi-cloudshell=/d' /etc/bash.bashrc

		elif (( $1 == 98 )); then

			update-rc.d haproxy remove
			rm /etc/init.d/haproxy

			rm -r /etc/haproxy

			#Shared dev libaries. Leave these installed
			#AGP libpcre3-dev libssl-dev

		elif (( $1 == 35 )); then

			AGP logitechmediaserver
			rm /etc/dietpi/dietpi-software/services/squeezeboxserver.service
			rm -R /var/lib/squeezeboxserver
			rm -R /usr/share/squeezeboxserver

		elif (( $1 == 55 )); then

			rm -R /var/www/wordpress

		elif (( $1 == 27 || $1 == 28)); then

			AGP tightvncserver
			AGP vnc4server

			rm /etc/systemd/system/vncserver.service
			rm /etc/init.d/vncserver

			rm /usr/local/bin/vncserver

			rm -R "$HOME"/.vnc

		elif (( $1 == 73 )); then

			AGP fail2ban

		elif (( $1 == 64 )); then

			rm -R /var/www/phpsysinfo

		elif (( $1 == 56 )); then

			rm /var/www/gallery/index.php
			rm -R /var/www/gallery/_sfpg_data

		elif (( $1 == 40 )); then

			rm -R /var/www/ampache

			#drop database
			service mysql start
			mysqladmin -u root -pdietpi drop ampache -f

		elif (( $1 == 97 )); then

			AGP openvpn
			rm -R /etc/openvpn &> /dev/null

		elif (( $1 == 92 )); then

			rm -R /etc/letsencrypt_scripts
			rm -R /etc/certbot_scripts

		elif (( $1 == 69 )); then

			AGP python-rpi.gpio python3-rpi.gpio

		elif (( $1 == 72 )); then

			AGP i2c-tools
			#Disable
			/DietPi/dietpi/func/dietpi-set_hardware i2c disable

		elif (( $1 == 70 )); then

			rm -R /root/wiringPi* &> /dev/null

		elif (( $1 == 60 )); then

			AGP hostapd isc-dhcp-server

			rm /etc/dhcp/dhcpd.conf &> /dev/null
			rm /etc/hostapd/hostapd.conf &> /dev/null
			rm /etc/default/isc-dhcp-server &> /dev/null
			rm /etc/default/hostapd &> /dev/null
			rm /etc/iptables.ipv4.nat &> /dev/null
			# - remove binary (used a -f trigger to detect wifi hotspot mode in dietpi-config).
			rm /usr/sbin/hostapd &> /dev/null
			rm /usr/sbin/hostapd_cli &> /dev/null

			#Set Wlan back to inactive and ready for use with dietpi-config.
			local wifi_index=$(sed -n 2p /DietPi/dietpi/.network)

			# - Remove all entries below wlan, so we can recreate them.
			sed -i '/allow-hotplug wlan/q0' /etc/network/interfaces

			# - Disable wlan
			sed -i "/allow-hotplug wlan/c\#allow-hotplug wlan$wifi_index" /etc/network/interfaces

			# - Add default wifi settings to network interfaces config
			cat << _EOF_ >> /etc/network/interfaces
iface wlan$wifi_index inet dhcp
metric 1
address 192.168.0.101
netmask 255.255.255.0
gateway 192.168.0.1
wireless-essid FuzonWifi
wireless-key abcde12345
wireless-mode Managed
wireless-power off
wpa-ssid FuzonWifi
wpa-psk abcde12345
#dns-nameservers 8.8.8.8 8.8.4.4
_EOF_

			# - Flush IP tables
			iptables -F
			iptables -t nat -F
			iptables-save > /etc/iptables.ipv4.nat

		elif (( $1 == 61 )); then

			AGP tor

			# - uninstall WIFIHOTSPOT ALSO. Due to IPtables needing reset.
			Uninstall_Software 60

		elif (( $1 == 37 )); then

			AGP shairport-sync*

		elif (( $1 == 38 )); then

			AGP brutefir

			rm -R /etc/BruteFIR
			rm /etc/dietpi/dietpi-software/services/brutefir.service
			rm /etc/asound.conf

			rm /etc/modules-load.d/brutefir-alsa-loopback.conf
			rm /etc/modprobe.d/brutefir-alsa-loopback.conf

		elif (( $1 == 48 )); then

			rm -R /var/www/pydio

			#drop database
			service mysql start
			mysqladmin -u root -pdietpi drop pydio -f

		elif (( $1 == 36 )); then

			AGP squeezelite

		elif (( $1 == 99 )); then

			rm -R /etc/emonhub
			rm /etc/init.d/emonhub
			rm /etc/default/emonhub

		elif (( $1 == 66 )); then

			AGP rpimonitor

		elif (( $1 == 57 )); then

			rm -R /var/www/baikal

			#drop database
			service mysql start
			mysqladmin -u root -pdietpi drop baikal -f

		elif (( $1 == 65 )); then

			#all
			rm /etc/systemd/system/netdata.service

			userdel -f netdata
			groupdel netdata

			#1.2.0
			AGP netdata

			#1.0.0
			rm /usr/sbin/netdata

			rm -R /etc/netdata
			rm -R /usr/share/netdata
			rm -R /usr/libexec/netdata
			rm -R /var/cache/netdata
			rm -R /var/log/netdata

		elif (( $1 == 43 )); then

			AGP mumble-server

		elif (( $1 == 41 )); then

			AGP emby-server

			rm /etc/apt/sources.list.d/emby-server.list
			apt-get update

		elif (( $1 == 58 )); then

			rm -R /etc/openbazaar-server

			# - remove service
			rm /etc/dietpi/dietpi-software/services/openbazaar-server.service

		elif (( $1 == 42 )); then

			AGP plexmediaserver

			rm /etc/apt/sources.list.d/plex.list &> /dev/null
			apt-get update

		elif (( $1 == 52 )); then

			rm -R /etc/cuberite
			rm /etc/systemd/system/cuberite.service

		elif (( $1 == 53 )); then

			rm -R "$USERDATA_DIRECTORY"/mineos
			rm -R /var/games/minecraft

			rm /etc/supervisor/conf.d/mineos.conf
			supervisorctl reload

			rm /usr/local/bin/mineos

			userdel -f mineos

		elif (( $1 == 49 )); then

			rm -R /etc/gogs
			rm /etc/systemd/system/gogs.service

			rm /var/log/gogs_daemon.log
			rm /var/log/gogs.log

			mysqladmin -u root -pdietpi drop gogs -f

		elif (( $1 == 46 )); then

			AGP qbittorrent-nox

			rm /etc/systemd/system/qbittorrent.service
			rm -R "$HOME"/.config/qBittorrent

		elif (( $1 == 50 )); then

			rm /usr/bin/syncthing
			rm /etc/systemd/system/syncthing.service
			rm -R "$HOME"/.config/syncthing

		elif (( $1 == 107 )); then

			AGP rtorrent
			rm -R /var/www/rutorrent
			rm "$HOME"/.rtorrent.rc
			rm /etc/systemd/system/rtorrent.service

			# - webserver rutorrent user/pw settings
			rm /etc/.rutorrent-htaccess

			#	lighttpd
			#Remove from
			#RUTORRENT_DIETPI to #RUTORRENT_DIETPI in /etc/lighttpd/lighttpd.conf

			#	nginx
			rm /etc/nginx/sites-dietpi/rutorrent.config

			#	apache2
			rm /etc/apache2/sites-available/rutorrent.conf

		elif (( $1 == 108 )); then

			rm -R /etc/uae4arm-rpi
			rm /etc/systemd/system/uae4arm-rpi.service

			#Disable autostart, revert boot index to console
			/DietPi/dietpi/dietpi-autostart 0

		elif (( $1 == 112 )); then

			rm "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/*
			rm -R "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/descent_1_game
			rm -R "$FP_DIETPI_USERDATA_DIRECTORY"/dxx-rebirth/descent_2_game
			sed -i '/dxx-rebirth/d' /etc/bash.bashrc

			#Remove symlinks
			rm "$HOME"/.d1x-rebirth
			rm "$HOME"/.d2x-rebirth
			rm "$HOME"/Desktop/dxx-rebirth.desktop
			rm /usr/share/applications/dxx-rebirth.desktop

		elif (( $1 == 113 )); then

			AGP chromium

		#----------------------------------------------------------------------
		#LINUX SOFTWARE

		elif (( $1 == 15 )); then

			AGP tcpdump

		elif (( $1 == 14 )); then

			AGP nload

		elif (( $1 == 13 )); then

			AGP mtr-tiny

		elif (( $1 == 11 )); then

			AGP iptraf

		elif (( $1 == 10 )); then

			AGP iftop

		elif (( $1 == 19 )); then

			AGP jed

		elif (( $1 == 3 )); then

			AGP mc

		elif (( $1 == 18 )); then

			AGP emacs

		elif (( $1 == 20 || $i == 21 )); then

			AGP vim vim-tiny

		elif (( $1 == 0 )); then

			#This also removes OpenSSH server. So lets check OpenSSH server isnt installed before hand.
			if (( $(dpkg -l | grep -ci -m1 'openssh-server') == 0 )); then

				AGP openssh-client

			fi

		elif (( $1 == 1 )); then

			umount -f /mnt/samba
			AGP smbclient
			#Disable in fstab
			sed -i '/\/mnt\/samba/c\#\/mnt\/samba . Please use dietpi-config and the Networking Options: NAS menu to setup this mount' /etc/fstab
			#Add info file for installation method.
			echo -e "Samba client can be installed and setup by DietPi-Config.\nSimply run: dietpi-config and select the Networking Options: NAS/Misc menu" > /mnt/samba/readme.txt

		elif (( $1 == 111 )); then

			AGP urbackup-server

			#+sourcebuild
			rm /etc/systemd/system/urbackupsrv.service
			rm /etc/default/urbackupsrv
			rm /etc/logrotate.d/urbackupsrv
			rm /usr/sbin/urbackupsrv
			rm /usr/bin/urbackup_snapshot_helper
			rm /usr/bin/urbackupsrv
			rm -R /usr/share/urbackup

		elif (( $1 == 110 )); then

			umount -f /mnt/nfs_client

			#nfs-kernel-server depends on nfs-common
			if (( ${aSOFTWARE_INSTALL_STATE[109]} == 0 )); then

				AGP nfs-common

			fi

			#Disable in fstab
			sed -i '/\/mnt\/nfs_client/c\#\/mnt\/nfs_client . Please use dietpi-config and the Networking Options: NAS menu to setup this mount' /etc/fstab

			#Add info file for installation method.
			echo -e "NFS client can be installed and setup by DietPi-Config.\nSimply run: dietpi-config and select the Networking Options: NAS/Misc menu" > /mnt/nfs_client/readme.txt

		elif (( $1 == 16 )); then

			AGP build-essential

		elif (( $1 == 17 )); then

			AGP git

		elif (( $1 == 5 )); then

			AGP alsa-base alsa-utils

		elif (( $1 == 6 )); then

			AGP xcompmgr xinit xauth xserver-xorg xfonts-base x11-xserver-utils x11-common x11-utils
			rm /etc/xdg/autostart/xcompmgr.desktop

		elif (( $1 == 2 )); then

			umount -f /mnt/ftp_client
			AGP curlftpfs

			#Disable in fstab
			sed -i '/\/mnt\/ftp_client/c\#\/mnt\/ftp_client . Please use dietpi-config and the Networking Options: NAS menu to setup this mount' /etc/fstab

			#Add info file for installation method.
			echo -e "FTP client mount can be installed and setup by DietPi-Config.\nSimply run: dietpi-config and select the Networking Options: NAS/Misc menu" > /mnt/ftp_client/readme.txt


		elif (( $1 == 7 )); then

			AGP ffmpeg

		elif (( $1 == 8 )); then

			AGP oracle-java8-*
			rm /etc/apt/sources.list.d/webupd8team-java.list
			apt-get update

		elif (( $1 == 104 )); then

			AGP dropbear

		elif (( $1 == 105 )); then

			AGP openssh-server openssh-blacklist*

		elif (( $1 == 103 )); then

			sed -i '/\/var\/log/c\#\/var\/log DietPi Ramlog Disabled' /etc/fstab

		elif (( $1 == 101 )); then

			AGP logrotate

		elif (( $1 == 102 )); then

			AGP rsyslog

		elif (( $1 == 9 )); then

			AGP nodejs

			# - old install via repo
			if [ -f /etc/apt/sources.list.d/nodesource_nodejs.list ]; then

				rm /etc/apt/sources.list.d/nodesource_nodejs.list
				apt-get update

			fi

			rm /usr/local/bin/node

		elif (( $1 == 4 )); then

			AGP vifm

		else

			/DietPi/dietpi/func/dietpi-notify 2 "Software index $1 is unknown, or, has no removal code."
			valid_input=0

		fi

		#----------------------------------------------------------------------
		#log to .uninstalled file
		if [ ! -f /DietPi/dietpi/.uninstalled ]; then

			echo -e "DietPi Uninstall Software Log\n----------------------\n" > /DietPi/dietpi/.uninstalled

		fi

		echo -e "$1 | $(date)" >> /DietPi/dietpi/.uninstalled

		#Update array installed state
		aSOFTWARE_INSTALL_STATE[$1]=0

	}

	Uninstall_Software_Finalize(){

		#Purge
		/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Removing packages that are no longer required"

		apt-get autoremove --purge -y

		#Check if we need to clear DietPi choices
		dpkg -l > /tmp/.dietpi-uninstall_dpkg
		if (( $(cat /tmp/.dietpi-uninstall_dpkg | grep -ci -m1 'openssh-server') == 0 &&
			$(cat /tmp/.dietpi-uninstall_dpkg | grep -ci -m1 'dropbear') == 0 )); then

			INDEX_SSHSERVER_CURRENT=0
			INDEX_SSHSERVER_TARGET=0

		fi

		if (( $(cat /tmp/.dietpi-uninstall_dpkg | grep -ci -m1 ' samba ') == 0 &&
			$(cat /tmp/.dietpi-uninstall_dpkg | grep -ci -m1 'proftpd-basic') == 0 )); then

			INDEX_FILESERVER_CURRENT=0
			INDEX_FILESERVER_TARGET=0

		fi

		if (( $(cat /etc/fstab | grep -ci -m1 '#/var/log') == 1 &&
			$(cat /tmp/.dietpi-uninstall_dpkg | grep -ci -m1 'rsyslog') == 0 &&
			$(cat /tmp/.dietpi-uninstall_dpkg | grep -ci -m1 'logrotate') == 0 )); then

			INDEX_LOGGING_CURRENT=0
			INDEX_LOGGING_TARGET=0

		fi

		rm /tmp/.dietpi-uninstall_dpkg

		systemctl daemon-reload

	}

	Run_Installations(){

		#------------------------------------------------------------
		#Disable powersaving on Main screen during installation
		setterm -blank 0 -powersave off 2> /dev/null
		#------------------------------------------------------------
		# Stop Services
		/DietPi/dietpi/dietpi-services stop
		#------------------------------------------------------------
		#First run: Move userdata location. Auto and/or custom
		if (( $DIETPI_INSTALL_STAGE == 0 )); then

			local current_userdata_dir=$(/DietPi/dietpi/func/dietpi-set_userdata return_source)

			# - Run the script to move user data location if required (now accepts Auto
			local target_userdata_dir=$(cat /DietPi/dietpi.txt | grep -m1 'dietpi_userdata_basedirectory=' | sed 's/.*=//' | tr '[:upper:]' '[:lower:]')
			/DietPi/dietpi/func/dietpi-set_userdata "$current_userdata_dir" "$target_userdata_dir"

			# - Check for failure
			if (( $? != 0 )); then

				Error_Create_UserDataDirectory
				Exit_Destroy

			fi

		fi

		#------------------------------------------------------------
		#Set current path to home folder
		cd "$HOME"

		#Update Apt
		Banner_Apt_Update

		#Always clean and update apt, before running installs.
		apt-get clean
		apt-get update

		#Simluated apt installation to check for failures related to apt-cache.
		/DietPi/dietpi/func/dietpi-notify 2 "Running apt simulation to check for errors, please wait..."
		local package_to_test="bash-doc"
		apt-get install $package_to_test -s -y &> /dev/null
		local result=$?

		/DietPi/dietpi/func/dietpi-notify -1 $result "Apt simulation |"

		if (( $result != 0 )); then

			Error_AptGet_Failed simulation

		fi

		#Upgrade Apt
		Banner_Setup
		Banner_Apt_Update
		# - Set noninteractive | Allows automation for some software
		DEBIAN_FRONTEND='noninteractive' apt-get upgrade -y

		#Generate dir for dietpi-software installed "non-service" based control scripts
		mkdir -p /etc/dietpi/dietpi-software/services
		chmod -R +x /etc/dietpi/dietpi-software/services

		#Apply DietPi choice systems
		Apply_FileServer_Choices
		Apply_SSHServer_Choices
		Apply_Logging_Choices

		#Apply DietPi preference systems
		Apply_Webserver_Preference

		#Update required software that needs to be installed
		Install_Flag_Prereq_Software

		#Install Linux Software
		/DietPi/dietpi/dietpi-services stop
		Install_Linux_Software

		#Install DietPi Optimized Software
		/DietPi/dietpi/dietpi-services stop
		Install_Dietpi_Software

		#Apply Uninstall script created by DietPi choice system
		Uninstall_NonSelected_Choices

		#Apply DietPi configurations and optimizations
		/DietPi/dietpi/dietpi-services stop
		Banner_Configs
		Install_Apply_Configs

		Install_Apply_Permissions &> /dev/null

		#Disable services so DietPi-services can take control (DietPi will start all services from rc.local)
		/DietPi/dietpi/dietpi-services disable

		#Install finished, set all installed software to state 2 (installed)
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				aSOFTWARE_INSTALL_STATE[$i]=2

			fi

		done

		#Apply GPU Memory Splits: NB, this only checks for installed state '=2'
		Install_Apply_GPU_Settings

		#Write to .install File
		Write_InstallFileList

		#DietPi-Automation
		if (( $DIETPI_INSTALL_STAGE == 0 )); then

			#Apply Timezone
			if [ "$AUTOINSTALL_TIMEZONE" != "Europe/London" ]; then

				echo -e "\nDietPi: Setting Timezone = $AUTOINSTALL_TIMEZONE"
				echo -e "$AUTOINSTALL_TIMEZONE" > /etc/timezone
				dpkg-reconfigure -f noninteractive tzdata

			fi

			#Apply Language (Locale)
			if [ "$AUTOINSTALL_LANGUAGE" != "en_GB" ]; then

				/DietPi/dietpi/func/dietpi-notify 2 "Setting Locale $AUTOINSTALL_LANGUAGE. Please wait...\n"

				#Enable user setting
				sed -i "/$AUTOINSTALL_LANGUAGE.UTF-8/c $AUTOINSTALL_LANGUAGE.UTF-8 UTF-8" /etc/locale.gen
				echo -e "LANG=$AUTOINSTALL_LANGUAGE.UTF-8" > /etc/default/locale
				echo -e "LC_ALL=$AUTOINSTALL_LANGUAGE.UTF-8" > /etc/environment #This prevents LC_* errors when checking locale on non-rpi devices.

				locale-gen

				localectl set-locale LANG="$AUTOINSTALL_LANGUAGE.UTF-8"

			fi

			#Apply Keyboard
			if [ "$AUTOINSTALL_KEYBOARD" != "gb" ]; then

				/DietPi/dietpi/func/dietpi-notify 2 "Setting Keyboard $AUTOINSTALL_KEYBOARD. Please wait...\n"
				sed -i '/XKBLAYOUT=/c XKBLAYOUT="'"$AUTOINSTALL_KEYBOARD"'"' /etc/default/keyboard
				#systemctl restart keyboard-setup

			fi

			#Apply & Mount Network drives if installed
			if (( ${aSOFTWARE_INSTALL_STATE[1]} == 2 )); then

				/DietPi/dietpi/func/dietpi-set_smbclient 1

			fi

			if (( ${aSOFTWARE_INSTALL_STATE[2]} == 2 )); then

				/DietPi/dietpi/func/dietpi-set_curlftpfs 1

			fi

			#Custom 1st run Script (Local file)
			local run_custom_script=0
			if [ -f /boot/Automation_Custom_Script.sh ]; then

				INSTALL_DESCRIPTION='Automation - Local Custom Script'
				Banner_Installing

				cp /boot/Automation_Custom_Script.sh /root/AUTO_CustomScript.sh
				run_custom_script=1

			#Custom 1st run Script (Online file)
			elif [ "$AUTOINSTALL_CUSTOMSCRIPTURL" != "0" ]; then

				INSTALL_DESCRIPTION='Automation - Online Custom Script'
				Banner_Installing

				#check source is online
				INSTALL_URL_ADDRESS=$AUTOINSTALL_CUSTOMSCRIPTURL
				/DietPi/dietpi/func/check_connection "$INSTALL_URL_ADDRESS"

				#Install
				if (( $? == 0 )); then

					#Get script and execute
					wget "$INSTALL_URL_ADDRESS" -O /root/AUTO_CustomScript.sh
					run_custom_script=1

				else

					echo -e "Automated Custom Script URL Error:\n $AUTOINSTALL_CUSTOMSCRIPTURL is offline and/or unreachable" >> "$FP_DIETPIAUTOMATION_LOG"

				fi

			fi

			if (( $run_custom_script == 1 )); then

				chmod +x /root/AUTO_CustomScript.sh
				/root/AUTO_CustomScript.sh
				local result=$?
				if (( $result == 0 )); then

					echo -e "Automated custom script executed succesfully:\n - Filepath = /root/AUTO_CustomScript.sh\n - URL = $AUTOINSTALL_CUSTOMSCRIPTURL" >> "$FP_DIETPIAUTOMATION_LOG"

				else

					echo -e "Automated Custom Script Error:\n - Exit code = $result\n - Filepath = /root/AUTO_CustomScript.sh\n - URL = $AUTOINSTALL_CUSTOMSCRIPTURL" >> "$FP_DIETPIAUTOMATION_LOG"

				fi

			fi

			#Apply AutoStart
			/DietPi/dietpi/dietpi-autostart $AUTOINSTALL_AUTOSTARTTARGET

		fi

		#Set Install Stage to Finished
		echo 1 > /DietPi/dietpi/.install_stage

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# First Run / Automation functions Vars (eg: on a fresh install)
	#/////////////////////////////////////////////////////////////////////////////////////
	AUTOINSTALL_ENABLED=0

	AUTOINSTALL_SSHINDEX=0
	AUTOINSTALL_FILESERVERINDEX=0
	AUTOINSTALL_LOGGINGINDEX=0
	AUTOINSTALL_WEBSERVERINDEX=0

	AUTOINSTALL_AUTOSTARTTARGET=0

	AUTOINSTALL_TIMEZONE=0
	AUTOINSTALL_LANGUAGE=0
	AUTOINSTALL_KEYBOARD=0

	AUTOINSTALL_CUSTOMSCRIPTURL=0

	FirstRun_Automation_Init(){

		#Get settings
		AUTOINSTALL_ENABLED=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_Install_Enable=' | sed 's/.*=//')

		AUTOINSTALL_AUTOSTARTTARGET=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_AutoStartTarget=' | sed 's/.*=//' )

		AUTOINSTALL_SSHINDEX=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_DietpiSoftware_SSHServerIndex=' | sed 's/.*=//')
		AUTOINSTALL_FILESERVERINDEX=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_DietpiSoftware_FileServerIndex=' | sed 's/.*=//')
		AUTOINSTALL_LOGGINGINDEX=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_DietpiSoftware_LoggingIndex=' | sed 's/.*=//')
		AUTOINSTALL_WEBSERVERINDEX=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_DietpiSoftware_WebserverIndex=' | sed 's/.*=//')

		AUTOINSTALL_TIMEZONE=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_Timezone=' | sed 's/.*=//' )
		AUTOINSTALL_LANGUAGE=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_Locale=' | sed 's/.*=//' )
		AUTOINSTALL_KEYBOARD=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_KeyboardLayout=' | sed 's/.*=//' )

		AUTOINSTALL_CUSTOMSCRIPTURL=$(cat /DietPi/dietpi.txt | grep -m1 '^AUTO_CustomScriptURL=' | sed 's/AUTO_CustomScriptURL=//')

	}

	FirstRun_Automation_Set(){

		#Automated install
		if (( $AUTOINSTALL_ENABLED >= 1 )); then

			/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Running automated installation"

			#Skip dietpi-software menu
			TARGETMENUID=-1

			#Set start install
			GOSTARTINSTALL=1

			#Auto format/setup USB drive
			if [ -f /boot/Automation_Format_My_Usb_Drive ]; then

				#Run Format
				/DietPi/dietpi/dietpi-drive_manager 1

			fi

			#Find all software entires of AUTO_DietpiSoftware_Install_ID= in dietpi.txt. Then set to state 1 for installation.
			while read -r line
			do

				local index=$( echo -e "$line" | grep '^AUTO_DietpiSoftware_Install_ID=' | sed 's/[^0-9]*//g' )

				# - Flag for installation
				if [[ $index =~ ^-?[0-9]+$ ]]; then

					aSOFTWARE_INSTALL_STATE[$index]=1

					/DietPi/dietpi/func/dietpi-notify 2 "Automation: ${aSOFTWARE_WHIP_NAME[$index]}. Flagged for installation."

				fi

			done < /DietPi/dietpi.txt

		fi

		#Further Automated options. (Applied regardless of AUTOINSTALL_ENABLED)
		INDEX_SSHSERVER_TARGET=$AUTOINSTALL_SSHINDEX
		INDEX_FILESERVER_TARGET=$AUTOINSTALL_FILESERVERINDEX
		INDEX_LOGGING_TARGET=$AUTOINSTALL_LOGGINGINDEX
		INDEX_WEBSERVER_TARGET=$AUTOINSTALL_WEBSERVERINDEX

		# - IPversion preference: https://github.com/Fourdee/DietPi/issues/472
		/DietPi/dietpi/func/dietpi-set_hardware preferipversion "$(cat /DietPi/dietpi.txt | grep -m1 '^prefer_ipversion=' | sed 's/.*=//')"

	}

	FirstRun_DietPi_Update(){

		#Disable powersaving on main screen
		setterm -blank 0 -powersave off 2> /dev/null

		#-1 = 1st run | 0 = Reboot, updates applied | 1 = Idle, No updates
		#Update .update_stage file to completed
		echo 1 > /DietPi/dietpi/.update_stage

		#Update APT
		apt-get update

		#Check for updates and apply if needed (1=force apply updates).
		/DietPi/dietpi/dietpi-update 1

		#Check update stage file again (dietpi-update will set to 0 if an update was applied and requires a reboot)
		if (( $(cat /DietPi/dietpi/.update_stage) == 0 )); then

			#Update .update_stage file to completed
			echo 1 > /DietPi/dietpi/.update_stage

			#Prompt user for reboot
			if (( $USER_INPUTS )); then

				WHIP_TITLE='DietPi Update Completed'
				whiptail --title "$WHIP_TITLE" --msgbox "DietPi has been updated to the latest version.\nYour system will now reboot. Once completed, simply login to resume DietPi Setup. \n\nPress Enter to Continue." 13 65

			fi

			#Reboot required NOW
			reboot
			Exit_Destroy

		fi

	}

	FirstRun_Questions(){

		local string_setup_usb_drive_desc='If you choose to setup a dedicated USB drive, DietPi will automatically configure your future software installations to utilize the USB drive for user data storage, instead of SD.\nAs USB hard drives can be faster than most SD cards, using a USB drive can vastly improve system performance.\n\nExamples of software, that will benefit from a USB drive: \n - BitTorrent (Store downloads) \n - OwnCloud (Larger data storage)\n - Kodi / Plex / Emby etc (Store Media Files)\n\nMore information on user data in DietPi:\n - http://dietpi.com/phpbb/viewtopic.php?f=8&t=478&p=2087\n\nWould you like to setup a USB drive now?'

		#AmiBerry Special: https://github.com/Fourdee/DietPi/issues/513
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^AUTO_DietpiSoftware_Install_ID=108$') )); then

			WHIP_TITLE='Setup USB Dedicated Drive?'
			WHIP_QUESTION="$string_setup_usb_drive_desc"
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" --defaultno 21 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				#Run full drive manager
				/DietPi/dietpi/dietpi-drive_manager

			fi

		fi

		if (( $USER_INPUTS )); then

			#Questions Start (Ask our inital questions, before allowing access to the software selection menus)
			WHIP_TITLE='DietPi - Welcome'
			whiptail --title "$WHIP_TITLE" --msgbox "Welcome to the DietPi Installation System. \n \nBefore we can begin, we need to ask you a few questions regarding this installation. \n \nPress Enter to begin." 14 70

			#Request for Dedicated External Drive installation.
			if (( ! $USBDRIVE && $HW_MODEL != 20 )); then

				WHIP_TITLE='Setup USB Dedicated Drive?'
				WHIP_QUESTION="$string_setup_usb_drive_desc"
				whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" --defaultno 21 70
				CHOICE=$?
				if (( $CHOICE == 0 )); then

					#Run old external drive setup (1 drive, simple interface)
					/DietPi/dietpi/dietpi-drive_manager 2

				fi

			fi

			#Questions End
			if (( $AUTOINSTALL_ENABLED == 0 )); then

				WHIP_TITLE='DietPi - Questions Completed'
				whiptail --title "$WHIP_TITLE" --msgbox "The DietPi-Software menu will now appear with the following options: \n\n- Select DietPi Optimized Software\nThis will allow you to select Optimized and Ready to Run software.\nhttp://dietpi.com/software\n\n- Select Additional Linux Software.\nThis will allow you to select standard linux software relative to this installation. \n\n- DietPi-Config\nA feature rich configuration tool for your device.\n \n- Go Start Install\nThis will start the installation process for your selected items." 21 75

			fi

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Internet Connection Test Vars
	#/////////////////////////////////////////////////////////////////////////////////////
	INTERNET_CONNECTED=0
	#Use /etc/apt/sources.list for connection test
	INTERNET_URL_TEST=$(cat /etc/apt/sources.list | grep -m1 "deb http" | awk '{print $2}')

	Check_Internet_Connection(){

		#Max loops for USER_INPUTS=0
		local max_loops=20
		local current_loop=0

		INTERNET_CONNECTED=0
		while (( ! $INTERNET_CONNECTED )); do

			sleep 1

			/DietPi/dietpi/func/check_connection "$INTERNET_URL_TEST"

			if (( $? == 0 )); then

				INTERNET_CONNECTED=1

			elif (( $USER_INPUTS )); then

				Menu_No_Internet

			else

				if (( $current_loop >= $max_loops )); then

					/DietPi/dietpi/func/dietpi-notify 1 "Connection test failed. $INTERNET_URL_TEST"
					Exit_Destroy

				else

					/DietPi/dietpi/func/dietpi-notify 2 "Testing connection to $INTERNET_URL_TEST"
					/DietPi/dietpi/func/dietpi-notify 2 "Attempt ($current_loop / $max_loops), please wait..."

				fi

				((current_loop++))

			fi


		done

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	#Enable all user inputs (eg: prompts)
	USER_INPUTS=1

	Input_Modes(){

		# - Skip menu
		TARGETMENUID=-1

		DISABLE_REBOOT=1

		local ainput=("$@")


		#Install software and exit.
		if [ "$1" = "install" ] || [ "$1" = "reinstall" ] || [ "$1" = "uninstall" ] ; then

			/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Automated $1"
			sleep 1

			# - Make sure we have at least one entry
			if [ -z "$2" ]; then

				/DietPi/dietpi/func/dietpi-notify 1 "Please enter a software index ID, or, choice system INDEX_*_TARGET=-?"

			else

				for i in "${ainput[@]}"
				do

					#Valid int means input is unique ID for software index to be installed
					if [[ $i =~ ^-?[0-9]+$ ]]; then

						if [ "$1" = "uninstall" ]; then

							# - stop services
							/DietPi/dietpi/dietpi-services stop

							for i in "${ainput[@]}"
							do

								#Valid int means input is unique ID for software index
								if [[ $i =~ ^-?[0-9]+$ ]]; then

									Uninstall_Software "$i"

								fi

							done

							#Finish up and clear non-required packages
							Uninstall_Software_Finalize

							#Save
							Write_InstallFileList

							# - Start services
							/DietPi/dietpi/dietpi-services start

						elif [ "$1" = "reinstall" ]; then

							if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 )); then

								# - We cant uninstall, may remove additional packages. eg: remove Xserver = Remove every Xserver depandant program like Kodi.
								#Uninstall_Software $i

								# - So lets flag to be installed
								aSOFTWARE_INSTALL_STATE[$i]=1
								GOSTARTINSTALL=1

								/DietPi/dietpi/func/dietpi-notify 0 "Reinstalling ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"
								sleep 1

							else

								/DietPi/dietpi/func/dietpi-notify 2 "$i: ${aSOFTWARE_WHIP_NAME[$i]} is not currently installed"
								/DietPi/dietpi/func/dietpi-notify 2 "The program must be installed, before reinstall can be used"
								/DietPi/dietpi/func/dietpi-notify 0 "No changes applied for: ${aSOFTWARE_WHIP_NAME[$i]}"

							fi

						elif [ "$1" = "install" ]; then

							if (( ${aSOFTWARE_INSTALL_STATE[$i]} != 2 )); then

								aSOFTWARE_INSTALL_STATE[$i]=1
								GOSTARTINSTALL=1

								/DietPi/dietpi/func/dietpi-notify 0 "Installing ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"
								sleep 0.5

							else

								/DietPi/dietpi/func/dietpi-notify 2 "$i: ${aSOFTWARE_WHIP_NAME[$i]} is already installed"
								/DietPi/dietpi/func/dietpi-notify 0 "No changes applied for: ${aSOFTWARE_WHIP_NAME[$i]}"

							fi

						fi

					fi

				done

			fi

		#Apply permissions
		elif [ "$1" = "setpermissions" ]; then

			Install_Apply_Permissions &> /dev/null
			/DietPi/dietpi/func/dietpi-notify 0 "Set permissions completed"

		#List unique software names and ID's
		elif [ "$1" = "list" ]; then

			for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
			do

				local string=''

				if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 )); then

					string="\e[32mID $i | "

				else

					string="\e[0mID $i | "

				fi

				string+="=${aSOFTWARE_INSTALL_STATE[$i]} | ${aSOFTWARE_WHIP_NAME[$i]}: \e[90m${aSOFTWARE_WHIP_DESC[$i]}\e[0m |"

				if (( ${aSOFTWARE_REQUIRES_ALSA[$i]} == 1 )); then

					string+=' +ALSA'
				fi

				if (( ${aSOFTWARE_REQUIRES_XSERVERXORG[$i]} == 1 )); then

					string+=' +XSERVER'

				fi

				if (( ${aSOFTWARE_REQUIRES_DESKTOP[$i]} == 1 )); then

					string+=' +DESKTOP'

				fi

				if (( ${aSOFTWARE_REQUIRES_RSYSLOG[$i]} == 1 )); then

					string+=' +RSYSLOG'

				fi

				if (( ${aSOFTWARE_REQUIRES_FFMPEG[$i]} == 1 )); then

					string+=' +FFMPEG'

				fi

				if (( ${aSOFTWARE_REQUIRES_ORACLEJAVA[$i]} == 1 )); then

					string+=' +ORACLEJAVA'

				fi

				if (( ${aSOFTWARE_REQUIRES_NODEJS[$i]} == 1 )); then

					string+=' +NODEJS'

				fi

				if (( ${aSOFTWARE_REQUIRES_BUILDESSENTIAL[$i]} == 1 )); then

					string+=' +BUILDESSENTIAL'

				fi

				if (( ${aSOFTWARE_REQUIRES_GIT[$i]} == 1 )); then

					string+=' +GIT'

				fi

				if (( ${aSOFTWARE_REQUIRES_WEBSERVER[$i]} == 1 )); then

					string+=' +WEBSERVER'

				fi

				if (( ${aSOFTWARE_REQUIRES_MYSQL[$i]} == 1 )); then

					string+=' +MYSQL'

				fi

				if (( ${aSOFTWARE_REQUIRES_SQLITE[$i]} == 1 )); then

					string+=' +SQLITE'

				fi

				# - Available for HW_ARCH?
				if (( ! ${aSOFTWARE_AVAIL_HW_ARCH[$i,$HW_ARCH]} )); then

					string+=" \e[31mDISABLED for HW_ARCH\e[0m"

				fi

				# - Available for HW_MODEL?
				if (( ! ${aSOFTWARE_AVAIL_HW_MODEL[$i,$HW_MODEL]} )); then

					string+=" \e[31mDISABLED for HW_MODEL\e[0m"

				fi

				# - Online docs
				if [ -n "${aSOFTWARE_ONLINEDOC_URL[$i]}" ]; then

					string+=" | \e[90m$FP_ONLINEDOC_URL${aSOFTWARE_ONLINEDOC_URL[$i]}\e[0m"

				fi

				echo -e "$string"

			done

			echo -e "Total Software index HARD limit : $TOTAL_SOFTWARE_INDEXS_HARDLIMIT"
			echo -e "Total Software index Current    : $TOTAL_SOFTWARE_INDEXS"

		#List unique software names and ID's
		elif [ "$1" = "weblist_export" ]; then

			local fp_export_dir='/tmp/dietpi-software/weblist_export'

			rm -R "$fp_export_dir"
			mkdir -p "$fp_export_dir"

			# - Category desc | Remove '─' before saving.
			local fp_target="$fp_export_dir/category_dietpi_total"
			echo -e "$MAX_SOFTWARE_CATEGORIES_DIETPI" > "$fp_target"

			local fp_target="$fp_export_dir/category_linux_total"
			echo -e "$MAX_SOFTWARE_CATEGORIES_LINUX" > "$fp_target"

			fp_target="$fp_export_dir/category_dietpi_desc"
			for ((i=0; i<$MAX_SOFTWARE_CATEGORIES_DIETPI; i++))
			do
				local output=
				echo -e "$( echo ${aSOFTWARE_CATEGORIES_DIETPI[$i]} | sed 's/─//g')" >> "$fp_target"

			done

			fp_target="$fp_export_dir/category_linux_desc"
			for ((i=0; i<$MAX_SOFTWARE_CATEGORIES_LINUX; i++))
			do

				echo -e "$( echo ${aSOFTWARE_CATEGORIES_LINUX[$i]} | sed 's/─//g')" >> "$fp_target"

			done

			# - Software list
			local fp_target="$fp_export_dir/total_software_index"
			echo -e "$TOTAL_SOFTWARE_INDEXS" > "$fp_target"

			fp_target="$fp_export_dir/software_installed_state"
			printf "%i\n" "${aSOFTWARE_INSTALL_STATE[@]}" > "$fp_target"

			fp_target="$fp_export_dir/software_name"
			printf "%s\n" "${aSOFTWARE_WHIP_NAME[@]}" > "$fp_target"

			fp_target="$fp_export_dir/software_desc"
			printf "%s\n" "${aSOFTWARE_WHIP_DESC[@]}" > "$fp_target"

			fp_target="$fp_export_dir/category_index"
			printf "%i\n" "${aSOFTWARE_CATEGORY_INDEX[@]}" > "$fp_target"

			fp_target="$fp_export_dir/software_urldocs"
			printf "%s\n" "${aSOFTWARE_ONLINEDOC_URL[@]}" > "$fp_target"

			# - Available for device?
			fp_target="$fp_export_dir/software_available_hw_model"
			for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
			do
				printf "%i\n" "${aSOFTWARE_AVAIL_HW_MODEL[$i,$HW_MODEL]}" >> "$fp_target"

			done

			fp_target="$fp_export_dir/software_available_hw_arch"
			for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
			do
				printf "%i\n" "${aSOFTWARE_AVAIL_HW_ARCH[$i,$HW_ARCH]}" >> "$fp_target"

			done

			# - Flagged Prereqs for installation
			# fp_target="$fp_export_dir/installs_alsa"
			# printf "%s\n" "${aSOFTWARE_REQUIRES_ALSA[@]}" > "$fp_target"

			# fp_target="$fp_export_dir/installs_xserver"
			# printf "%s\n" "${aSOFTWARE_REQUIRES_XSERVERXORG[@]}" > "$fp_target"

			# fp_target="$fp_export_dir/installs_desktop"
			# printf "%s\n" "${aSOFTWARE_REQUIRES_DESKTOP[@]}" > "$fp_target"

		else

			/DietPi/dietpi/func/dietpi-notify 2 "Unknown command $1"

		fi

		unset ainput

	}

	Exit_Destroy(){

		Software_Arrays_Destroy

		exit

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Error Functions
	#/////////////////////////////////////////////////////////////////////////////////////
	ERROR_TEXT=""

	Error_Display(){

		#Automation | Save to logfile

		if (( $USER_INPUTS )); then

			whiptail --title "Error" --msgbox "$ERROR_TEXT" 16 70

		else

			echo -e "Error: $ERROR_TEXT" >> "$FP_DIETPIAUTOMATION_LOG"

		fi

	}

	Error_NoConnection_NoInstall(){

		#Abort install
		aSOFTWARE_INSTALL_STATE[$INSTALLING_INDEX]=0

		ERROR_TEXT="Unable to Install ${aSOFTWARE_WHIP_NAME[$INSTALLING_INDEX]}: ${aSOFTWARE_WHIP_DESC[$INSTALLING_INDEX]}\n\n$INSTALL_URL_ADDRESS is offline and/or unreachable."
		Error_Display

	}

	Error_AptGet_Failed(){

		#*=apt installation failed
		#simulation=apt simulation failed

		if [ "$1" = "simulation" ]; then

			ERROR_TEXT="Apt-get simulation has failed.\n\nDietPi-Software will now exit."
			Error_Display

		else

			ERROR_TEXT="Apt-get has failed:\n - Apt string = $string\n - Error code = $result\n - Software Title = ${aSOFTWARE_WHIP_NAME[$INSTALLING_INDEX]}: ${aSOFTWARE_WHIP_DESC[$INSTALLING_INDEX]}\n\nPlease report this issue to DietPi so it can be investigated.\n\nDietPi-Software will now exit."
			Error_Display

		fi

		/DietPi/dietpi/func/dietpi-notify 2 "The apt cache may be corrupt, or you have held broken pacakages. DietPi-Software will now exit.\n"
		/DietPi/dietpi/func/dietpi-notify 2 "Please try:"
		/DietPi/dietpi/func/dietpi-notify 2 "- Fixing apt package errors with 'apt-get install -f'"
		/DietPi/dietpi/func/dietpi-notify 2 "- Changing '/etc/apt/sources.list' to another repo mirror."
		/DietPi/dietpi/func/dietpi-notify 2 "- Clear and refresh apt 'apt-get update'"
		/DietPi/dietpi/func/dietpi-notify 2 "- If problems persist, please create a Git ticket so DietPi can investigate the issue:\n - https://github.com/Fourdee/DietPi/issues\n"

		Exit_Destroy

	}

	Error_Create_UserDataDirectory(){

		ERROR_TEXT="DietPi was unable to create your user data directory:\n\n $(cat /var/log/dietpi-move_userdata.log)\n\nDietPi-Software will now exit."
		Error_Display

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Whip menus
	#/////////////////////////////////////////////////////////////////////////////////////
	WHIP_BACKTITLE='DietPi-Software'
	WHIP_TITLE=0
	WHIP_QUESTION=0
	MENU_MAIN_LASTITEM='Help!'
	TARGETMENUID=0

	Menu_CreateSoftwareList(){

		#software type for this menu
		local software_type=$1 #0=dietpi 1=linux

		local max_categories=$MAX_SOFTWARE_CATEGORIES_DIETPI
		if (( $1 == 1 )); then

			max_categories=$MAX_SOFTWARE_CATEGORIES_LINUX

		fi

		#-----------------------------------------------------------------------------
		#Generate Whiptail menu list based on category
		local whiptail_list=()
		for ((i=0; i<$max_categories; i++))
		do

			#Only add the category if we have software for it.
			local category_enabled=0

			#Now run through all available software
			for ((j=0; j<$TOTAL_SOFTWARE_INDEXS; j++))
			do

				#Check if this software matches the current category and sofware type for this menu.
				# - I originally had "aSOFTWARE_AVAIL_HW_MODEL" and "aSOFTWARE_AVAIL_HW_ARCH" in one 'if' statement below, however, this seems to takes 4x longer to process in bash.
				if (( ${aSOFTWARE_CATEGORY_INDEX[$j]} == $i && ${aSOFTWARE_TYPE[$j]} == $software_type )); then

					# + is available for hardware?
					# + is available for distro?
					if (( ${aSOFTWARE_AVAIL_HW_MODEL[$j,$HW_MODEL]} &&
						${aSOFTWARE_AVAIL_HW_ARCH[$j,$HW_ARCH]} )); then

						local selected="off"

						if (( ${aSOFTWARE_INSTALL_STATE[$j]} > 0 )); then

							selected="on"

							if (( ${aSOFTWARE_INSTALL_STATE[$j]} == 1 )); then

								#Reset to 0. Menu checklists will apply back to 1
								aSOFTWARE_INSTALL_STATE[$j]=0

							fi

						fi

						#Add category
						if (( $category_enabled == 0 )); then

							# - dietpi
							if (( $1 == 0 )); then

								whiptail_list+=("" "${aSOFTWARE_CATEGORIES_DIETPI[$i]}" "off")

							# - linux
							elif (( $1 == 1 )); then

								whiptail_list+=("" "${aSOFTWARE_CATEGORIES_LINUX[$i]}" "off")

							fi

							category_enabled=1

						fi

						#Add this option to whiptail list
						whiptail_list+=("$j" "${aSOFTWARE_WHIP_NAME[$j]}: ${aSOFTWARE_WHIP_DESC[$j]}" "$selected")

					fi

				fi

			done

		done

		#-----------------------------------------------------------------------------
		WHIP_TITLE='DietPi Software Selection'
		whiptail --title "$WHIP_TITLE" --checklist --separate-output "Please use the spacebar to select the software you wish to install.\nSoftware details: http://dietpi.com/software" --backtitle "$WHIP_BACKTITLE" 22 78 14 "${whiptail_list[@]}" 2>/tmp/dietpi-software_results

		#delete[]
		unset whiptail_list

		#Reset Choices made flag
		# - dietpi
		if (( $1 == 0 )); then

			INSTALL_DIETPI_CHOICESMADE=0

		# - linux
		elif (( $1 == 1 )); then

			INSTALL_LINUX_CHOICESMADE=0

		fi

		#Check for matching results (selected items)
		while read choice
		do

			for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
			do

				#enable
				if (( $choice == $i &&
					${aSOFTWARE_INSTALL_STATE[$i]} == 0 )); then

					# - dietpi
					if (( $1 == 0 )); then

						INSTALL_DIETPI_CHOICESMADE=1

					# - linux
					elif (( $1 == 1 )); then

						INSTALL_LINUX_CHOICESMADE=1

					fi

					aSOFTWARE_INSTALL_STATE[$i]=1

					break

				fi

			done

		done < /tmp/dietpi-software_results
		rm /tmp/dietpi-software_results &> /dev/null

	}

	Menu_No_Internet(){

		#Ask to check settings,
		whiptail --title "No Internet Connection!" --yesno "Internet access is required to start the DietPi Installation Program.\nWould you like to change your network settings and try again?\n\nIf problems persist:\n$INTERNET_URL_TEST may be offline and/or unreachable." --yes-button "Ok" --no-button "Exit" --defaultno --backtitle "$WHIP_BACKTITLE" 15 70
		CHOICE=$?
		#run dietpi config
		if (( $CHOICE == 0 )); then
			whiptail --title "Launching DietPi-Config" --msgbox "DietPi-Config will now be started.\nUse the Network Options menu to change and test your network settings.\n\nWhen completed, Exit DietPi-Config to resume setup." --backtitle "Launching DietPi-Config" 14 60
			/DietPi/dietpi/dietpi-config 8 1
		#User aborted setup
		else
			Banner_Aborted

			#Exit Script NOW
			Exit_Destroy
		fi

	}

	Menu_Main(){

		#Data for storing SSH server index info
		local index_sshserver_text="None"
		if (( $INDEX_SSHSERVER_TARGET == -1 )); then
			index_sshserver_text="Dropbear"
		elif (( $INDEX_SSHSERVER_TARGET == -2 )); then
			index_sshserver_text="OpenSSH"
		fi

		#Data for storing Fileserver index info
		local index_fileserver_text="None"
		if (( $INDEX_FILESERVER_TARGET == -1 )); then
			index_fileserver_text="ProFTP"
		elif (( $INDEX_FILESERVER_TARGET == -2 )); then
			index_fileserver_text="Samba"
		fi

		#Data for storing Logging index info
		local index_logging_text="None"
		if (( $INDEX_LOGGING_TARGET == -1 )); then
			index_logging_text="DietPi-Ramlog #1"
		elif (( $INDEX_LOGGING_TARGET == -2 )); then
			index_logging_text="DietPi-Ramlog #2"
		elif (( $INDEX_LOGGING_TARGET == -3 )); then
			index_logging_text="Full"
		fi

		#Hold our string that tells the user what software will be removed when using Index based choice systems
		local toberemoved_text=""

		#Where is userdata stored?
		local user_data_location_mode=$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_userdata_basedirectory=' | sed 's/.*=//' | tr '[:upper:]' '[:lower:]')
		local user_data_location_current=$(/DietPi/dietpi/func/dietpi-set_userdata return_source)
		local user_data_location_auto_target=$(/DietPi/dietpi/func/dietpi-set_userdata return_auto)

		local user_data_location_description=''
		if [ "$user_data_location_mode" = "auto" ] && (( $DIETPI_INSTALL_STAGE == 0 )); then

			user_data_location_description="Auto | $user_data_location_auto_target"

		elif [ "$user_data_location_current" = "$FP_DIETPI_DEDICATED_USBDRIVE" ]; then

			user_data_location_description="USB Drive | $user_data_location_current"

		elif [ "$user_data_location_current" = "$FP_DIETPI_USERDATA_DIRECTORY" ]; then

			user_data_location_description="SD/EMMC | $user_data_location_current"

		else

			user_data_location_description="Custom | $user_data_location_current"

		fi

		# - Webserver preference system
		local index_webserver_text='Apache2'
		if (( $INDEX_WEBSERVER_TARGET == -1 )); then

			index_webserver_text='Nginx'

		elif (( $INDEX_WEBSERVER_TARGET == -2 )); then

			index_webserver_text='Lighttpd'

		fi

		WHIP_TITLE='DietPi-Software'
		WHIP_BACKTITLE="DietPi-Software | IP: $(sed -n 4p /DietPi/dietpi/.network) | Device: $HW_MODEL_DESCRIPTION"

		OPTION=$(whiptail --title "$WHIP_TITLE" --backtitle "$WHIP_BACKTITLE" --menu "" --default-item "$MENU_MAIN_LASTITEM" --cancel-button "Exit" 20 75 13 \
		"Help!" "Links to online guides, docs and information" \
		"DietPi-Config" "Feature-rich configuration tool for your device" \
		"" "─── Select Software ─────────────────────────" \
		"Software Optimized" "Select DietPi optimized software for installation" \
		"Software Additional" "Select additional Linux software for installation" \
		"SSH Server" ": $index_sshserver_text" \
		"File Server" ": $index_fileserver_text" \
		"Log System" ": $index_logging_text" \
		"Webserver Preference" ": $index_webserver_text" \
		"User Data Location" ": $user_data_location_description" \
		"" "─── Install or Remove Software ──────────────" \
		"Uninstall" "Select installed software for removal" \
		"Install" "Go >> Start installation for selected software"  3>&1 1>&2 2>&3)

		CHOICE=$?
		if (( $CHOICE == 0 )); then

			MENU_MAIN_LASTITEM="$OPTION"

			case "$OPTION" in

			  "Uninstall")

					TARGETMENUID=3

				;;

			  "Software Optimized")

					TARGETMENUID=1

				;;

			  "Software Additional"*)

					TARGETMENUID=2

				;;

			  "SSH Server")

					WHIP_TITLE='SSH Server Choices'
					OPTION=$(whiptail --title "$WHIP_TITLE" --menu "> None\nSelecting this option will uninstall all SSH servers. This reduces system resources and improves performance. Useful for users who do NOT require networked/remote terminal access.\n\n> Dropbear (Recommended)\nLightweight SSH server, installed by default on DietPi systems.\n\n> OpenSSH\nA feature rich SSH server with SFTP/SCP support, at the cost of increased resource usage." --cancel-button "Back" --default-item "$index_sshserver_text" 21 75 3 \
					"None" "Not required / manual setup." \
					"Dropbear" "Lightweight SSH Server (Recommended)." \
					"OpenSSH" "Feature Rich SSH Server with SFTP/SCP support." 3>&1 1>&2 2>&3)

					#Assign target index
					if [ "$OPTION" = "None" ]; then

						INDEX_SSHSERVER_TARGET=0
						toberemoved_text="Dropbear and OpenSSH Server"

					elif [ "$OPTION" = "Dropbear" ]; then

						INDEX_SSHSERVER_TARGET=-1
						toberemoved_text="OpenSSH Server"

					elif [ "$OPTION" = "OpenSSH" ]; then

						INDEX_SSHSERVER_TARGET=-2
						toberemoved_text="Dropbear"

					#Reset to current
					else

						INDEX_SSHSERVER_TARGET=$INDEX_SSHSERVER_CURRENT

					fi

					#Check for changes
					INSTALL_SSHSERVER_CHOICESMADE=0
					if (( $INDEX_SSHSERVER_TARGET != $INDEX_SSHSERVER_CURRENT )); then

						INSTALL_SSHSERVER_CHOICESMADE=1

						#Inform user
						WHIP_TITLE="SSH Server Change"
						WHIP_QUESTION="$OPTION has been selected:\n- Your choice will be applied when 'Install Go >> Start installation' is selected.\n- $toberemoved_text installations will be automatically uninstalled."
						whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 11 75

					fi
			  ;;
			  "File Server")

					WHIP_TITLE='Fileserver Choices'
					OPTION=$(whiptail --title "$WHIP_TITLE" --menu "> None\nSelect this option if you do NOT require a method of accessing files and folders on this device, over a network.\n\n> ProFTP (Recommended for RPi v1)\nAllows you to access/share files on this device efficiently with minimal cpu usage. Uses FTP protocol.\n\n> Samba (Recommended for RPi v2)\nAllows you to easily access/share files on this device, at the cost of higher cpu usage.\n\nMore info: http://dietpi.com/phpbb/viewtopic.php?f=8&t=15#p19" --cancel-button "Back" --default-item "$index_fileserver_text" 23 75 3 \
					"None" "Not required / manual setup." \
					"ProFTP" "Efficient, lightweight fileserver (recommended)." \
					"Samba" "Feature-rich fileserver." 3>&1 1>&2 2>&3)

					#Assign target index
					if [ "$OPTION" = "None" ]; then
						INDEX_FILESERVER_TARGET=0
						toberemoved_text="ProFTP and Samba Server"
					elif [ "$OPTION" = "ProFTP" ]; then
						INDEX_FILESERVER_TARGET=-1
						toberemoved_text="Samba Server"
					elif [ "$OPTION" = "Samba" ]; then
						INDEX_FILESERVER_TARGET=-2
						toberemoved_text="ProFTP"
					#Reset to current
					else
						INDEX_FILESERVER_TARGET=$INDEX_FILESERVER_CURRENT
					fi

					#Check for changes
					INSTALL_FILESERVER_CHOICESMADE=0
					if (( $INDEX_FILESERVER_TARGET != $INDEX_FILESERVER_CURRENT )); then
						INSTALL_FILESERVER_CHOICESMADE=1

						#Inform user
						WHIP_TITLE="Fileserver Choice Change"
						WHIP_QUESTION="$OPTION has been selected:\n- Your choice will be applied when 'Install Go >> Start installation' is selected.\n- $toberemoved_text installations will be automatically uninstalled."
						whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 11 75

					fi
				;;

			  "Log System")

					WHIP_TITLE='Logging System Choices'
					OPTION=$(whiptail --title "$WHIP_TITLE" --menu "> None\nSelecting this option will uninstall DietPi-Ramlog, Logrotate, Rsyslog.\n\n> DietPi-Ramlog #1 (Max performance)\nMounts /var/log to RAM, reducing filesystem IO. Logfiles are cleared every hour. Does NOT save logfiles to disk.\n\n> DietPi-Ramlog #2\nSame as #1, with the added feature of saving logfile contents to disk ($HOME/logfile_storage/*), before being cleared.\n\n> Full (Reduces performance)\nMounts /var/log to DISK, reduces SDcard lifespan. Full logging system with Logrotate and Rsyslog." --cancel-button "Back" --default-item "$index_logging_text" 25 75 4 \
					"None" " Not required / manual setup." \
					"DietPi-Ramlog #1" " Hourly clear (recommended)." \
					"DietPi-Ramlog #2" " Hourly save, then clear." \
					"Full" " Logrotate and Rsyslog." 3>&1 1>&2 2>&3)

					#Assign target index
					if [ "$OPTION" = "None" ]; then
						INDEX_LOGGING_TARGET=0
						toberemoved_text="DietPi-Ramlog, Logrotate, Rsyslog"
					elif [ "$OPTION" = "DietPi-Ramlog #1" ]; then
						INDEX_LOGGING_TARGET=-1
						toberemoved_text="Logrotate, Rsyslog"
					elif [ "$OPTION" = "DietPi-Ramlog #2" ]; then
						INDEX_LOGGING_TARGET=-2
						toberemoved_text="Logrotate, Rsyslog"
					elif [ "$OPTION" = "Full" ]; then
						INDEX_LOGGING_TARGET=-3
						toberemoved_text="DietPi-Ramlog"
					#Reset to current
					else
						INDEX_LOGGING_TARGET=$INDEX_LOGGING_CURRENT
					fi

					#Check for changes
					INSTALL_LOGGING_CHOICESMADE=0
					if (( $INDEX_LOGGING_TARGET != $INDEX_LOGGING_CURRENT )); then
						INSTALL_LOGGING_CHOICESMADE=1

						#Inform user
						WHIP_TITLE="Logging System Change"
						WHIP_QUESTION="$OPTION has been selected:\n- Your choice will be applied when 'Install Go >> Start installation' is selected.\n- $toberemoved_text installations will be automatically uninstalled."
						whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 11 75
					fi
				;;

			  "User Data Location")

					WHIP_TITLE='User Data Location'

					# - Vars if we need to move data.
					local move_data_target=$user_data_location_current
					local custom_location=1 #As we are now replacing Auto when the user selects Force DRIVE, we need to know what is considered a custom location.

					#Auto info
					local autostate_text='Select now to use Auto location.'
					if [ "$user_data_location_mode" = "auto" ] &&
						(( $DIETPI_INSTALL_STAGE == 0 )); then

						autostate_text="Active | $user_data_location_description"

					fi

					#Flash info
					local flashdrive_text='Not active. Select to move data.'
					if [ "$user_data_location_current" = "$FP_DIETPI_USERDATA_DIRECTORY" ]; then

						flashdrive_text="Active ($FP_DIETPI_USERDATA_DIRECTORY)."
						custom_location=0

					fi

					#USB info
					local usbdrive_text='Not active. Select to move data.'
					if (( ! $USBDRIVE )); then

						usbdrive_text='Select to setup a USB drive for your user data.'

					elif [ "$user_data_location_current" = "$FP_DIETPI_DEDICATED_USBDRIVE" ]; then

						usbdrive_text="Active ($FP_DIETPI_USERDATA_DIRECTORY > $FP_DIETPI_DEDICATED_USBDRIVE)."
						custom_location=0

					fi

					#Manual info
					local manual_text='Not active. Select to move data.'
					if (( $custom_location )) &&
						[ "$user_data_location_current" = "$user_data_location_mode" ]; then

						manual_text="Active ($FP_DIETPI_USERDATA_DIRECTORY > $user_data_location_mode)."

					fi

					OPTION=$(whiptail --title "$WHIP_TITLE" --menu "Choose where to store your user data. User data includes software such as Owncloud data store, BitTorrent downloads etc\n\nMore information on user data in DietPi:\n - http://dietpi.com/phpbb/viewtopic.php?f=8&t=478&p=2087\n\n> Auto\nIf a dedicated USB drive is setup on this system, DietPi will use that device. If not, Flash Storage will be used.\n\n> Manual\nInput a custom directory that will be used for your user data." --cancel-button "Back" --default-item "$index_fileserver_text" 23 75 4 \
					"Auto" "$autostate_text" \
					"Force Flash Drive" "$flashdrive_text" \
					"Force USB Drive" "$usbdrive_text" \
					"Manual" "$manual_text" 3>&1 1>&2 2>&3)
					CHOICE=$?

					if (( $CHOICE == 0 )); then


						# - Force flash
						if [ "$OPTION" = "Force Flash Drive" ]; then

							move_data_target=$FP_DIETPI_USERDATA_DIRECTORY

						# - Setup dedicated drive
						elif [ "$OPTION" = "Force USB Drive" ]; then

							if (( ! $USBDRIVE )); then

								/DietPi/dietpi/dietpi-drive_manager 2

								#Enable USB drive for this system if sucessful.
								Dedicated_Usb_Drive_Enable

							fi

							if (( $USBDRIVE )); then
								move_data_target=$FP_DIETPI_DEDICATED_USBDRIVE
							fi

						# - Auto
						elif [ "$OPTION" = "Auto" ]; then

							move_data_target='Auto'

						# - Manual filepath entry
						elif [ "$OPTION" = "Manual" ]; then

							local default_item=$user_data_location_mode
							if [ "$default_item" = "auto" ]; then
								default_item=''
							fi

							OPTION=$(whiptail --inputbox "Please input a location. Your user data will be stored inside this location.\n - eg: /mnt/MyDrive/MyData" 11 60 "$default_item" --title "User/Personal Data Directory" --backtitle "$WHIP_BACKTITLE" 3>&1 1>&2 2>&3)
							CHOICE=$?
							if (( $CHOICE == 0 )); then
								move_data_target=$OPTION
							fi

						fi

						# - Move data if the new entry has changed
						if [ "$user_data_location_current" != "$move_data_target" ]; then

							# - If 'auto' was used, grab location
							local target_to_lowercase=$(echo -e "$move_data_target" | tr '[:upper:]' '[:lower:]')
							if [ "$target_to_lowercase" = "auto" ]; then

								move_data_target=$(/DietPi/dietpi/func/dietpi-set_userdata return_auto)

							fi

							# - Ask before we begin
							whiptail --title "User data transfer" --yesno "DietPi will now attempt to transfer your existing user data to the new location:\n\n - From: $user_data_location_current\n - To: $move_data_target\n\nWould you like to begin?" --backtitle "$WHIP_BACKTITLE" --defaultno 14 70
							CHOICE=$?
							if (( $CHOICE == 0 )); then

								# - Move data, setup symlinks
								/DietPi/dietpi/func/dietpi-set_userdata "$user_data_location_current" "$move_data_target"

								if (( $? == 0 )); then

									whiptail --title "User data transfer: Completed" --msgbox "Your user data has been sucessfuly moved:\n\n - From: $user_data_location_current\n - To: $(/DietPi/dietpi/func/dietpi-set_userdata return_source)" 12 70

								else

									whiptail --title "User data transfer: Failed" --msgbox "$(cat /var/log/dietpi-move_userdata.log)\nNo changes have been applied." 12 70

								fi

							fi

						fi

					fi
				;;
			  "Webserver Preference")
				WHIP_TITLE='Webserver Preference'
				OPTION=$(whiptail --title "$WHIP_TITLE" --menu "More Info: http://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=1549#p1549\n\n> Apache2\nFeature-rich and popular. Recommended for beginners and users who are looking to follow Apache2 based guides.\n\n> Nginx\nLightweight alternative to Apache2. Nginx claims faster webserver performance compared to Apache2.\n\n> Lighttpd\nExtremely lightweight and is generally considered to offer the \"best\" webserver performance for SBC's. Recommended for users who expect low webserver traffic." --cancel-button "Back" --default-item "$index_webserver_text" 24 75 3 \
				"Apache2" "Popular webserver." \
				"Nginx" "Lightweight webserver." \
				"Lighttpd" "Extremely lightweight webserver." 3>&1 1>&2 2>&3)

					#Assign target index
					if [ "$OPTION" = "Apache2" ]; then
						INDEX_WEBSERVER_TARGET=0
					elif [ "$OPTION" = "Nginx" ]; then
						INDEX_WEBSERVER_TARGET=-1
					elif [ "$OPTION" = "Lighttpd" ]; then
						INDEX_WEBSERVER_TARGET=-2
					#Reset to current
					else
						INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_CURRENT
					fi

					#Check for changes
					if (( $INDEX_WEBSERVER_TARGET != $INDEX_WEBSERVER_CURRENT )); then

						# - Check for existing and compatible installed stacks before allowing the change
						local incompatible_webserver_preference=0
						local info_currently_installed_webserver='None'

						if (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'apache2'))); then
							INDEX_WEBSERVER_CURRENT=0
							info_currently_installed_webserver='Apache2'
							if (( $INDEX_WEBSERVER_TARGET != 0 )); then
								incompatible_webserver_preference=1
							fi
						elif (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'nginx') )); then
							INDEX_WEBSERVER_CURRENT=-1
							info_currently_installed_webserver='Nginx'
							if (( $INDEX_WEBSERVER_TARGET != -1 )); then
								incompatible_webserver_preference=1
							fi
						elif (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'lighttpd') )); then
							INDEX_WEBSERVER_CURRENT=-2
							info_currently_installed_webserver='Lighttpd'
							if (( $INDEX_WEBSERVER_TARGET != -2 )); then
								incompatible_webserver_preference=1
							fi
						fi

						# - Reset preference selection
						if (( $incompatible_webserver_preference == 1 )); then

							INDEX_WEBSERVER_TARGET=$INDEX_WEBSERVER_CURRENT

							# - inform user
							WHIP_TITLE="Error: Incompatible Webserver Preference"
							WHIP_QUESTION="Unable to change your webserver preference to $OPTION.\n\nThis is due to an existing and incompatible webserver installation on your system ($info_currently_installed_webserver). Please remove all webserver based software (using dietpi-uninstall), before trying again."
							whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 11 75


						# - Apply preference selection
						else

							# - Inform user
							WHIP_TITLE="Webserver Preference Changed"
							WHIP_QUESTION="$OPTION has been selected as your webserver preference.\n\nWhen you select any software for install that requires a webserver, DietPi will automatically install your prefered choice ($OPTION)."
							whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 11 75

							# - NB: INDEX_WEBSERVER_CURRENT=$INDEX_WEBSERVER_TARGET | is applied during installation with func Apply_Webserver_Preference().

						fi



					fi
				;;

			  "DietPi-Config")

					/DietPi/dietpi/dietpi-config

				;;

			  "Help!")

					#Populate help to text file so we can read it back to whiptail, as a scrollbox.
					cat << _EOF_ > /tmp/dietpi-software_help_onlinedoc_url_list
───────────────────────────────────────────────────────────────
Welcome to DietPi:
───────────────────────────────────────────────────────────────
Use PageUp/Down or Arrow Up/Down to scroll this help screen.
Press ESC, or TAB then enter to exit this help screen.

Easy to follow, step by step guides for installing DietPi:
http://dietpi.com/phpbb/viewtopic.php?f=8&t=9

For a list of all installation options and their details:
http://dietpi.com/software

───────────────────────────────────────────────────────────────
List of installed software and their URL links for online docs:
───────────────────────────────────────────────────────────────
_EOF_

					# - Installed software
					for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
					do

						if (( ${aSOFTWARE_INSTALL_STATE[$i]} > 0 )); then

							if [ -n "${aSOFTWARE_ONLINEDOC_URL[$i]}" ]; then

								cat << _EOF_ >> /tmp/dietpi-software_help_onlinedoc_url_list
${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_NAME[$i]}
$FP_ONLINEDOC_URL${aSOFTWARE_ONLINEDOC_URL[$i]}

_EOF_

							fi

						fi

					done

					whiptail --title "DietPi - Help" --backtitle "$WHIP_BACKTITLE" --textbox /tmp/dietpi-software_help_onlinedoc_url_list $(( $(tput lines) - 3 )) $(( $(tput cols) - 3 )) --scrolltext

				;;

			  Install)

					Menu_StartInstall

				;;

			esac

		#Exit/Abort Setup
		else

			Menu_Exit

		fi

	}

	Menu_Exit(){

		#1st run install
		if (( $DIETPI_INSTALL_STAGE == 0 )); then
			WHIP_TITLE='Exit Setup?'
			WHIP_QUESTION=' DietPi has not fully been installed.\n This must be completed prior to using DietPi by selecting:\n - Go Start Install. \n \n Would you like to exit and abort the installation?'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" --yes-button "Ok" --no-button "Back" --defaultno 13 65
			CHOICE=$?
			if (( $CHOICE == 0 )); then
				Banner_Aborted
				#Exit script NOW
				Exit_Destroy
			else
				#Return to Main Menu
				TARGETMENUID=0
			fi
		#Standard exit
		elif (( $DIETPI_INSTALL_STAGE == 1 )); then
			WHIP_TITLE='Exit DietPi-Software?'
			WHIP_QUESTION='Do you wish to exit DietPi-Software?\n\nAll changes to software selections will be cleared.'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" --yes-button "Ok" --no-button "Back" --defaultno 11 65
			CHOICE=$?
			if (( $CHOICE == 0 )); then
				Banner_Aborted
				#Exit script NOW
				Exit_Destroy
			else
				#Return to Main Menu
				TARGETMENUID=0
			fi
		fi
	}

	Menu_ConfirmInstall(){

		#Obtain list of pending software installation:
		local string_output=''
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				string_output+="\n - ${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"

			fi

		done

		#Confirm Software install
		WHIP_TITLE='DietPi - Start Installation?'
		WHIP_QUESTION="DietPi is now ready to install your software choices: $string_output\n\nSoftware details, usernames, passwords etc:\n - http://dietpi.com/software\n\nWould you like to begin?"
		whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --yes-button "Ok" --no-button "Back" --defaultno --backtitle "$WHIP_BACKTITLE" 20 70
		CHOICE=$?
		if (( $CHOICE == 0 )); then

			#exit menu system
			TARGETMENUID=-1

			#Enable installation start flag
			GOSTARTINSTALL=1

		else

			#Return to Main Menu
			TARGETMENUID=0

		fi

	}

	Menu_StartInstall(){

		#Check if the user has made changes to their software selections.
		if (( $INSTALL_DIETPI_CHOICESMADE ||
			$INSTALL_LINUX_CHOICESMADE ||
			$INSTALL_SSHSERVER_CHOICESMADE ||
			$INSTALL_FILESERVER_CHOICESMADE ||
			$INSTALL_LOGGING_CHOICESMADE )); then

			# Confirm install with user
			Menu_ConfirmInstall

		else

			#1st run install
			if (( $DIETPI_INSTALL_STAGE == 0 )); then

				WHIP_TITLE='No Software Selected. Continue?'
				WHIP_QUESTION='DietPi was unable to detect any software selections for install. Do you wish to continue?\n\nBy selecting Ok: \n- DietPi optimized software will NOT be installed.\nYou can use dietpi-software at a later date if you change your mind. \n\n- You want a Minimal Raspbian/Debian Server Install.\nDietPi is a minimal image. A great OS base to use with your projects.'
				whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" --yes-button "Ok" --no-button "Back" --defaultno 16 75
				CHOICE=$?
				if (( $CHOICE == 0 )); then

					#exit menu system
					TARGETMENUID=-1

					#Enable installation start flag
					GOSTARTINSTALL=1

				else

					#Return to Main Menu
					TARGETMENUID=0

				fi

			#Not 1st run
			elif (( $DIETPI_INSTALL_STAGE == 1 )); then

				WHIP_TITLE='No Changes to Software Selection'
				whiptail --title "$WHIP_TITLE" --msgbox "No changes have been detected. Unable to start installation." 8 65

			fi

		fi
	}

	#TARGETMENUID=1
	Menu_Dietpi_Software(){

		#-----------------------------------------------------------------------------
		#Generate Whiptail menu and store results into our software arrays
		Menu_CreateSoftwareList 0

		#Return to Main Menu
		TARGETMENUID=0

		#-----------------------------------------------------------------------------
		#Install Info/Warnings

		#Gogs: Requires OpenSSH for ssh-keygen binary: https://github.com/Fourdee/DietPi/issues/442
		if (( ${aSOFTWARE_INSTALL_STATE[49]} == 1 && $INDEX_SSHSERVER_TARGET != -2 )); then

			WHIP_TITLE='Gogs: Requires OpenSSH'
			WHIP_QUESTION="Gogs requires OpenSSH server to function.\nIf you continue, OpenSSH will be selected for install on your system. OpenSSH will also replace Dropbear (if currently installed).\n\nWould you like to continue with the Gogs installation?"
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --defaultno --backtitle "$WHIP_BACKTITLE" 13 65
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				# - Use SSH target index to ensure Dropbear gets removed if installed.
				INDEX_SSHSERVER_TARGET=-2

			else

				aSOFTWARE_INSTALL_STATE[49]=0

			fi

		fi

		#Webserver stacks, please let DietPi install them for you...
		for ((i=74; i<=82; i++))
		do

			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				WHIP_TITLE='Info: Webserver Stack'
				WHIP_QUESTION="DietPi will automatically install a webserver stack (based on your Webserver Preference) when any software that requires a webserver is selected for installation (eg: Owncloud, PiHole etc).\n\nIt is highly recommended that you allow DietPi to do this for you, ensuring compatibility and stability across DietPi installed programs.\n\nPlease only select a webserver stack if you specifically need it, and, no other webserver stack is installed.\n\nTLDR: You do NOT need to select a webserver stack for installation with DietPi. Its all automatic."
				whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 19 70

				break

			fi

		done

		#phpmyadmin + Lighttpd | broken apt-get installation. User must have a fully installed LLM* stack before phpmyadmin can be selected:
		#https://github.com/Fourdee/DietPi/issues/316#issuecomment-219474664
		if (( ${aSOFTWARE_INSTALL_STATE[90]} == 1 &&
			$INDEX_WEBSERVER_TARGET == -2 &&
			( ${aSOFTWARE_INSTALL_STATE[80]} < 2 && ${aSOFTWARE_INSTALL_STATE[82]} < 2 ) )); then

			WHIP_TITLE='PhpMyAdmin'
			WHIP_QUESTION="Due to a apt-get installation issue with PhpMyAdmin, you must have a fully installed Lighttpd + Mysql/MaridaDB webserver stack, before PhpMyAdmin can be selected for install.\n\nYour selection for PhpMyAdmin has been removed."
			whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 13 70

			aSOFTWARE_INSTALL_STATE[90]=0

		fi

		#DietPiCam - warn user of locking out camera: https://github.com/Fourdee/DietPi/issues/249
		if (( ${aSOFTWARE_INSTALL_STATE[59]} == 1 )); then

			WHIP_TITLE='DietPi Cam - Camera'
			WHIP_QUESTION="DietPi Cam will automatically start and activate the camera during boot. This will prevent other programs (eg: raspistill) from using the camera.\n\nYou can free up the camera by selecting \"Stop Camera\" from the web interface:\nhttp://myip/dietpicam"
			whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 15 70

		fi

		#EmonHUB/EmonPi
		if (( ${aSOFTWARE_INSTALL_STATE[99]} == 1 )); then

			# - Enter API KEY
			# - Grab key from dietpi.txt
			USER_EMONHUB_APIKEY_CURRENT=$(cat /DietPi/dietpi.txt | grep -m1 '^dietpi_emonhub_apikey=' | sed 's/.*=//')

			while (( $USER_EMONHUB_APIKEY_COMPLETED == 0 )); do

				WHIP_TITLE='EmonPi/Hub - API KEY'
				WHIP_QUESTION="Please enter your \"Write API KEY\":\n - Goto http://emoncms.org and register an account and login.\n - Select \"Setup\" from the top right of screen, then select \"My Account\"\n - Enter the \"Write API Key\" into the box below."
				OPTION=$(whiptail --inputbox "$WHIP_QUESTION" 14 75 "$USER_EMONHUB_APIKEY_CURRENT" --title "$WHIP_TITLE" --backtitle "$WHIP_BACKTITLE" 3>&1 1>&2 2>&3)
				CHOICE=$?
				if (( $CHOICE == 0 )); then

					USER_EMONHUB_APIKEY_CURRENT=$OPTION

					WHIP_TITLE='EmonPi/Hub - API KEY'
					WHIP_QUESTION="The following \"Write API KEY\" will be applied during installation:\n$USER_EMONHUB_APIKEY_CURRENT\n\nIs this key correct?"
					whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 11 70
					CHOICE=$?
					if (( $CHOICE == 0 )); then

						# - update dietpi.txt so the value will be applied during installation.
						sed -i "/^dietpi_emonhub_apikey=/c\dietpi_emonhub_apikey=$USER_EMONHUB_APIKEY_CURRENT" /DietPi/dietpi.txt

						USER_EMONHUB_APIKEY_COMPLETED=1

					fi

				fi

			done

		fi

		#Pi-hole.
		if (( ${aSOFTWARE_INSTALL_STATE[93]} == 1 )); then

			# - Modified fork disclaimer
			whiptail --title "PiHole" --msgbox "Please note, the DietPi installation of PiHole is a modified fork. It is not endorsed or supported by PiHole.\n\nThe main changes of our version:\n - Works with Apache2, Nginx and Lighttpd\n - Smaller installation (we dont use git packages)\n - Allows for additional uses of the webserver (eg: Owncloud)\n - Updates are rolled out through DietPi-Update\n - Web dash is http://ip/pihole\n - Blocked advert pages will provide a message, instead of blank\n - May be upto 2-4weeks behind PiHole version\n\nTLDR: Contact DietPi for support if you experience issues with our modified Pihole installation" --backtitle "$WHIP_BACKTITLE" 20 70

			# - prompt for static ip.
			WHIP_TITLE=' Pi-hole - Setup Static IP Now?'
			WHIP_QUESTION='A static IP address is essential for Pi-hole installations. DietPi-Config can be used to quickly setup your static IP address.\n\nIf you have already setup your static IP, please ignore this message.\n\nWould you like to setup your static IP address now?'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --defaultno --backtitle "$WHIP_BACKTITLE" 15 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				WHIP_TITLE=' Pi-hole - Setup Static IP'
				WHIP_QUESTION='DietPi-Config will now be launched. Simply select your Ethernet or Wifi connection from the menu to access the IP address settings.\n\nThe "copy current address to STATIC" menu option can be used to quickly setup your static IP. Please ensure you change the mode "DHCP" to "STATIC".\n\nWhen you are done, select "Apply, Save Changes", then exit DietPi-Config to resume setup.'
				whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 15 70

				#Launch DietPi-config networking menu
				/DietPi/dietpi/dietpi-config 8 1

			fi
		fi

		#Wifi Hotspot Criteria
		if (( ${aSOFTWARE_INSTALL_STATE[60]} == 1 )) ||
			(( ${aSOFTWARE_INSTALL_STATE[61]} == 1 )); then

			#Enable wifi modules
			/DietPi/dietpi/func/dietpi-set_hardware wifi enable

			local check_criteria=1
			while (( $check_criteria == 1 )); do

				local criteria_passed=1

				WHIP_TITLE="WiFi Hotspot Criteria"
				WHIP_QUESTION="The following criteria must be met for this installation to succeed:"

				local ethernet_active_state=$(ip r | grep -ci -m1 "eth$(sed -n 1p /DietPi/dietpi/.network)")
				if (( $ethernet_active_state == 1 )); then

					WHIP_QUESTION+="\n\n - Ethernet online: PASSED"

				else

					criteria_passed=0
					WHIP_QUESTION+="\n\n - Ethernet online: FAILED.\nUse dietpi-config to connect and configure ethernet."

				fi

				if [ -d /sys/class/net/wlan$(sed -n 2p /DietPi/dietpi/.network) ]; then

					WHIP_QUESTION+="\n\n - Wifi adapter detected: PASSED"

				else

					criteria_passed=0
					WHIP_QUESTION+="\n\n - Wifi adapter detected: FAILED.\nPlease connect a WiFi adapter and try again."

				fi

				#Passed
				if (( $criteria_passed == 1 )); then

					WHIP_QUESTION+="\n\nPASSED: Criteria met. Good to go."
					whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 14 75
					check_criteria=0

				#Failed, retry?
				else

					WHIP_QUESTION+="\n\nFAILED: Criteria not met. Would you like to check again?"
					whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --yes-button "Ok" --no-button "Back" --defaultno --backtitle "$WHIP_BACKTITLE" 16 75
					CHOICE=$?
					if (( $CHOICE == 0 )); then

						echo "retry" &> /dev/null

					else

						# - Disable user selection
						check_criteria=0
						aSOFTWARE_INSTALL_STATE[60]=0
						aSOFTWARE_INSTALL_STATE[61]=0
						whiptail --title "WiFi Hotspot Failed" --msgbox "WiFi Hotspot criteria was not met. Your selection has been removed." --backtitle "$WHIP_BACKTITLE" 10 65

					fi

				fi

			done

		fi

		#Weaved
		if (( ${aSOFTWARE_INSTALL_STATE[68]} == 1 )); then

			WHIP_TITLE=' Weaved - 1st run setup'
			WHIP_QUESTION='Weaved requires you to create an online account, and, link it this device.\n\nOnce DietPi has completed your software installations, and rebooted, please follow the First Run tutorial here:\nhttp://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=188#p188'
			whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 14 70

		fi

		#LetsEncrypt
		if (( ${aSOFTWARE_INSTALL_STATE[92]} == 1 )); then

			WHIP_TITLE='Lets Encrypt Info'
			WHIP_QUESTION='Currently, the DietPi installation of CertBot supports Apache2 & Lighttpd only.\n\nOnce the installation has finished, you can setup your free SSL cert with:\n - DietPi-LetsEncrypt\n\nThis is a easy to use frontend for CertBot and allows intergration into DietPi systems.\n\nMore information:\n - http://dietpi.com/phpbb/viewtopic.php?f=8&t=5&p=1061#p1062'
			whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 18 70

		fi

		#-----------------------------------------------------------------------------
		#dietpi-config can be used to install/configure the following software. Ask user.
		#NoIp -
		if (( ${aSOFTWARE_INSTALL_STATE[67]} == 1 )); then

			WHIP_TITLE='NoIp - Setup Now?'
			WHIP_QUESTION='NoIp can be setup and configured by using DietPi-Config. Would you like to go there now? \n\n- Once completed, exit DietPi-Config to resume setup. \n\n- More information:\nhttp://dietpi.com/phpbb/viewtopic.php?f=8&t=5&start=10#p58'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --yes-button "Ok" --no-button "Cancel" --defaultno --backtitle "$WHIP_BACKTITLE" 15 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				#Write installed states to temp
				Write_InstallFileList temp

				#Launch DietPi-config
				/DietPi/dietpi/dietpi-config 16 1

				#Read installed states from temp
				Read_InstallFileList temp

			fi

		fi

		#-----------------------------------------------------------------------------
		#Installations that might require File server to access data.
		#Lets inform the user of File Server option
		# local inform_user_fileserver=0
		# if (( $INDEX_FILESERVER_TARGET == 0 )); then
			# if (( $TRANSMISSION == 1 )); then
				# inform_user_fileserver=1
			# elif (( $DELUGE == 1 )); then
				# inform_user_fileserver=1
			# elif (( $MINIDLNA == 1 )); then
				# inform_user_fileserver=1
			# elif (( $HIFI == 1 )); then
				# inform_user_fileserver=1
			# elif (( $SQUEEZEBOXSERVER == 1 )); then
				# inform_user_fileserver=1
			# elif (( $SUBSONIC5 == 1 || $SUBSONIC6 == 1 )); then
				# inform_user_fileserver=1
			# elif (( $AMPACHE == 1 )); then
				# inform_user_fileserver=1
			# elif (( $EMBYSERVER == 1 )); then
				# inform_user_fileserver=1
			# elif (( $PLEXMEDIASERVER == 1 )); then
				# inform_user_fileserver=1
			# fi

			# if (( $inform_user_fileserver == 1 )); then
				# WHIP_TITLE='File Server Recommended'
				# WHIP_QUESTION="Your installation choices may benefit from a File Server. This would allow you to access and transfer files on this DietPi system.\n\nWhen you return to the main menu, select:\n- File Server\n\nThis will allow you to see the complete list of available fileserver choices."
				# whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 16 70
			# fi
		# fi

		#-----------------------------------------------------------------------------
		#Boot Choices
		if (( ${aSOFTWARE_INSTALL_STATE[23]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[24]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[25]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[26]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[31]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[51]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[108]} == 1 ||
			${aSOFTWARE_INSTALL_STATE[112]} == 1 )); then

			# Set Boot Order
			WHIP_TITLE=' DietPi - Boot Options'
			WHIP_QUESTION='Would you like to configure the auto boot options for DietPi?\n\nThis will allow you to choose which program loads automatically after booting eg:\n - Console\n - Desktop\n - Kodi'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --defaultno --backtitle "$WHIP_BACKTITLE" 14 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				/DietPi/dietpi/dietpi-autostart

			fi

		fi

	}

	#TARGETMENUID=2
	Menu_Linux_Software(){

		#Inform User that DietPi software will automatically install additional linux software when required.
		if (( ! $USER_LINUX_AUTOINSTALL_PROMPT_DISPLAYED )); then

			WHIP_TITLE='Additional Linux Software'
			WHIP_QUESTION='DietPi will automatically install additional Linux software on the next screen, when required (eg: Desktop LXDE will install ALSA + Xserver).\n\nThis means you only need to select the software you actually require.'
			whiptail --title "$WHIP_TITLE" --msgbox "$WHIP_QUESTION" --backtitle "$WHIP_BACKTITLE" 12 70

			USER_LINUX_AUTOINSTALL_PROMPT_DISPLAYED=1

		fi

		#-----------------------------------------------------------------------------
		#Generate Whiptail menu and store results into our software arrays
		Menu_CreateSoftwareList 1

		#Return to Main Menu
		TARGETMENUID=0

		#-----------------------------------------------------------------------------
		#dietpi-config can be used to install/configure the following software. Ask user.
		#CurlFTPfs -
		if (( ${aSOFTWARE_INSTALL_STATE[2]} == 1 )); then

			WHIP_TITLE='FTP Client - Setup Now?'
			WHIP_QUESTION='FTP Client as a filesystem mount (CurlFTPfs) can be setup and configured by using DietPi-Config. Would you like to go there now? \n\n- Once completed, exit DietPi-Config to resume setup.'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --yes-button "Ok" --no-button "Cancel" --defaultno --backtitle "$WHIP_BACKTITLE" 13 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				#Write installed states to temp
				Write_InstallFileList temp

				#Launch DietPi-config
				/DietPi/dietpi/dietpi-config 16 1

				#Read installed states from temp
				Read_InstallFileList temp

			fi

		fi

		#SMBCLIENT -
		if (( ${aSOFTWARE_INSTALL_STATE[1]} == 1 )); then

			WHIP_TITLE='Samba Client  - Setup Now?'
			WHIP_QUESTION='Samba Client can be setup and configured by using DietPi-Config. Would you like to go there now? \n\n- Once completed, exit DietPi-Config to resume setup.'
			whiptail --title "$WHIP_TITLE" --yesno "$WHIP_QUESTION" --yes-button "Ok" --no-button "Cancel" --defaultno --backtitle "$WHIP_BACKTITLE" 13 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then

				#Write installed states to temp
				Write_InstallFileList temp

				#Launch DietPi-config
				/DietPi/dietpi/dietpi-config 16 1

				#Read installed states from temp
				Read_InstallFileList temp

			fi

		fi

		#-----------------------------------------------------------------------------

	}

	#TARGETMENUID=3
	Menu_Uninstall_Software(){

		#Return to main menu
		TARGETMENUID=0

		#Array which will hold all software indexs to be removed.
		local asoftware_for_uninstall=()
		local software_installed_count=0

		#Obtain list of installed software
		for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		do

			if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 2 &&
				${aSOFTWARE_TYPE[$i]} >= -1 )); then

				whiptail_list_array+=("$i" "${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}" "off")
				((software_installed_count++))

			fi

		done

		# - Hide specific software (eg: stacks) in for loop ?

		if (( $software_installed_count == 0 )); then

			whiptail --title "Uninstall Software" --msgbox "No software is currently installed, or, available for removal." --backtitle "$WHIP_BACKTITLE" 9 60

		#Run menu
		else

			whiptail --title "Uninstall Software" --checklist --separate-output "Use the spacebar to select the software you would like to remove." --cancel-button "Cancel" --backtitle "$WHIP_BACKTITLE" 18 75 10 "${whiptail_list_array[@]}" 2>/tmp/dietpi-software_uninstall_results

			while read choice
			do
				case $choice in
					*)
						#Convert lined list into a 1 line string.
						asoftware_for_uninstall+=("$choice")
					;;
				esac

			done < /tmp/dietpi-software_uninstall_results
			rm /tmp/dietpi-software_uninstall_results &> /dev/null

			unset whiptail_list_array

			#Prompt user with list of their selected software for removal
			if (( ${#asoftware_for_uninstall[@]} > 0 )); then

				# - Create list
				WHIP_QUESTION='The following software will be REMOVED from your system:\n'

				for ((i=0; i<${#asoftware_for_uninstall[@]}; i++))
				do

					for ((j=0; j<$TOTAL_SOFTWARE_INDEXS; j++))
					do

						if (( ${asoftware_for_uninstall[$i]} == $j )); then

							WHIP_QUESTION+=" - ${aSOFTWARE_WHIP_NAME[$j]}: ${aSOFTWARE_WHIP_DESC[$j]}\n"
							break

						fi

					done

				done

				#Ask for confirmation
				whiptail --title "Uninstall Software?" --yesno "$WHIP_QUESTION \nDo you wish to continue?" --yes-button "Ok" --no-button "Cancel" --defaultno --backtitle "$WHIP_TITLE" 20 70
				CHOICE=$?

				#Run uninstall
				if (( $CHOICE == 0 )); then

					# - stop services
					/DietPi/dietpi/dietpi-services stop

					for ((i=0; i<${#asoftware_for_uninstall[@]}; i++))
					do

						Uninstall_Software ${asoftware_for_uninstall[$i]}

					done

					#Finish up and clear non-required packages
					Uninstall_Software_Finalize

					#Save
					Write_InstallFileList

					# - start services
					/DietPi/dietpi/dietpi-services start

					#inform user
					whiptail --title "Uninstall Software" --msgbox "Uninstall completed." --backtitle "$WHIP_BACKTITLE" 9 60

				fi

			fi

		fi

		#delete[] arrays
		unset whiptail_list_array
		unset asoftware_for_uninstall

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Banner Print
	#/////////////////////////////////////////////////////////////////////////////////////

	Banner_Setup(){

		/DietPi/dietpi/dietpi-banner 0
		echo -e "\n Welcome to DietPi-Software \n"

	}

	Banner_Installing(){

		/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Install software"

		echo -e " ${aSOFTWARE_WHIP_NAME[$INSTALLING_INDEX]}: ${aSOFTWARE_WHIP_DESC[$INSTALLING_INDEX]}"
		/DietPi/dietpi/func/dietpi-notify 2 "Please wait...\n"
		/DietPi/dietpi/dietpi-funtime 0

	}

	Banner_Apt_Update(){

		/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Update & upgrade APT"
		sleep 1

	}

	Banner_Reboot(){

		if (( ! $DISABLE_REBOOT )); then

			/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Installation completed"
			echo -e "\n The system will now reboot. \n This completes the DietPi-Software installation.\n"
			/DietPi/dietpi/dietpi-funtime 0
			sleep 3

		else

			/DietPi/dietpi/func/dietpi-notify 0 "DietPi-Software installation completed."

		fi
	}

	Banner_Configs(){

		/DietPi/dietpi/func/dietpi-notify 3 DietPi-Software "Optimize and configure software"
		/DietPi/dietpi/func/dietpi-notify 2 "Applying DietPi optimizations and configurations for $HW_MODEL_DESCRIPTION"
		/DietPi/dietpi/func/dietpi-notify 2 "Please wait...\n"
		/DietPi/dietpi/dietpi-funtime 0

		#List software due for configuration
		# for ((i=0; i<$TOTAL_SOFTWARE_INDEXS; i++))
		# do

			# if (( ${aSOFTWARE_INSTALL_STATE[$i]} == 1 )); then

				# /DietPi/dietpi/func/dietpi-notify 2 "${aSOFTWARE_WHIP_NAME[$i]}: ${aSOFTWARE_WHIP_DESC[$i]}"

			# fi

		# done

	}

	Banner_Aborted(){

		#1st run abort
		if (( $DIETPI_INSTALL_STAGE == 0 )); then

			/DietPi/dietpi/dietpi-banner 0
			echo -e "\n Installation Aborted by User \n Installation must be completed prior to using DietPi \n Please run dietpi-software to restart the installation \n"

		#Standard abort
		else

			/DietPi/dietpi/dietpi-banner 1

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#--------------------------------------------------------------------------------------
	#Init software arrays
	Software_Arrays_Init

	#--------------------------------------------------------------------------------------
	#load .installed file, update vars, if it exists
	Read_InstallFileList

	#--------------------------------------------------------------------------------------
	# - CLi input mode
	if [ -n "$1" ]; then

		# - Disable user inputs and prompts.
		USER_INPUTS=0

		# - Run input mode
		Input_Modes "$@"

	#--------------------------------------------------------------------------------------
	#Standard launch
	else

		#Check if we are setting no user inputs and prompts
		# - Load all automation vars
		if (( $DIETPI_INSTALL_STAGE == 0 )); then

			FirstRun_Automation_Init

			if (( $AUTOINSTALL_ENABLED >= 1 )); then

				# - Disable user inputs and prompts.
				USER_INPUTS=0

			fi

		fi

		#GPL compliance prompt
		if (( $DIETPI_INSTALL_STAGE == 0 && $USER_INPUTS )); then

			whiptail --title "DietPi - GPLv2 License" --msgbox "This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 2 of the License, or any later version.\n\nThis program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see http://www.gnu.org/licenses/" --backtitle "DietPi - GPLv2 Compliance" 18 70

		fi

		Banner_Setup

		#1st run Connection test and DietPi updates
		#NB: Contains EXIT path
		if (( $(cat /DietPi/dietpi/.update_stage) == -1 )); then

			Check_Internet_Connection

			FirstRun_DietPi_Update

		fi

		#Apply 1st run automation and ask questions.
		if (( $DIETPI_INSTALL_STAGE == 0 )); then

			#Activate automation settings from dietpi.txt, if set.
			FirstRun_Automation_Set

			#1st run Questions for user.
			FirstRun_Questions

		fi

		#Enable USBDRIVE flag for this system if its mounted/available.
		Dedicated_Usb_Drive_Enable

		#Start DietPi Menu
		while (( $TARGETMENUID > -1 )); do

			clear

			if (( $TARGETMENUID == 0 )); then

				Menu_Main

			elif (( $TARGETMENUID == 1 )); then

				Menu_Dietpi_Software

			elif (( $TARGETMENUID == 2 )); then

				Menu_Linux_Software

			elif (( $TARGETMENUID == 3 )); then

				Menu_Uninstall_Software

			fi

		done

	fi

	#--------------------------------------------------------------------------------------
	#Start DietPi-Software installs
	if (( $GOSTARTINSTALL )); then

		Check_Internet_Connection

		if (( $INTERNET_CONNECTED == 1 )); then

			#Start installations for software
			Run_Installations

			#Upload DietPi-Survey Data
			/DietPi/dietpi/dietpi-survey &> /dev/null

			#Reboot
			Banner_Reboot

			if (( $DISABLE_REBOOT )); then

				# - Start services
				/DietPi/dietpi/dietpi-services start

			else

				reboot

			fi

		fi

	fi

	#-----------------------------------------------------------------------------------
	Exit_Destroy
	#-----------------------------------------------------------------------------------
}
