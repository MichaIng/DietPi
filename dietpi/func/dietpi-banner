#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Banner Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - filename /DietPi/dietpi/func/dietpi-banner
	# - Checks /DietPi/dietpi/.update_available
	#
	# Usage:
	# - dietpi-banner 0 = top section only
	# - dietpi-banner 1 = top section and credits + clear
	#////////////////////////////////////

	# Import DietPi-Globals --------------------------------------------------------------
	# Do in main menu and on demand
	# Import DietPi-Globals --------------------------------------------------------------

	[[ $1 == [012] ]] && INPUT=$1 || INPUT=0

	#/////////////////////////////////////////////////////////////////////////////////////
	# Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	FP_SAVEFILE='/DietPi/dietpi/.dietpi-banner'
	FP_CUSTOM='/DietPi/dietpi/.dietpi-banner_custom'

	aDESCRIPTION=(

		'Device model'
		'Uptime'
		'CPU temp'
		'FQDN/hostname'
		'NIS domainname'
		'LAN IP'
		'WAN IP'
		'Freespace (RootFS)'
		'Freespace (userdata)'
		'Weather (wttr.in)'
		'Custom banner entry'
		'Display DietPi useful commands?'

	)
	# Set defaults
	aENABLED=(1 0 1 0 0 1 0 0 0 0 0 1)

	aCOLOUR=(

		'\e[0m' #Reset
		'\e[38;5;154m' #DietPi Green | Lines and seperators
		'\e[1m' #bold white | Main descriptions
		'\e[90m' #Grey | Credits
		'\e[91m' #Red | Update notifications

	)

	GREEN_LINE=" ${aCOLOUR[1]}─────────────────────────────────────────────────────${aCOLOUR[0]}"
	GREEN_BULLET=" ${aCOLOUR[1]}-${aCOLOUR[0]}"
	GREEN_SEPERATOR="${aCOLOUR[1]}:${aCOLOUR[0]}"

	. /DietPi/dietpi/.version
	DIETPI_VERSION="$G_DIETPI_VERSION_CORE.$G_DIETPI_VERSION_SUB.$G_DIETPI_VERSION_RC"
	[[ $G_GITBRANCH != 'master' ]] && DIETPI_VERSION+=" ($G_GITBRANCH)"

	# Update available?
	UPDATE_AVAILABLE=0
	UPDATE_AVAILABLE_VERSION='' # -1 = image required, other value = latest version
	Obtain_Update_Available(){

		if [[ -f '/DietPi/dietpi/.update_available' ]]; then

			UPDATE_AVAILABLE=1
			UPDATE_AVAILABLE_VERSION=$(</DietPi/dietpi/.update_available)

		fi

	}

	Load(){	[[ -f $FP_SAVEFILE ]] && . $FP_SAVEFILE; }

	Save(){

		> $FP_SAVEFILE

		for i in ${!aDESCRIPTION[@]}
		do

			echo "aENABLED[$i]=${aENABLED[$i]}" >> $FP_SAVEFILE

		done

		# Safe custom entry description
		echo "aDESCRIPTION[10]='${aDESCRIPTION[10]}'" >> $FP_SAVEFILE

		for i in ${!aCOLOUR[@]}
		do

			echo "aCOLOUR[$i]='${aCOLOUR[$i]}'" >> $FP_SAVEFILE

		done

	}

	Print_Header(){

		# Update Available?
		Obtain_Update_Available
		local text_update_available_date=''
		if (( $UPDATE_AVAILABLE )); then

			if [[ $UPDATE_AVAILABLE_VERSION == '-1' ]]; then

				text_update_available_date="${aCOLOUR[4]}Image available"

			else

				text_update_available_date="${aCOLOUR[4]}Update available"

			fi

		else

			text_update_available_date=$(date +"%R - %a %x")

		fi

		echo -e "$GREEN_LINE
 ${aCOLOUR[2]}DietPi v$DIETPI_VERSION${aCOLOUR[0]} $GREEN_SEPERATOR $text_update_available_date${aCOLOUR[0]}
$GREEN_LINE"

	}

	Print_Credits(){

		echo -e " ${aCOLOUR[3]}DietPi Team     : MichaIng (lead), Daniel Knight (founder)"

		[[ -f /DietPi/dietpi/.prep_info ]] && mawk 'NR==1 {sub(/^0$/,"DietPi Core Team");a=$0} NR==2 {print " Image           : "a" (pre-image: "$0")"}' /DietPi/dietpi/.prep_info

		echo ' Web             : https://DietPi.com | https://twitter.com/dietpi_
 Patreon Legends : PINE64 community
 Donate          : https://DietPi.com/#donate'

		local image_additional_credits=$(sed -n 8p /DietPi/dietpi/.hw_model)
		[[ $image_additional_credits ]] && echo " Device image possible thanks to: $image_additional_credits"

		echo -e " DietPi Hosting  : Powered by https://MyVirtualServer.com${aCOLOUR[0]}\n"

		# Update available?
		if (( $UPDATE_AVAILABLE )); then

			if [[ $UPDATE_AVAILABLE_VERSION = '-1' ]]; then

				echo -e " ${aCOLOUR[4]}Updated DietPi image is available, please download it:${aCOLOUR[0]}\n https://dietpi.com/#download\n"

			else

				echo -e " ${aCOLOUR[2]}dietpi-update${aCOLOUR[0]}   $GREEN_SEPERATOR ${aCOLOUR[4]}Run now to update DietPi (from v$DIETPI_VERSION to v$UPDATE_AVAILABLE_VERSION).${aCOLOUR[0]}\n"

			fi

		fi

	}

	Print_Useful_Commands(){

		echo -e "${aCOLOUR[2]} dietpi-launcher${aCOLOUR[0]} $GREEN_SEPERATOR All the DietPi programs in one place.
 ${aCOLOUR[2]}dietpi-config${aCOLOUR[0]}   $GREEN_SEPERATOR Feature rich configuration tool for your device.
 ${aCOLOUR[2]}dietpi-software${aCOLOUR[0]} $GREEN_SEPERATOR Select optimized software for installation.
 ${aCOLOUR[2]}htop${aCOLOUR[0]}            $GREEN_SEPERATOR Resource monitor.
 ${aCOLOUR[2]}cpu${aCOLOUR[0]}             $GREEN_SEPERATOR Shows CPU information and stats.\n"

	}

	Print_Banner(){

		# - Source DietPi-Globals if CPU temp chosen
		[[ ${aENABLED[2]} != 1 || $G_PROGRAM_NAME ]] || . /DietPi/dietpi/func/dietpi-globals

		# - Re-obtain network details if missing and LAN IP chosen
		[[ ${aENABLED[5]} != 1 || -f /DietPi/dietpi/.network ]] || /DietPi/dietpi/func/obtain_network_details

		printf '\ec' # clear current terminal screen
		Print_Header

		(( ${aENABLED[0]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[0]} $GREEN_SEPERATOR $(mawk 'NR==2 {print $0}' /DietPi/dietpi/.hw_model 2>&1)${aCOLOUR[0]}"				#0: Device model
		(( ${aENABLED[1]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[1]} $GREEN_SEPERATOR $(uptime -p 2>&1)${aCOLOUR[0]}"									#1: Uptime
		(( ${aENABLED[2]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[2]} $GREEN_SEPERATOR $(print_full_info=1 G_OBTAIN_CPU_TEMP 2>&1)${aCOLOUR[0]}"						#2: CPU temp
		(( ${aENABLED[3]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[3]} $GREEN_SEPERATOR $(hostname -f 2>&1)${aCOLOUR[0]}"									#3: Hostname
		(( ${aENABLED[4]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[4]} $GREEN_SEPERATOR $(hostname -y 2>&1)${aCOLOUR[0]}"									#4: Domain name
		(( ${aENABLED[5]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[5]} $GREEN_SEPERATOR $(mawk 'NR==3 {dev=$0} NR==4 {print $0" ("dev")"}' /DietPi/dietpi/.network 2>&1)${aCOLOUR[0]}"	#5: LAN IP (adapter)
		(( ${aENABLED[6]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[6]} $GREEN_SEPERATOR $(curl -sLm 2 https://dietpi.com/myip.php 2>&1)${aCOLOUR[0]}"					#6: WAN IP # Move this to /DietPi/dietpi/.network?
		(( ${aENABLED[7]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[7]} $GREEN_SEPERATOR $(df -h --output=avail / | mawk 'NR==2 {print $1}' 2>&1)${aCOLOUR[0]}"				#7: Freespace (RootFS)
		(( ${aENABLED[8]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[8]} $GREEN_SEPERATOR $(df -h --output=avail /mnt/dietpi_userdata | mawk 'NR==2 {print $1}' 2>&1)${aCOLOUR[0]}"		#8: Freespace (DietPi userdata)
		(( ${aENABLED[9]} == 1 )) && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[9]} $GREEN_SEPERATOR $(curl -sLm 2 https://wttr.in/?format=4 2>&1)${aCOLOUR[0]}"						#9: Weather
		(( ${aENABLED[10]} == 1 )) && [[ -x $FP_CUSTOM ]] && echo -e "$GREEN_BULLET ${aCOLOUR[2]}${aDESCRIPTION[10]} $GREEN_SEPERATOR $(bash $FP_CUSTOM 2>&1)${aCOLOUR[0]}"						#10: Custom
		echo -e "$GREEN_LINE\n"

		Print_Credits
		(( ${aENABLED[11]} == 1 )) && Print_Useful_Commands

	}

	Menu_Main(){

		. /DietPi/dietpi/func/dietpi-globals
		G_PROGRAM_NAME='DietPi-Banner'
		G_INIT

		G_WHIP_CHECKLIST_ARRAY=()

		for i in ${!aDESCRIPTION[@]}
		do

			local state='off'
			(( ${aENABLED[$i]=0} == 1 )) && state='on'
			G_WHIP_CHECKLIST_ARRAY+=($i "${aDESCRIPTION[$i]}" $state)

		done

		if G_WHIP_CHECKLIST "Please select options to enable in $G_PROGRAM_NAME display:"; then

			for i in ${!aDESCRIPTION[@]}
			do

				aENABLED[$i]=0

			done

			for i in ${G_WHIP_RETURNED_VALUE[@]}
			do

				aENABLED[$i]=1
				# Custom entry
				if (( $i == 10 )); then

					[[ -f $FP_CUSTOM ]] && G_WHIP_DEFAULT_ITEM=$(<$FP_CUSTOM) || G_WHIP_DEFAULT_ITEM="echo 'Hello World!'"
					if G_WHIP_INPUTBOX 'You have chosen to show a custom entry in the banner.
Please enter/verify the desired command here.\n
NB: It is executed as bash script, so it needs to be in bash compatible syntax.
    For complex or non-bash scripts keep it separate and add its execution command here.'; then

						echo "$G_WHIP_RETURNED_VALUE" > $FP_CUSTOM
						chmod +x $FP_CUSTOM

						G_WHIP_DEFAULT_ITEM=${aDESCRIPTION[10]}
						G_WHIP_INPUTBOX 'Please enter a meaningful name/description to be shown in front of your custom command output:' && aDESCRIPTION[10]=$G_WHIP_RETURNED_VALUE

					fi

					# Disable custom entry if file was not created, e.g. cancelled by user
					[[ -f $FP_CUSTOM ]] || aENABLED[10]=0

				fi

			done

			Save

		fi

	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#-----------------------------------------------------------------------------------
	Load
	#-----------------------------------------------------------------------------------
	if (( $INPUT == 0 )); then

		Print_Header

	elif (( $INPUT == 1 )); then

		Print_Banner

	elif (( $INPUT == 2 )); then

		Menu_Main
		Print_Banner

	fi

	#-----------------------------------------------------------------------------------
	exit 0
	#-----------------------------------------------------------------------------------
}
