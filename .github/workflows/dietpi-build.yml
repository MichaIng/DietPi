name: DietPi-Build
on:
  workflow_dispatch:
    inputs:
      buildargs:
        description: 'DietPi-Build arguments'     
        required: true
  push:
jobs:
  build:
    # https://github.com/actions/virtual-environments
    runs-on: ubuntu-latest
    steps:
    - name: Generate upload script
      run: |
        umask 077
        mkdir ~/.ssh
        umask 377
        echo '${{ secrets.KNOWN_HOSTS }}' > ~/.ssh/known_hosts
        echo '${{ secrets.SSH_KEY }}' > ~/.ssh/id_ed25519
        echo -e '#!/bin/dash\nexec curl -T "${1:-EMPTY}" --key ~/.ssh/id_ed25519 '\''sftp://github@ssh.dietpi.com/'\' > upload.sh
        chmod +x upload.sh
        umask 022
    - name: Run DietPi-Build
      run: bash -c "$(curl -sSf "https://raw.githubusercontent.com/MichaIng/DietPi/${GITHUB_REF#refs/heads/}/.build/images/dietpi-build")" 'DietPi-Build' ${{ github.event.inputs.buildargs }}
