#!/bin/bash
{
# Import DietPi-Globals ---------------------------------------------------------------
. /boot/dietpi/func/dietpi-globals
readonly G_PROGRAM_NAME='dietpi-bookworm-upgrade'
(( $G_DISTRO == 6 )) || { G_DIETPI-NOTIFY 1 'You must run a Debian Bullseye system to run this script!'; exit 1; }
G_CHECK_ROOT_USER
G_CHECK_ROOTFS_RW
G_INIT
# Import DietPi-Globals ---------------------------------------------------------------

G_PROMPT_BACKUP

/boot/dietpi/dietpi-update 1

G_DIETPI-NOTIFY 2 'Updating package lists'
G_EXEC sed -i 's/bullseye/bookworm/g' /etc/apt/sources.list
[[ $(find /etc/apt/sources.list/*.list 2> /dev/null) ]] && G_EXEC sed -i 's/bullseye/bookworm/g' /etc/apt/sources.list.d/*.list
[[ -f '/etc/apt/sources.list.d/dietpi-mympd.list' ]] && G_EXEC sed -i 's/Debian_11/Debian_Testing/' /etc/apt/sources.list.d/dietpi-mympd.list

G_DIETPI-NOTIFY 2 'Reverting some package lists which have no Bookworm suite'
[[ -f '/etc/apt/sources.list.d/raspi.list' ]] && G_EXEC sed -i 's/bookworm/bullseye/' /etc/apt/sources.list.d/raspi.list
[[ -f '/etc/apt/sources.list.d/dietpi-mosquitto.list' ]] && G_EXEC sed -i 's/bookworm/bullseye/' /etc/apt/sources.list.d/dietpi-mosquitto.list
[[ -f '/etc/apt/sources.list.d/influxdb.list' ]] && G_EXEC sed -i 's/bookworm/bullseye/' /etc/apt/sources.list.d/influxdb.list
[[ -f '/etc/apt/sources.list.d/docker.list' ]] && G_EXEC sed -i 's/bookworm/bullseye/' /etc/apt/sources.list.d/docker.list

/boot/dietpi/dietpi-services stop
G_AGUP
G_AGUG
G_AGDUG

/boot/dietpi/func/dietpi-obtain_hw_model
. /boot/dietpi/func/dietpi-globals

G_DIETPI-NOTIFY 0 'Congratulations, you are now on Bookworm:'
cat /etc/os-release

G_DIETPI-NOTIFY 2 'Running post upgrade migrations'
/boot/dietpi/dietpi-services stop
G_CONFIG_INJECT '\[?ssh.dietpi.com(]:29248)?[[:blank:]]' '[ssh.dietpi.com]:29248 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJdEPlagpQ+RVHNOX3jkG1Bya7Oza1dAke8h8NszVW84' /root/.ssh/known_hosts
command -v a2dismod > /dev/null && G_EXEC a2dismod php7.4
eval "$(declare -f G_AGP | sed 's/autopurge/purge/')" # We do not want G_AGP to purge the old kernel package on x86_64!
G_AGP '*php7.4*'
G_EXEC rm -Rf /etc/php/7.4 /usr/local/lib/python3.9 /usr/local/bin/pip3*
dpkg-query -s unbound &> /dev/null && G_AGI dns-root-data
/boot/dietpi/dietpi-software reinstall 38 40 47 48 84 85 89 93 114 118 125 130 134 136 139 143 153 155 157 180

cat << '_EOF_' > /etc/bashrc.d/zz-dietpi-autopurge.bash
{
G_DIETPI-NOTIFY 2 'Autoremoving leftover packages from Bookworm upgrade...'
G_AGA
G_EXEC rm /etc/bashrc.d/zz-dietpi-autopurge.bash
}
_EOF_

G_WHIP_YESNO 'All finished!\n\nWe highly recommend to reboot, shall we reboot now?' && reboot
}
